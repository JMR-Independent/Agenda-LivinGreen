<!DOCTYPE html>
<html lang="es">
<!--
    RIZE PROFESSIONAL CLEANING - PWA
    ================================
    ðŸ”’ SECURITY FIXED: API keys moved to secure backend
    
    TO RUN SECURELY:
    1. npm install
    2. Copy .env.example to .env and add your API keys  
    3. npm start
    4. Open http://localhost:3000
    
    All functionality preserved - now with enterprise security!
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LivinGreen - Agendamiento Inteligente</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="LivinGreen">
    <meta name="description" content="LivinGreen - Plataforma de agendamiento inteligente para gestionar citas y clientes">
    <meta name="theme-color" content="#10a37f">
    <meta name="background-color" content="#ffffff">
    
    <!-- iOS Specific Meta Tags for App-like Behavior -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LivinGreen">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Apple Touch Icons -->
    <!-- iOS App Icon (logo mÃ¡s grande, sin bordes redondeados) -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

    <!-- Favicons con bordes redondeados para pestaÃ±as de navegador -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon-64x64.png">
    
    <!-- PWA Manifest -->
    <script>
        // Create manifest dynamically to ensure it works
        const currentUrl = window.location.href;
        const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);

        const manifest = {
            "name": "LivinGreen - Agendamiento",
            "short_name": "LivinGreen",
            "description": "Plataforma de agendamiento inteligente LivinGreen para gestionar citas y clientes",
            "start_url": baseUrl,
            "display": "standalone",
            "orientation": "portrait-primary",
            "theme_color": "#10a37f",
            "background_color": "#ffffff",
            "scope": baseUrl,
            "icons": [
                {
                    "src": "icon-192x192.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "icon-512x512.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "icon-192x192.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "maskable"
                },
                {
                    "src": "icon-512x512.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "maskable"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>
    <style>
        /* ================================
           MODULAR CSS ORGANIZATION
           ================================ */

        /* === THEME VARIABLES === */
        :root {
            /* Light theme colors */
            --bg-primary: #f7f7f8;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9fafb;
            --bg-hover: #f0fdf4;
            --bg-border: #e5e5e5;
            --bg-input: #ffffff;
            --bg-modal: #ffffff;
            --bg-sidebar: #171717;
            --bg-sidebar-item: #2d2d2d;
            --bg-sidebar-active: #343541;
            
            /* Text colors */
            --text-primary: #2d333a;
            --text-secondary: #666666;
            --text-tertiary: #374151;
            --text-sidebar: #ffffff;
            --text-muted: #6b7280;
            
            /* Border colors */
            --border-color: #e5e5e5;
            --border-input: #d1d5db;
            --border-focus: #10a37f;
            --border-sidebar: #2d2d2d;
            
            /* Brand colors */
            --brand-primary: #10a37f;
            --brand-secondary: #2563eb;
            --brand-hover: #0d9169;
            --brand-light: rgba(16, 163, 127, 0.1);
            
            /* Status colors */
            --success: #16a34a;
            --error: #dc2626;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            /* Shadow colors */
            --shadow-light: rgba(0,0,0,0.1);
            --shadow-medium: rgba(0,0,0,0.15);
            --shadow-heavy: rgba(0,0,0,0.25);
            
            /* Additional colors for consistency */
            --card-bg: #ffffff;
            --modal-bg: #ffffff;
            --button-danger: #dc2626;
            --button-purple: #7c3aed;
            --text-upload: #374151;
            --text-upload-light: #6b7280;
            --text-close-btn: #666;
            --gas-price-bg: #ffffff;
            --gas-price-text: #2d333a;
            --gas-price-value: #10a37f;
            --gas-price-unit: #dc2626;
            --gas-price-status: #666;
        }

        /* Dark theme - Professional SaaS Design */
        [data-theme="dark"] {
            /* Dark theme colors - Professional dark gray palette */
            --bg-primary: #1C1C1C;
            --bg-secondary: #2D2D2D;
            --bg-tertiary: #3A3A3A;
            --bg-hover: #404040;
            --bg-border: #404040;
            --bg-input: #2D2D2D;
            --bg-modal: #2D2D2D;
            --bg-sidebar: #1A1A1A;
            --bg-sidebar-item: #2D2D2D;
            --bg-sidebar-active: #3A3A3A;

            /* Professional text colors - High contrast for readability */
            --text-primary: #FFFFFF;
            --text-secondary: #E5E7EB;
            --text-tertiary: #D1D5DB;
            --text-sidebar: #FFFFFF;
            --text-muted: #9CA3AF;

            /* Modern borders */
            --border-color: #404040;
            --border-input: #4A4A4A;
            --border-focus: #8B5CF6;
            --border-sidebar: #404040;

            /* Brand colors for professional dark theme */
            --brand-primary: #8B5CF6;
            --brand-secondary: #3B82F6;
            --brand-hover: #7C3AED;
            --brand-light: rgba(139, 92, 246, 0.15);

            /* Status colors with vibrant accents */
            --success: #34C759;
            --error: #FF3B30;
            --warning: #FF9500;
            --info: #007AFF;

            /* Enhanced shadows for depth */
            --shadow-light: rgba(0,0,0,0.4);
            --shadow-medium: rgba(0,0,0,0.5);
            --shadow-heavy: rgba(0,0,0,0.7);

            /* Professional card and component colors */
            --card-bg: #2D2D2D;
            --modal-bg: #2D2D2D;
            --button-danger: #FF3B30;
            --success-bg: rgba(52, 199, 89, 0.15);
            --success-border: #34C759;
            --success-text: #FFFFFF;
            --error-bg: rgba(255, 59, 48, 0.15);
            --error-border: #FF3B30;
            --error-text: #FFFFFF;
            --button-purple: #8B5CF6;
            --text-upload: #D1D5DB;
            --text-upload-light: #A3A3A3;
            --text-close-btn: #A3A3A3;
            --gas-price-bg: #2D2D2D;
            --gas-price-text: #FFFFFF;
            --gas-price-value: #34C759;
            --gas-price-unit: #FF3B30;
            --gas-price-status: #9CA3AF;

            /* Gradient colors for modern UI elements */
            --gradient-purple: linear-gradient(135deg, #8B5CF6, #6366F1);
            --gradient-green: linear-gradient(135deg, #34C759, #10B981);
            --gradient-blue: linear-gradient(135deg, #3B82F6, #2563EB);

            /* New variables for professional dark mode */
            --button-success-bg: rgba(52, 199, 89, 0.2);
            --button-success-hover: rgba(52, 199, 89, 0.3);
            --button-warning-bg: rgba(255, 149, 0, 0.2);
            --button-warning-hover: rgba(255, 149, 0, 0.3);
            --button-info-bg: rgba(0, 122, 255, 0.2);
            --button-info-hover: rgba(0, 122, 255, 0.3);
            --button-secondary-bg: #404040;
            --button-secondary-hover: #4A4A4A;
        }

        /* === RESET & BASE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Prevent text selection and make it feel more app-like */
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Allow text selection in inputs and textareas */
        input, textarea, [contenteditable] {
            -webkit-user-select: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            /* iOS Safari specific optimizations */
            -webkit-overflow-scrolling: touch;
            /* Support iPhone X and newer with safe areas */
            padding-top: env(safe-area-inset-top);
            font-weight: 400;
            line-height: 1.6;
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Ensure full viewport usage on iOS */
        @supports (padding: max(0px)) {
            body {
                padding-top: max(0px, env(safe-area-inset-top));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }
        
        /* Remove iOS specific behaviors that make it feel like a web page */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        /* Prevent zoom on input focus (iOS Safari) */
        input, select, textarea {
            font-size: 16px;
        }

        /* === LAYOUT CONTAINERS === */
        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* === SIDEBAR NAVIGATION - MINIMALIST BLACK === */
        .sidebar {
            width: 280px;
            background: #000000;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #1a1a1a;
            transition: transform 0.3s ease;
            position: relative;
        }

        /* Mobile hamburger button - MINIMALIST */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: max(20px, calc(env(safe-area-inset-top) + 20px));
            left: max(20px, calc(env(safe-area-inset-left) + 20px));
            z-index: 10000;
            background: #000000;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            min-height: 56px;
            min-width: 56px;
            touch-action: manipulation;
            transition: all 0.2s ease;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* PWA-specific positioning - positioned above main title */
        @media (display-mode: standalone) {
            .mobile-menu-btn {
                top: max(5px, calc(env(safe-area-inset-top) + 5px));
            }
        }
        
        /* iPhone specific PWA adjustments - fine-tuned for title positioning */
        @supports (height: 100vh) and (display-mode: standalone) {
            .mobile-menu-btn {
                top: max(15px, calc(env(safe-area-inset-top) + 15px));
            }
        }
        
        /* Hide button when menu is open */
        .mobile-menu-open .mobile-menu-btn {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-100px);
        }
        
        .mobile-menu-btn:active,
        .mobile-menu-btn.touching {
            transform: scale(0.95);
            background: #1a1a1a;
        }

        .mobile-menu-btn:hover {
            background: #1a1a1a;
            border-color: rgba(255, 255, 255, 0.2);
        }

        @media (hover: none) {
            .mobile-menu-btn:hover {
                background: #000000;
            }
        }

        .mobile-menu-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Mobile overlay - MINIMALIST */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 999;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: transparent;
        }

        .new-chat-btn {
            background: var(--bg-sidebar-item);
            border: 1px solid var(--border-sidebar);
            color: var(--text-sidebar);
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: var(--bg-sidebar-active);
        }

        .sidebar-menu {
            flex: 1;
            padding: 16px 0;
        }

        .menu-item {
            padding: 16px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 15px;
            font-weight: 400;
            transition: all 0.2s ease;
            border-radius: 0;
            margin: 0;
            color: #ffffff;
            position: relative;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: rgba(255, 255, 255, 0.2);
        }

        .menu-item.active {
            background: #ffffff;
            color: #000000;
            border-left-color: #ffffff;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
            transition: none;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            transition: background-color 0.3s ease;
        }

        .header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
            letter-spacing: -0.5px;
        }

        .current-datetime {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            letter-spacing: 0.1px;
            opacity: 0.8;
        }

        /* Modern Status Indicators */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status-indicator:hover {
            background: var(--bg-hover);
            border-color: var(--brand-primary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .status-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .status-text {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-weight: 500;
            letter-spacing: 0.2px;
        }

        /* Sync Status Specific */
        .sync-status.online .status-icon {
            color: var(--success);
        }

        .sync-status.offline .status-icon {
            color: var(--error);
        }

        .sync-status.syncing .status-icon {
            color: var(--warning);
            animation: spin 1s linear infinite;
        }

        /* Backup Status Specific */
        .backup-status .status-icon {
            color: var(--info);
        }

        .backup-status.recent .status-icon {
            color: var(--success);
        }

        .backup-status.old .status-icon {
            color: var(--warning);
        }

        /* Dark Mode Toggle Specific */
        .dark-mode-toggle {
            border-radius: 50%;
            width: 36px;
            height: 36px;
            padding: 0;
            justify-content: center;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
        }

        .dark-mode-toggle:hover {
            background: var(--brand-light);
            border-color: var(--brand-primary);
            transform: scale(1.05);
        }

        .dark-mode-toggle:active {
            transform: scale(0.95);
        }

        .theme-icon {
            width: 16px;
            height: 16px;
            color: var(--brand-primary);
        }

        /* Animation for spinning sync icon */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Mobile responsive styles for status indicators */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
                flex-wrap: wrap;
                gap: 8px;
                min-height: 70px;
            }

            .main-content {
                /* Adjust for taller header on mobile */
            }

            .header h1 {
                font-size: 18px;
                margin-bottom: 4px;
                width: 100%;
            }

            .header > div:last-child {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }

            .current-datetime {
                font-size: 12px;
                order: 1;
            }

            .status-indicator {
                padding: 4px 8px;
                font-size: 11px;
                border-radius: 16px;
                gap: 4px;
            }

            .status-icon {
                width: 12px;
                height: 12px;
            }

            .status-text {
                display: none; /* Hide text on very small screens */
            }

            .dark-mode-toggle {
                width: 28px;
                height: 28px;
                order: 3;
            }

            .theme-icon {
                width: 14px;
                height: 14px;
            }
        }

        /* Very small screens - show only icons */
        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }

            .header h1 {
                font-size: 16px;
            }

            .current-datetime {
                font-size: 11px;
                flex: 1;
            }

            .status-indicator {
                padding: 6px;
                min-width: 32px;
                justify-content: center;
                border-radius: 50%;
            }

            .status-indicator:not(.dark-mode-toggle) {
                width: 32px;
                height: 32px;
            }

            .dark-mode-toggle {
                width: 32px;
                height: 32px;
            }

            /* Show tooltips on hover for mobile since text is hidden */
            .status-indicator::after {
                content: attr(title);
                position: absolute;
                bottom: -25px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 10px;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s;
                z-index: 1000;
            }

            .status-indicator:active::after {
                opacity: 1;
            }
        }

        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: 100%;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        /* Remove content-area padding on mobile */
        @media (max-width: 768px) {
            .content-area {
                padding: 16px;
            }
        }

        @media (max-width: 480px) {
            .content-area {
                padding: 0;
            }
        }

        /* Override content-area padding for calendar view - Mobile first approach */
        #calendar-view.content-area {
            padding: 0 !important; /* Mobile base: no padding */
        }

        /* Tablet: moderate padding */
        @media (min-width: 481px) and (max-width: 768px) {
            #calendar-view.content-area {
                padding: 12px !important;
            }
        }

        /* Desktop: more padding */
        @media (min-width: 769px) {
            #calendar-view.content-area {
                padding: 24px !important;
            }
        }

        .content-area::-webkit-scrollbar {
            width: 6px;
        }

        .content-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .content-area::-webkit-scrollbar-thumb:hover {
            background: var(--brand-primary);
        }

        /* Upload area */
        .upload-section {
            background: var(--card-bg);
            border: 2px dashed var(--border-input);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: center;
            justify-content: center;
        }

        .upload-section:hover {
            border-color: var(--brand-primary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .upload-section.dragover {
            border-color: var(--brand-primary);
            background: var(--bg-hover);
        }

        .upload-icon {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .upload-btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .upload-btn:hover {
            background: var(--brand-hover);
        }

        .upload-info {
            margin-top: 12px;
        }

        .upload-info small {
            color: var(--text-muted);
            font-size: 13px;
        }

        #file-input {
            display: none;
        }

        /* Preview area */
        .preview-section {
            display: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }

        .image-item {
            position: relative;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px var(--shadow-light);
        }

        .image-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1;
        }

        .image-remove:hover {
            background: rgb(239, 68, 68);
        }

        .preview-actions {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }

        .clear-images-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .clear-images-btn:hover {
            background: #dc2626;
        }

        .clear-images-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Simple Registry Design - Consistent with Main Page */
        .registry-header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        .registry-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
        }

        .registry-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            border-color: var(--brand-primary);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--brand-primary);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .search-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        .search-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 16px;
            align-items: end;
        }

        .search-field {
            position: relative;
        }

        .search-field label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-input, .search-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-input);
            border-radius: 6px;
            font-size: 16px;
            background: var(--bg-input);
            transition: border-color 0.2s;
            color: var(--text-tertiary);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        /* Fix search select dropdown arrow */
        .search-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .search-input:focus, .search-select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--brand-light);
        }

        .search-btn {
            background: var(--gradient-purple);
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #7C3AED, #6366F1);
        }

        .clients-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        .clients-grid {
            display: grid;
            gap: 16px;
        }

        .client-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
            border-color: var(--brand-primary);
        }

        .client-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .client-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .client-date {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .client-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .client-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .client-detail-icon {
            width: 16px;
            height: 16px;
            color: var(--brand-primary);
            flex-shrink: 0;
        }

        .client-detail-text {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .client-jobs {
            margin-top: 16px;
        }

        .client-jobs-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .job-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .job-tag {
            background: var(--brand-light);
            color: var(--brand-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Finance Styles */
        .finance-header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        .finance-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .current-month {
            font-size: 16px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .weekly-finance-section,
        .monthly-finance-section,
        .tithe-section {
            margin-bottom: 24px;
        }

        .weekly-finance-section h2,
        .monthly-finance-section h2,
        .tithe-section h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .monthly-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .finance-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            background-image: linear-gradient(var(--card-bg), var(--card-bg)),
                              linear-gradient(135deg, var(--brand-primary), transparent 70%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }

        .finance-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--brand-primary);
        }

        .finance-card-header h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .finance-card-header small {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
            margin-top: 4px;
        }

        .finance-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--brand-primary);
            margin-bottom: 4px;
        }

        .finance-amount.expense {
            color: var(--error);
        }

        .week-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-top: 3px solid #10a37f;
        }

        .week-card h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .week-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .week-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .week-stat-label {
            color: var(--text-secondary);
        }

        .week-stat-value {
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .week-stat-value.positive {
            color: #059669;
        }

        .week-stat-value.negative {
            color: var(--error);
        }

        .tithe-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .tithe-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .tithe-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--brand-primary);
        }

        /* Dashboard Styles */
        .dashboard-header {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e5e5;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .dashboard-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            border-color: var(--brand-primary);
        }


        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--brand-primary);
            line-height: 1;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Charts Row */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            border: 1px solid #e5e5e5;
        }

        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--brand-primary);
        }

        .chart-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5e5;
        }

        .chart-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
        }

        .chart-content {
            position: relative;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Analytics Row */
        .analytics-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .analytics-panel {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            border: 1px solid #e5e5e5;
        }

        .analytics-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--brand-primary);
        }

        .panel-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5e5;
        }

        .panel-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
        }

        .panel-content {
            min-height: 160px;
        }

        /* Revenue Bars */
        .revenue-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .revenue-bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .revenue-bar-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-tertiary);
            min-width: 80px;
        }

        .revenue-bar-container {
            flex: 1;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .revenue-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10a37f, #059669);
            border-radius: 12px;
            transition: width 1s ease;
        }

        .revenue-bar-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--brand-primary);
            min-width: 60px;
            text-align: right;
        }

        /* Activity List */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .activity-item:hover {
            background: var(--bg-tertiary);
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--brand-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-tertiary);
            margin: 0 0 2px 0;
        }

        .activity-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Trend Section */
        .trend-section {
            margin-bottom: 24px;
        }

        .trend-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            border: 1px solid #e5e5e5;
        }

        .trend-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--brand-primary);
        }

        .trend-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5e5;
        }

        .trend-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
        }

        .trend-content {
            position: relative;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dashboard Mobile Layout */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .charts-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .analytics-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 768px) {
            /* Keep 2x2 grid for metrics on mobile */
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            /* Mobile optimized charts row - side by side */
            .charts-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 16px;
            }

            /* Mobile optimized analytics row - side by side */
            .analytics-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 16px;
            }

            /* Trend section spans full width */
            .trend-section {
                grid-column: 1 / -1;
                margin-bottom: 16px;
            }

            .dashboard-header {
                padding: 16px;
                margin-bottom: 16px;
            }

            .dashboard-title {
                font-size: 18px;
            }

            .dashboard-subtitle {
                font-size: 12px;
            }

            .metric-card {
                padding: 12px;
            }

            .metric-value {
                font-size: 18px;
            }

            .metric-label {
                font-size: 10px;
            }

            .metric-icon {
                width: 32px;
                height: 32px;
                margin-bottom: 8px;
            }

            .metric-icon svg {
                width: 16px;
                height: 16px;
            }

            .chart-card,
            .analytics-panel {
                padding: 10px;
            }

            .chart-header h3,
            .panel-header h3 {
                font-size: 11px;
                line-height: 1.2;
            }

            .chart-content {
                height: 120px;
            }

            .panel-content {
                min-height: 90px;
            }

            .trend-card {
                padding: 12px;
            }

            .trend-content {
                height: 100px;
            }

            .trend-header h3 {
                font-size: 13px;
            }

            /* Revenue bars mobile optimization */
            .revenue-bar-label {
                font-size: 11px;
                min-width: 50px;
            }

            .revenue-bar-value {
                font-size: 11px;
                min-width: 45px;
            }

            .revenue-bar-container {
                height: 16px;
            }

            /* Activity list mobile optimization */
            .activity-item {
                padding: 8px;
                gap: 8px;
            }

            .activity-icon {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .activity-title {
                font-size: 12px;
            }

            .activity-subtitle {
                font-size: 10px;
            }

            .activity-time {
                font-size: 9px;
            }
        }

        @media (max-width: 480px) {
            /* Even smaller screens - compact but still organized */
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .charts-row,
            .analytics-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .metric-card {
                padding: 8px;
            }

            .metric-value {
                font-size: 16px;
            }

            .metric-label {
                font-size: 9px;
            }

            .chart-card,
            .analytics-panel,
            .trend-card {
                padding: 8px;
                max-width: 100%;
                overflow: hidden;
            }

            .chart-header h3,
            .panel-header h3 {
                font-size: 10px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .chart-content {
                height: 140px;
            }

            .panel-content {
                min-height: 100px;
            }

            .trend-content {
                height: 100px;
            }
        }

        .no-clients {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .no-clients-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .search-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .client-details {
                grid-template-columns: 1fr;
            }
            
            .registry-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Form section */
        .form-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-tertiary);
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 1px solid var(--border-input);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            color: var(--text-tertiary);
            background: var(--bg-input);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--brand-light);
        }

        /* Fix select dropdown arrow */
        .form-group select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Price field with dollar symbol */
        .price-container {
            position: relative;
        }

        .price-symbol {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            z-index: 1;
            font-weight: 500;
            pointer-events: none;
        }

        .price-input {
            padding-left: 25px !important;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-modal);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Simple Calendar Design - Consistent with Main Page */
        .calendar-header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .calendar-nav-btn {
            background: rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .calendar-nav-btn:hover {
            background: rgba(59, 130, 246, 0.35);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);
        }

        .calendar-nav-btn:active {
            transform: translateY(0);
        }

        .week-range {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        #weekly-calendar-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Override for calendar view - Base styles without padding */
        #calendar-view #weekly-calendar-container {
            background: transparent !important;
            box-shadow: none !important;
            padding: 0 !important;
        }

        #weekly-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 20px;
        }

        /* Hide mobile elements in desktop */
        .mobile-day-section {
            display: none;
        }

        .mobile-client-card {
            display: none;
        }

        .day-column {
            background: white;
            border-radius: 12px;
            padding: 16px 12px;
            min-height: 300px;
            border: 1px solid #e5e5e5;
            transition: all 0.3s ease;
        }

        /* Calendar view glassmorphism override */
        #calendar-view .day-column {
            background: rgba(30, 41, 59, 0.4) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
        }

        .day-column:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #calendar-view .day-column:hover {
            background: rgba(30, 41, 59, 0.5) !important;
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18) !important;
            border-color: rgba(255, 255, 255, 0.15) !important;
        }

        .day-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .gas-cost-outside {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .appointment-slot {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 12px;
        }

        .appointment-slot.booked {
            background: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
        }

        .appointment-slot.available {
            background: #f8fafc;
            color: #94a3b8;
            border-style: dashed;
        }

        .appointment-slot.event-slot {
            border-width: 2px;
            font-weight: 600;
        }

        .appointment-slot.event-slot:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .slot-time {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .slot-info {
            font-size: 11px;
            opacity: 0.8;
        }

        .day-header {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e5e5;
        }

        .day-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .day-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .day-number.today {
            color: var(--brand-primary);
            font-weight: 800;
        }

        .day-column.today {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
        }

        #calendar-view .day-column.today {
            background: rgba(16, 163, 127, 0.15) !important;
            border-color: rgba(16, 163, 127, 0.4) !important;
            box-shadow: 0 0 0 1px rgba(16, 163, 127, 0.3), 0 8px 32px rgba(0, 0, 0, 0.12) !important;
        }

        .day-column.today .day-name {
            color: var(--brand-primary);
            font-weight: 700;
        }

        #calendar-view .day-name,
        #calendar-view .day-number,
        #calendar-view .day-date,
        #calendar-view .day-header {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #calendar-view .mobile-day-section {
            background: rgba(30, 41, 59, 0.4) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
        }

        .appointment-slot {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #calendar-view .appointment-slot {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }

        #calendar-view .appointment-slot * {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        .appointment-slot:hover {
            border-color: var(--brand-primary);
            box-shadow: 0 2px 8px rgba(16, 163, 127, 0.15);
        }

        #calendar-view .appointment-slot:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
        }

        .appointment-slot.available {
            border: 1px solid rgba(16, 163, 127, 0.3);
            background: rgba(16, 163, 127, 0.05);
        }

        .appointment-slot.available:hover {
            border-color: rgba(16, 163, 127, 0.5);
            background: rgba(16, 163, 127, 0.1);
        }

        .appointment-slot.booked {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            color: white;
        }

        .appointment-slot.booked:hover {
            background: #0d9169;
        }

        .slot-time {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .slot-info {
            font-size: 11px;
            font-weight: 500;
            opacity: 0.8;
        }

        /* Weekly calendar responsive */
        @media (max-width: 1200px) {
            #weekly-calendar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .calendar-nav {
                flex-direction: column;
                gap: 12px;
            }
            
            .week-range {
                font-size: 20px;
            }
        }

        @media (max-width: 768px) {
            #weekly-calendar-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .calendar-header, #weekly-calendar-container {
                padding: 16px;
                border-radius: 16px;
            }
            
            .day-column {
                min-height: 250px;
                padding: 12px 8px;
            }
            
            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
            }
        }

        @media (max-width: 480px) {
            #weekly-calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-nav-btn {
                padding: 10px 14px;
                font-size: 14px;
            }
            
            .week-range {
                font-size: 18px;
            }
        }

        .submit-btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s;
        }

        .submit-btn:hover {
            background: #0d9169;
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Custom Dropdown Styles */
        .custom-dropdown {
            position: relative;
        }

        .dropdown-header {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            font-size: 14px;
            min-height: 22px;
        }
        
        .dropdown-header span {
            font-size: 14px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .dropdown-header:hover {
            border-color: #9ca3af;
        }
        
        .dropdown-header:active {
            background-color: #f3f4f6;
            border-color: var(--brand-primary);
        }
        
        @media (hover: none) {
            .dropdown-header:hover {
                border-color: #d1d5db;
            }
        }

        .dropdown-header.open {
            border-color: var(--brand-primary);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .dropdown-arrow {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .dropdown-header.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            max-height: 250px;
            overflow-y: auto;
        }

        .dropdown-list.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .dropdown-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            min-width: 18px;
            min-height: 18px;
            touch-action: manipulation;
            accent-color: #10a37f;
            transform: scale(1.1);
        }
        
        .dropdown-item input[type="checkbox"]:checked {
            background-color: var(--brand-primary);
            border-color: var(--brand-primary);
        }
        
        .dropdown-item input[type="checkbox"]:checked + label {
            color: var(--brand-primary);
            font-weight: 500;
        }

        .dropdown-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Loading spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10a37f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hexagonal Loading Animation Styles */
        .hex-loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(55, 57, 64, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .socket {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .hex-brick {
            background: #10a37f;
            width: 30px;
            height: 17px;
            position: absolute;
            top: 5px;
            animation-name: hexFade;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            -webkit-animation-name: hexFade;
            -webkit-animation-duration: 2s;
            -webkit-animation-iteration-count: infinite;
        }

        .h2 {
            transform: rotate(60deg);
            -webkit-transform: rotate(60deg);
        }

        .h3 {
            transform: rotate(-60deg);
            -webkit-transform: rotate(-60deg);
        }

        .gel {
            height: 30px;
            width: 30px;
            transition: all .3s;
            -webkit-transition: all .3s;
            position: absolute;
            top: 50%;
            left: 50%;
        }

        .center-gel {
            margin-left: -15px;
            margin-top: -15px;
            animation-name: hexPulse;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            -webkit-animation-name: hexPulse;
            -webkit-animation-duration: 2s;
            -webkit-animation-iteration-count: infinite;
        }

        .c1 { margin-left: -47px; margin-top: -15px; }
        .c2 { margin-left: -31px; margin-top: -43px; }
        .c3 { margin-left: 1px; margin-top: -43px; }
        .c4 { margin-left: 17px; margin-top: -15px; }
        .c5 { margin-left: -31px; margin-top: 13px; }
        .c6 { margin-left: 1px; margin-top: 13px; }
        .c7 { margin-left: -63px; margin-top: -43px; }
        .c8 { margin-left: 33px; margin-top: -43px; }
        .c9 { margin-left: -15px; margin-top: 41px; }
        .c10 { margin-left: -63px; margin-top: 13px; }
        .c11 { margin-left: 33px; margin-top: 13px; }
        .c12 { margin-left: -15px; margin-top: -71px; }
        .c13 { margin-left: -47px; margin-top: -71px; }
        .c14 { margin-left: 17px; margin-top: -71px; }
        .c15 { margin-left: -47px; margin-top: 41px; }
        .c16 { margin-left: 17px; margin-top: 41px; }
        .c17 { margin-left: -79px; margin-top: -15px; }
        .c18 { margin-left: 49px; margin-top: -15px; }
        .c19 { margin-left: -63px; margin-top: -99px; }
        .c20 { margin-left: 33px; margin-top: -99px; }
        .c21 { margin-left: 1px; margin-top: -99px; }
        .c22 { margin-left: -31px; margin-top: -99px; }
        .c23 { margin-left: -63px; margin-top: 69px; }
        .c24 { margin-left: 33px; margin-top: 69px; }
        .c25 { margin-left: 1px; margin-top: 69px; }
        .c26 { margin-left: -31px; margin-top: 69px; }
        .c28 { margin-left: -95px; margin-top: -43px; }
        .c29 { margin-left: -95px; margin-top: 13px; }
        .c30 { margin-left: 49px; margin-top: 41px; }
        .c31 { margin-left: -79px; margin-top: -71px; }
        .c32 { margin-left: -111px; margin-top: -15px; }
        .c33 { margin-left: 65px; margin-top: -43px; }
        .c34 { margin-left: 65px; margin-top: 13px; }
        .c35 { margin-left: -79px; margin-top: 41px; }
        .c36 { margin-left: 49px; margin-top: -71px; }
        .c37 { margin-left: 81px; margin-top: -15px; }

        .r1 {
            animation-name: hexPulse;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-delay: .2s;
            -webkit-animation-name: hexPulse;
            -webkit-animation-duration: 2s;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-delay: .2s;
        }

        .r2 {
            animation-name: hexPulse;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-delay: .4s;
            -webkit-animation-name: hexPulse;
            -webkit-animation-duration: 2s;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-delay: .4s;
        }

        .r3 {
            animation-name: hexPulse;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-delay: .6s;
            -webkit-animation-name: hexPulse;
            -webkit-animation-duration: 2s;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-delay: .6s;
        }

        .r1 > .hex-brick {
            animation-name: hexFade;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-delay: .2s;
            -webkit-animation-name: hexFade;
            -webkit-animation-duration: 2s;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-delay: .2s;
        }

        .r2 > .hex-brick {
            animation-name: hexFade;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-delay: .4s;
            -webkit-animation-name: hexFade;
            -webkit-animation-duration: 2s;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-delay: .4s;
        }

        .r3 > .hex-brick {
            animation-name: hexFade;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-delay: .6s;
            -webkit-animation-name: hexFade;
            -webkit-animation-duration: 2s;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-delay: .6s;
        }

        @keyframes hexPulse {
            0% {
                -webkit-transform: scale(1);
                transform: scale(1);
            }
            50% {
                -webkit-transform: scale(0.01);
                transform: scale(0.01);
            }
            100% {
                -webkit-transform: scale(1);
                transform: scale(1);
            }
        }

        @keyframes hexFade {
            0% {
                background: #10a37f;
            }
            50% {
                background: #0d8a68;
            }
            100% {
                background: #10a37f;
            }
        }

        @-webkit-keyframes hexPulse {
            0% {
                -webkit-transform: scale(1);
                transform: scale(1);
            }
            50% {
                -webkit-transform: scale(0.01);
                transform: scale(0.01);
            }
            100% {
                -webkit-transform: scale(1);
                transform: scale(1);
            }
        }

        @-webkit-keyframes hexFade {
            0% {
                background: #10a37f;
            }
            50% {
                background: #0d8a68;
            }
            100% {
                background: #10a37f;
            }
        }

        /* Mobile POS Terminal styles */
        .mobile-pos-container {
            position: relative;
        }

        .mobile-pos-container::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
        }


        /* Success message */
        .success-message {
            display: none;
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            color: #166534;
        }

        /* Error message */
        .error-message {
            display: none;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            color: var(--error);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                overflow: auto;
            }

            .mobile-menu-btn {
                display: block;
            }

            .mobile-overlay {
                display: none;
            }

            .mobile-overlay.active {
                display: block;
            }

            .container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
                overflow-y: auto;
                box-shadow: 4px 0 24px rgba(0, 0, 0, 0.4);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                flex: 1;
                padding-top: 60px;
                margin-left: 0 !important;
            }

            /* Remove top padding and background when calendar is visible */
            .main-content:has(#calendar-view) {
                padding-top: 0 !important;
                background: transparent !important;
            }

            .content-wrapper {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .form-section {
                padding: 16px;
                margin-bottom: 16px;
            }

            /* Calendar mobile adjustments */
            #weekly-calendar-grid {
                display: block !important;
                gap: 0;
            }

            .mobile-day-section {
                width: 100%;
                margin-bottom: 20px;
                display: block !important;
            }

            .mobile-client-card {
                display: block !important;
            }

            .mobile-client-card:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                border-color: var(--brand-primary);
            }

            /* Hide desktop elements in mobile */
            .day-column {
                display: none;
            }

            .day-wrapper {
                display: none;
            }

            .appointment-card {
                padding: 8px;
                margin-bottom: 6px;
                font-size: 12px;
            }

            /* Finance page mobile */
            .finance-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            /* Registry mobile */
            .registry-stats {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .search-grid {
                grid-template-columns: 1fr;
            }

            .client-card {
                padding: 12px;
            }

            /* Upload area mobile */
            .upload-area {
                padding: 24px 16px;
            }

            .upload-text {
                font-size: 14px;
            }

            /* Gas cost mobile */
            .gas-cost-outside {
                font-size: 11px;
                top: -20px;
            }
        }

        @media (max-width: 480px) {
            /* Mobile menu positioning handled by main CSS rules above */

            .main-content {
                padding-top: 56px;
            }

            /* Remove top padding and background when calendar is visible */
            .main-content:has(#calendar-view) {
                padding-top: 0 !important;
                background: transparent !important;
            }

            .content-wrapper {
                padding: 12px;
            }

            #weekly-calendar-grid {
                display: block !important;
                gap: 0;
            }

            .day-column {
                min-height: 150px;
                padding: 8px;
            }

            .day-number {
                font-size: 18px;
            }

            .appointment-card {
                font-size: 11px;
                padding: 6px;
            }

            .form-section {
                padding: 12px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            /* Mobile Calendar Glassmorphism */
            #calendar-view .mobile-day-section {
                background: rgba(30, 41, 59, 0.4) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
                border-radius: 12px !important;
                padding: 16px !important;
            }

            #calendar-view .mobile-client-card {
                background: rgba(255, 255, 255, 0.1) !important;
                backdrop-filter: blur(10px) !important;
                -webkit-backdrop-filter: blur(10px) !important;
                border: 1px solid rgba(255, 255, 255, 0.15) !important;
                color: rgba(255, 255, 255, 0.95) !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
                border-radius: 8px !important;
            }

            #calendar-view .mobile-client-card * {
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view .mobile-day-section h3,
            #calendar-view .mobile-day-section .day-name,
            #calendar-view .mobile-day-section .day-number,
            #calendar-view .mobile-day-section .day-date {
                color: rgba(255, 255, 255, 0.95) !important;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            #calendar-view .mobile-day-section .empty-state,
            #calendar-view .mobile-day-section .no-appointments {
                color: rgba(255, 255, 255, 0.7) !important;
                font-style: italic;
            }

            #calendar-view .mobile-day-header {
                border-bottom-color: rgba(255, 255, 255, 0.15) !important;
            }

            #calendar-view .mobile-day-section span,
            #calendar-view .mobile-day-section p,
            #calendar-view .mobile-day-section h3,
            #calendar-view .mobile-day-section h4 {
                color: rgba(255, 255, 255, 0.95) !important;
            }
        }

        /* Receipt Preview Modal Mobile Styles - Optimized for Mobile Invoice Design */
        #receipt-preview-modal {
            padding: 10px;
        }

        /* PDF Optimization Styles */
        .mobile-invoice-container,
        .mobile-invoice-container * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        #receipt-preview-modal > div {
            max-height: 95vh;
            width: 420px;
            max-width: 420px;
            overflow-x: hidden;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            #receipt-preview-modal {
                padding: 5px;
                align-items: flex-start;
                padding-top: 20px;
            }

            #receipt-preview-modal > div {
                max-width: 100%;
                width: 100%;
                max-height: 90vh;
            }

            /* Mobile invoice optimizations */
            #receipt-preview-content {
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 12px !important;
                max-width: 400px !important;
                width: 100% !important;
            }

            /* Ensure mobile invoice layout */
            #receipt-preview-content > div {
                max-width: 400px !important;
                margin: 0 auto !important;
            }

            /* Mobile invoice header adjustments */
            #receipt-preview-content h1 {
                font-size: 24px !important;
                font-weight: 600 !important;
            }

            /* Prominent total amount on mobile */
            #receipt-preview-content div[style*="font-size: 48px"] {
                font-size: 48px !important;
                line-height: 1 !important;
            }

            /* Green paid status styling */
            #receipt-preview-content div[style*="background: #28a745"] {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 8px !important;
            }

            /* Services list mobile optimization */
            #receipt-preview-content div[style*="border-bottom"][style*="padding: 16px 0"] {
                padding: 16px 0 !important;
                border-bottom: 1px solid #e9ecef !important;
            }

            /* Summary section mobile styling */
            #receipt-preview-content div[style*="background: #f8f9fa"][style*="padding: 16px"] {
                padding: 16px !important;
                border-radius: 8px !important;
                margin-bottom: 24px !important;
            }

            /* QR code section mobile */
            #receipt-preview-content img[alt="QR Code"] {
                width: 80px !important;
                height: 80px !important;
                border-radius: 4px !important;
            }

            /* Business info section mobile */
            #receipt-preview-content div[style*="LivinGreen"] {
                text-align: center !important;
                padding: 16px !important;
                border-radius: 8px !important;
            }

            /* Action buttons mobile layout */
            #receipt-preview-modal .action-buttons {
                flex-direction: column;
                gap: 8px;
                margin-top: 20px;
            }

            #receipt-preview-modal .action-buttons button {
                width: 100%;
                text-align: center;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            /* Extra small mobile adjustments for mobile invoice */
            #receipt-preview-content {
                padding: 0 !important;
                margin: 5px !important;
                border-radius: 8px !important;
            }

            #receipt-preview-content > div {
                max-width: 360px !important;
            }

            /* Smaller title on very small screens */
            #receipt-preview-content h1 {
                font-size: 20px !important;
            }

            /* Smaller total amount on very small screens */
            #receipt-preview-content div[style*="font-size: 48px"] {
                font-size: 40px !important;
            }

            /* Compact service items */
            #receipt-preview-content div[style*="border-bottom"][style*="padding: 16px 0"] {
                padding: 12px 0 !important;
            }

            /* Compact QR code section */
            #receipt-preview-content img[alt="QR Code"] {
                width: 60px !important;
                height: 60px !important;
            }

            /* Compact business info */
            #receipt-preview-content div[style*="LivinGreen"] {
                padding: 12px !important;
            }
        }

        /* Messages View Styles */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .copy-btn:hover {
            background: #0d8c6d !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .message-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .message-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
        }

        @media (max-width: 768px) {
            .message-card {
                padding: 16px !important;
            }

            .message-content {
                font-size: 14px !important;
                padding: 16px !important;
            }

            #copy-notification {
                bottom: 16px !important;
                right: 16px !important;
                left: 16px !important;
                font-size: 14px !important;
            }
        }

        /* ================================
           BENTO GRID LANDING PAGE STYLES
           ================================ */

        .landing-view {
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.4) 0%, rgba(30, 41, 59, 0.4) 100%),
                        url('./images/background.webp') center center / cover no-repeat;
            background-attachment: fixed;
            padding: 48px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10001;
            overflow-y: auto;
        }

        /* Hide header when landing view is visible */
        .landing-view ~ .container .header {
            opacity: 0;
            pointer-events: none;
        }

        .landing-header {
            text-align: center;
            margin-bottom: 48px;
            animation: fadeInDown 0.6s ease-out;
        }

        .landing-title {
            font-size: 48px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #10a37f, #60efff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .landing-subtitle {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            max-width: 600px;
            margin: 0 auto;
        }

        .bento-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 32px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            grid-auto-rows: 200px;
        }

        .bento-item {
            border-radius: 32px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInScale 0.5s ease-out backwards;
            background: rgba(40, 40, 40, 0.4);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .bento-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            transition: all 0.3s ease;
            z-index: 1;
            pointer-events: none;
        }

        .bento-item:hover::before {
            background: rgba(255, 255, 255, 0.05);
        }

        .bento-item:hover {
            transform: translateY(-4px) scale(1.01);
            background: rgba(50, 50, 50, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
        }

        .bento-item-large {
            grid-column: span 2;
            grid-row: span 2;
        }

        .bento-item-medium {
            grid-column: span 1;
            grid-row: span 2;
        }

        .bento-item-small {
            grid-column: span 1;
            grid-row: span 1;
        }

        .bento-item-content {
            height: 100%;
            padding: 32px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            z-index: 2;
            background: transparent;
        }

        .bento-item-image {
            background: transparent;
        }

        .bento-item-text {
            background: transparent;
        }

        .bento-item-accent {
            background: transparent;
        }

        .bento-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            fill: rgba(180, 180, 180, 0.9);
            opacity: 0.9;
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .bento-item:hover .bento-icon {
            transform: scale(1.05);
            fill: rgba(200, 200, 200, 1);
            opacity: 1;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
        }

        .bento-title {
            font-size: 24px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 8px;
            transition: all 0.3s ease;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .bento-item:hover .bento-title {
            transform: translateY(-2px);
            color: rgba(255, 255, 255, 1);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .bento-description {
            font-size: 14px;
            color: rgba(200, 200, 200, 0.8);
            line-height: 1.5;
            transition: all 0.3s ease;
        }

        .bento-item:hover .bento-description {
            color: rgba(220, 220, 220, 1);
            transform: translateY(-1px);
        }

        /* Mini Calendar Styles */
        .mini-calendar {
            width: 100%;
        }

        .mini-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            margin-bottom: 1px;
        }

        .mini-calendar-days div {
            text-align: center;
            color: rgba(160, 160, 160, 0.6);
            font-size: 6px;
            font-weight: 600;
            padding: 0;
            line-height: 1;
        }

        .mini-calendar-dates {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
        }

        .mini-calendar-dates div {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(200, 200, 200, 0.75);
            font-size: 7px;
            font-weight: 500;
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .mini-calendar-dates div:hover {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 1);
        }

        .mini-calendar-dates div.today {
            background: rgba(100, 200, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            font-weight: 700;
            box-shadow: 0 0 0 1.5px rgba(100, 200, 255, 0.6);
        }

        /* Today Amount Circle Styles */
        .today-amount-circle {
            width: 140px;
            height: 140px;
            position: relative;
            flex-shrink: 0;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 12;
        }

        .progress-ring-fill {
            fill: none;
            stroke: #00d4ff;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .circle-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circle-content .amount {
            font-size: 28px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1;
            margin-bottom: 4px;
        }

        .circle-content .today-label {
            font-size: 14px;
            font-weight: 500;
            color: rgba(200, 200, 200, 0.8);
        }

        /* Appointments List Styles */
        .appointments-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .appointment-item {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
            padding: 6px 0;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .appointment-item:last-child {
            border-bottom: none;
        }

        /* Calendar Slider Styles */
        .calendar-slider {
            overflow: hidden;
            position: relative;
        }

        .calendar-slides {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
        }

        .calendar-slides.show-second {
            transform: translateX(-50%);
        }

        .calendar-slide {
            width: 50%;
            flex-shrink: 0;
            height: 100%;
        }

        /* Finance Slider Styles */
        .finance-slider {
            overflow: hidden;
            position: relative;
        }

        .finance-slides {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
        }

        .finance-slides.show-second {
            transform: translateX(-50%);
        }

        .finance-slide {
            width: 50%;
            flex-shrink: 0;
            height: 100%;
        }

        /* Analytics Slider Styles */
        .analytics-slider {
            overflow: hidden;
            position: relative;
        }

        .analytics-slides {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
        }

        .analytics-slides.show-second {
            transform: translateX(-50%);
        }

        .analytics-slide {
            width: 50%;
            flex-shrink: 0;
            height: 100%;
        }

        /* Registry Slider Styles */
        .registry-slider {
            overflow: hidden;
            position: relative;
        }

        .registry-slides {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
        }

        .registry-slides.show-second {
            transform: translateX(-50%);
        }

        .registry-slide {
            width: 50%;
            flex-shrink: 0;
            height: 100%;
        }

        /* Mini Stats Styles for Datos Card */
        .mini-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            margin-top: 12px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(200, 200, 200, 0.8);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Finance Progress Bars */
        .finance-summary {
            width: 100%;
            margin-top: 16px;
        }

        .finance-item {
            margin-bottom: 12px;
        }

        .finance-item:last-child {
            margin-bottom: 0;
        }

        .finance-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .finance-label-text {
            color: rgba(200, 200, 200, 0.9);
            font-weight: 500;
        }

        .finance-amount {
            color: rgba(255, 255, 255, 0.95);
            font-weight: 600;
        }

        .finance-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .finance-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10a37f 0%, #0d8c6d 100%);
            border-radius: 3px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .finance-bar-fill.expense {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        /* Activity List for Registro */
        .activity-list {
            width: 100%;
            margin-top: 12px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 11px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10a37f;
            flex-shrink: 0;
        }

        .activity-text {
            flex: 1;
            color: rgba(200, 200, 200, 0.9);
            line-height: 1.4;
        }

        .activity-time {
            color: rgba(160, 160, 160, 0.7);
            font-size: 10px;
        }

        /* Status Indicators for ConfiguraciÃ³n */
        .status-grid {
            width: 100%;
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .status-label {
            color: rgba(200, 200, 200, 0.9);
            font-weight: 500;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(16, 163, 127, 0.2);
            color: rgba(16, 163, 127, 1);
            border: 1px solid rgba(16, 163, 127, 0.3);
        }

        .status-badge.inactive {
            background: rgba(160, 160, 160, 0.2);
            color: rgba(200, 200, 200, 0.9);
            border: 1px solid rgba(160, 160, 160, 0.3);
        }

        /* Updated: 2025-11-26 - Enhanced visual effects */

        .bento-item-large .bento-icon {
            width: 96px;
            height: 96px;
        }

        .bento-item-large .bento-title {
            font-size: 36px;
        }

        .bento-item-large .bento-description {
            font-size: 16px;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @media (max-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .bento-item-large {
                grid-column: span 2;
            }
        }

        @media (max-width: 768px) {
            .landing-view {
                padding: max(48px, calc(env(safe-area-inset-top) + 32px)) 20px max(48px, calc(env(safe-area-inset-bottom) + 32px));
                justify-content: flex-start;
            }

            .landing-title {
                font-size: 36px;
            }

            .landing-subtitle {
                font-size: 16px;
            }

            .bento-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                grid-auto-rows: 180px;
            }

            .bento-item-large {
                grid-column: span 2;
                grid-row: span 2;
            }

            .bento-item-medium {
                grid-column: span 1;
                grid-row: span 2;
            }

            .bento-item-small {
                grid-column: span 1;
                grid-row: span 1;
            }

            .bento-item-content {
                padding: 20px;
            }

            .bento-icon {
                width: 48px;
                height: 48px;
            }

            .bento-item-large .bento-icon {
                width: 72px;
                height: 72px;
            }

            .bento-title {
                font-size: 18px;
            }

            .bento-item-large .bento-title {
                font-size: 28px;
            }

            .bento-description {
                font-size: 12px;
            }

            /* Mini calendar mobile styles */
            .mini-calendar {
                max-width: 90%;
                margin: 0 auto;
            }

            .mini-calendar-days div {
                font-size: 6px;
            }

            .mini-calendar-dates div {
                font-size: 7px;
            }

            .calendar-slide h3 {
                font-size: 9px !important;
                margin-bottom: 4px !important;
            }

            .bento-item-small .bento-item-content {
                padding: 14px 12px 18px 12px !important;
            }

            /* Widget mobile styles */
            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 9px;
            }

            .finance-label {
                font-size: 11px;
            }

            .activity-item {
                font-size: 10px;
            }

            .status-item {
                font-size: 10px;
                padding: 6px 10px;
            }
        }

        @media (max-width: 480px) {
            .landing-view {
                padding: max(40px, calc(env(safe-area-inset-top) + 20px)) 16px max(40px, calc(env(safe-area-inset-bottom) + 20px));
                justify-content: flex-start;
            }

            .landing-header {
                margin-bottom: 32px;
                margin-top: 20px;
            }

            .bento-grid {
                grid-auto-rows: 160px;
                margin-bottom: 40px;
                gap: 12px;
            }

            /* Reduce padding for all cards */
            .bento-item-content {
                padding: 12px !important;
            }

            .bento-item-large .bento-item-content {
                padding: 16px !important;
            }

            /* Smaller calendar for very small screens */
            .mini-calendar {
                max-width: 85%;
                margin: 0 auto;
            }

            .mini-calendar-days div {
                font-size: 5px;
            }

            .mini-calendar-dates div {
                font-size: 6px;
            }

            .calendar-slide h3 {
                font-size: 8px !important;
                margin-bottom: 3px !important;
            }

            .bento-item-small .bento-item-content {
                padding: 12px 10px 16px 10px !important;
            }

            /* Smaller widgets for very small screens */
            .stat-value {
                font-size: 16px;
            }

            .stat-label {
                font-size: 7px;
                letter-spacing: 0.3px;
            }

            .stat-box {
                padding: 8px;
                border-radius: 8px;
            }

            .mini-stats-grid {
                gap: 8px;
                margin-top: 8px;
            }

            /* Finance adjustments */
            .finance-summary {
                margin-top: 10px;
            }

            .finance-item {
                margin-bottom: 8px;
            }

            .finance-label {
                font-size: 9px;
                margin-bottom: 4px;
            }

            .finance-bar {
                height: 4px;
            }

            /* Activity list adjustments */
            .activity-list {
                margin-top: 8px;
            }

            .activity-item {
                font-size: 8px;
                padding: 5px 0;
                gap: 6px;
            }

            .activity-dot {
                width: 5px;
                height: 5px;
            }

            .activity-time {
                font-size: 8px;
            }

            /* Status adjustments */
            .status-grid {
                margin-top: 8px;
                gap: 6px;
            }

            .status-item {
                font-size: 8px;
                padding: 5px 6px;
            }

            .status-badge {
                font-size: 7px;
                padding: 2px 5px;
            }

            /* Card titles for small screens */
            .bento-item-content h3 {
                font-size: 12px !important;
                margin-bottom: 2px !important;
            }

            .bento-item-content p {
                font-size: 9px !important;
            }
        }

        /* ================================
           2025 MODERN REDESIGN - NO SIDEBAR
           ================================ */

        /* Hide sidebar completely - Bento Grid is the only navigation */
        .sidebar {
            display: none !important;
        }

        /* Mobile overlay not needed without sidebar */
        .mobile-overlay {
            display: none !important;
        }

        /* Container takes full width without sidebar */
        .container {
            display: block !important;
            width: 100%;
        }

        /* Main content takes full width */
        .main-content {
            width: 100%;
            max-width: 100%;
        }

        /* ================================
           NOTION-STYLE MINIMALIST HEADER
           ================================ */

        .header {
            padding: 12px 24px !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06) !important;
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(20px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
            min-height: 60px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        [data-theme="dark"] .header {
            background: rgba(0, 0, 0, 0.8) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
        }

        /* Hide the old title */
        .header h1 {
            display: none !important;
        }

        /* Hide status indicators (datetime, sync, backup) */
        .current-datetime,
        .sync-status,
        .backup-status {
            display: none !important;
        }

        /* Keep only dark mode toggle, style it minimal */
        .dark-mode-toggle {
            background: transparent !important;
            border: none !important;
            padding: 8px !important;
            border-radius: 8px !important;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dark-mode-toggle:hover {
            background: rgba(0, 0, 0, 0.05) !important;
        }

        [data-theme="dark"] .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Add minimal logo/brand area */
        .header::before {
            content: "LivinGreen";
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        /* ================================
           2025 MODERN FORM INPUTS
           ================================ */

        /* Modern input styling - no borders, subtle background */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            background: rgba(0, 0, 0, 0.03) !important;
            border: none !important;
            border-bottom: 2px solid transparent !important;
            border-radius: 8px 8px 0 0 !important;
            padding: 20px 12px 8px 12px !important;
            font-size: 15px !important;
            color: var(--text-primary) !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        [data-theme="dark"] input[type="text"],
        [data-theme="dark"] input[type="email"],
        [data-theme="dark"] input[type="tel"],
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] input[type="date"],
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Focus state - minimal accent */
        input:focus,
        textarea:focus,
        select:focus {
            outline: none !important;
            background: rgba(16, 163, 127, 0.05) !important;
            border-bottom-color: var(--brand-primary) !important;
        }

        [data-theme="dark"] input:focus,
        [data-theme="dark"] textarea:focus,
        [data-theme="dark"] select:focus {
            background: rgba(16, 163, 127, 0.1) !important;
        }

        /* Modern labels - smaller, subtle */
        label {
            font-size: 12px !important;
            font-weight: 500 !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            margin-bottom: 8px !important;
        }

        /* Upload section modern style */
        .upload-section {
            background: rgba(16, 163, 127, 0.03) !important;
            border: 2px dashed rgba(16, 163, 127, 0.2) !important;
            border-radius: 16px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .upload-section:hover {
            background: rgba(16, 163, 127, 0.05) !important;
            border-color: rgba(16, 163, 127, 0.4) !important;
            transform: translateY(-2px);
        }

        /* Modern buttons */
        button:not(.mobile-menu-btn):not(.dark-mode-toggle) {
            border-radius: 10px !important;
            font-weight: 500 !important;
            font-size: 14px !important;
            padding: 12px 24px !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            border: none;
            cursor: pointer;
        }

        button:not(.mobile-menu-btn):not(.dark-mode-toggle):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        button:not(.mobile-menu-btn):not(.dark-mode-toggle):active {
            transform: translateY(0);
        }

        /* Primary button (green) */
        button[style*="background: var(--brand-primary)"],
        button[style*="background:#10a37f"] {
            box-shadow: 0 2px 8px rgba(16, 163, 127, 0.2) !important;
        }

        /* ================================
           2025 MODERN CARDS - GLASS-MORPHISM
           ================================ */

        /* Finance Cards - Gradient backgrounds */
        .finance-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08) !important;
            border-radius: 20px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        [data-theme="dark"] .finance-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .finance-card:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.12) !important;
        }

        /* Finance amount - bigger, bolder */
        .finance-amount {
            font-size: 42px !important;
            font-weight: 800 !important;
            letter-spacing: -1px !important;
            background: linear-gradient(135deg, var(--brand-primary), #60efff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .finance-amount.expense {
            background: linear-gradient(135deg, #ef4444, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Tithe card special styling */
        .tithe-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%) !important;
            border: 1px solid rgba(139, 92, 246, 0.2) !important;
            backdrop-filter: blur(20px) !important;
        }

        [data-theme="dark"] .tithe-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(99, 102, 241, 0.08) 100%) !important;
        }

        .tithe-amount {
            font-size: 36px !important;
            font-weight: 700 !important;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Client cards modern style */
        .client-card {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(0, 0, 0, 0.06) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        [data-theme="dark"] .client-card {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
        }

        .client-card:hover {
            transform: translateY(-2px) scale(1.01) !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08) !important;
        }

        /* Search container glass effect */
        .search-container {
            background: rgba(255, 255, 255, 0.6) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.8) !important;
            border-radius: 16px !important;
            padding: 24px !important;
            margin-bottom: 24px;
        }

        [data-theme="dark"] .search-container {
            background: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Search button modern */
        .search-btn {
            background: linear-gradient(135deg, var(--brand-primary), #0d8c6d) !important;
            box-shadow: 0 4px 16px rgba(16, 163, 127, 0.3) !important;
        }

        .search-btn:hover {
            box-shadow: 0 6px 24px rgba(16, 163, 127, 0.4) !important;
        }

        /* Modals glass-morphism - Dark style matching calendar */
        #edit-appointment-modal > div,
        #client-details-modal > div,
        #reschedule-modal > div,
        #receipt-modal > div {
            background: rgba(30, 41, 59, 0.5) !important;
            backdrop-filter: blur(40px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(40px) saturate(180%) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.3) !important;
        }

        /* All text in modals should be white */
        #edit-appointment-modal > div *,
        #client-details-modal > div *,
        #reschedule-modal > div *,
        #receipt-modal > div * {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* Modal headings */
        #edit-appointment-modal h2,
        #client-details-modal h2,
        #edit-appointment-modal h3,
        #client-details-modal h3,
        #reschedule-modal h3,
        #receipt-modal h3,
        #receipt-modal h4 {
            color: rgba(255, 255, 255, 0.98) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Input fields in all modals - White thin borders */
        #edit-appointment-modal input,
        #edit-appointment-modal select,
        #edit-appointment-modal textarea,
        #reschedule-modal input,
        #reschedule-modal select,
        #reschedule-modal textarea,
        #receipt-modal input,
        #receipt-modal select,
        #receipt-modal textarea {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 6px !important;
            color: rgba(255, 255, 255, 0.95) !important;
            padding: 12px !important;
            transition: all 0.3s ease !important;
        }

        #edit-appointment-modal input:focus,
        #edit-appointment-modal select:focus,
        #edit-appointment-modal textarea:focus,
        #reschedule-modal input:focus,
        #reschedule-modal select:focus,
        #reschedule-modal textarea:focus,
        #receipt-modal input:focus,
        #receipt-modal select:focus,
        #receipt-modal textarea:focus {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            outline: none !important;
        }

        /* Labels in modals */
        #edit-appointment-modal label,
        #reschedule-modal label,
        #receipt-modal label {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500 !important;
        }

        /* Buttons in edit, reschedule, and receipt modals */
        #edit-appointment-modal button,
        #reschedule-modal button,
        #receipt-modal button {
            background: rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            color: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15) !important;
        }

        #edit-appointment-modal button:hover,
        #reschedule-modal button:hover,
        #receipt-modal button:hover {
            background: rgba(59, 130, 246, 0.35) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25) !important;
        }

        /* Close buttons (X) in modals */
        #edit-appointment-modal button[onclick*="close"],
        #reschedule-modal button[onclick*="close"],
        #receipt-modal button[onclick*="close"] {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Receipt modal inner sections with glassmorphism */
        #receipt-modal div[style*="background: var(--bg-tertiary)"],
        #receipt-modal div[style*="background: var(--bg-secondary)"],
        #receipt-client-info,
        #services-list {
            background: rgba(59, 130, 246, 0.15) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        /* Services list container and "Generar Recibo" card */
        #receipt-modal > div > div[style*="background: var(--bg-secondary)"] {
            background: rgba(59, 130, 246, 0.15) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            border: 1px solid rgba(255, 255, 255, 0.25) !important;
        }

        /* Small text and labels in receipt modal */
        #receipt-modal small,
        #receipt-modal label[style*="color: #374151"] {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* Select dropdown options - dark background for visibility */
        #receipt-modal select option,
        #edit-appointment-modal select option,
        #reschedule-modal select option {
            background: rgba(30, 41, 59, 0.95) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* Receipt preview modal styling */
        #receipt-preview-modal > div {
            background: rgba(30, 41, 59, 0.5) !important;
            backdrop-filter: blur(40px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(40px) saturate(180%) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.3) !important;
        }

        #receipt-preview-modal h3,
        #receipt-preview-modal div,
        #receipt-preview-modal button {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        #receipt-preview-modal button {
            background: rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
        }

        #receipt-preview-modal button:hover {
            background: rgba(59, 130, 246, 0.35) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
            transform: translateY(-2px);
        }

        #receipt-preview-modal button[onclick*="close"] {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        /* Mobile adjustments for all modals */
        @media (max-width: 480px) {
            #edit-appointment-modal > div,
            #reschedule-modal > div,
            #receipt-modal > div,
            #receipt-preview-modal > div {
                max-width: 95% !important;
                padding: 20px !important;
            }

            #edit-appointment-modal button,
            #reschedule-modal button,
            #receipt-modal button,
            #receipt-preview-modal button {
                font-size: 12px !important;
                padding: 10px 12px !important;
            }

            #edit-appointment-modal input,
            #edit-appointment-modal select,
            #edit-appointment-modal textarea,
            #reschedule-modal input,
            #reschedule-modal select,
            #reschedule-modal textarea,
            #receipt-modal input,
            #receipt-modal select,
            #receipt-modal textarea {
                font-size: 14px !important;
                padding: 10px !important;
            }
        }

        /* Appointment modal glassmorphism */
        #appointment-modal > div {
            background: rgba(30, 41, 59, 0.5) !important;
            backdrop-filter: blur(40px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(40px) saturate(180%) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.3) !important;
        }

        /* All text in appointment modal should be white */
        #appointment-modal > div * {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* Appointment modal headings */
        #appointment-modal h2,
        #appointment-modal h3,
        #appointment-modal h4 {
            color: rgba(255, 255, 255, 0.98) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Appointment modal buttons - Blue glassmorphism */
        #appointment-modal button {
            background: rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            color: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15) !important;
        }

        #appointment-modal button:hover {
            background: rgba(59, 130, 246, 0.35) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25) !important;
        }

        /* Close button (X) - Special styling */
        #appointment-modal button[onclick="closeAppointmentModal()"] {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 24px !important;
            padding: 0 !important;
        }

        /* Appointment details card background */
        #appointment-details-content > div[style*="background: #f9fafb"] {
            background: rgba(59, 130, 246, 0.15) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Time badge in appointment details */
        #appointment-details-content span[style*="background: #10a37f"] {
            background: rgba(59, 130, 246, 0.4) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
        }

        /* Mobile-specific appointment modal styling */
        @media (max-width: 480px) {
            #appointment-modal > div {
                max-width: 95% !important;
                padding: 20px !important;
            }

            #appointment-modal button {
                font-size: 12px !important;
                padding: 10px 12px !important;
            }
        }

        /* Content area modern background */
        .content-area {
            background: transparent !important;
        }

        /* Calendar View - Same background as landing page */
        #calendar-view {
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.4) 0%, rgba(30, 41, 59, 0.4) 100%),
                        url('./images/background.webp') center center / cover no-repeat !important;
            background-attachment: fixed !important;
        }

        /* Calendar View - Tablet adjustments */
        @media (min-width: 481px) and (max-width: 768px) {
            /* Make body use same background as calendar */
            body:has(#calendar-view:not([style*="display: none"])) {
                background: linear-gradient(135deg, rgba(15, 23, 42, 0.4) 0%, rgba(30, 41, 59, 0.4) 100%),
                            url('./images/background.webp') center center / cover no-repeat !important;
                background-attachment: fixed !important;
            }

            /* Gas price header - transparent on tablet */
            #calendar-view .gas-price-header {
                margin: 0 0 16px 0 !important;
                padding: 12px !important;
                background: transparent !important;
                backdrop-filter: none !important;
                border: none !important;
                box-shadow: none !important;
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view .gas-price-header * {
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view .calendar-header {
                margin: 0 0 16px 0 !important;
                padding: 16px !important;
                background: transparent !important;
                backdrop-filter: none !important;
                border: none !important;
                box-shadow: none !important;
            }

            #calendar-view .calendar-header * {
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view .week-range {
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view #weekly-calendar-container {
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Position mobile menu button absolutely over calendar */
            body:has(#calendar-view:not([style*="display: none"])) .mobile-menu-btn {
                position: absolute;
                top: 20px;
                z-index: 1001;
                background: rgba(30, 41, 59, 0.5);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        /* Calendar View - Mobile adjustments */
        @media (max-width: 480px) {
            /* Make body use same background as calendar */
            body:has(#calendar-view:not([style*="display: none"])) {
                background: linear-gradient(135deg, rgba(15, 23, 42, 0.4) 0%, rgba(30, 41, 59, 0.4) 100%),
                            url('./images/background.webp') center center / cover no-repeat !important;
                background-attachment: fixed !important;
            }

            /* Gas price header - transparent, minimal spacing */
            #calendar-view .gas-price-header {
                margin: 0 0 12px 0 !important;
                padding: 12px !important;
                background: transparent !important;
                backdrop-filter: none !important;
                border: none !important;
                box-shadow: none !important;
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view .gas-price-header * {
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view .calendar-header {
                margin: 0 0 12px 0 !important;
                padding: 12px !important;
                background: transparent !important;
                backdrop-filter: none !important;
                border: none !important;
                box-shadow: none !important;
            }

            #calendar-view .calendar-header * {
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view .week-range {
                color: rgba(255, 255, 255, 0.95) !important;
            }

            #calendar-view #weekly-calendar-container {
                margin: 0 !important;
                padding: 0 !important;
            }

            #calendar-view > *:first-child {
                margin-top: 0 !important;
            }

            /* Position mobile menu button absolutely over calendar */
            body:has(#calendar-view:not([style*="display: none"])) .mobile-menu-btn {
                position: absolute;
                top: 15px;
                z-index: 1001;
                background: rgba(30, 41, 59, 0.5);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        /* Calendar glassmorphism effects - Desktop only */
        @media (min-width: 769px) {
            #calendar-view .gas-price-header {
                background: rgba(30, 41, 59, 0.3) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                color: rgba(255, 255, 255, 0.95) !important;
                border-radius: 12px !important;
                margin-bottom: 16px !important;
                padding: 12px !important;
            }

            #calendar-view .gas-price-header .gas-price-display {
                color: rgba(96, 165, 250, 1) !important;
                text-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            }

            #calendar-view .calendar-header {
                background: rgba(30, 41, 59, 0.3) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                margin-bottom: 24px !important;
                padding: 24px !important;
            }
        }

        /* Desktop only - Glassmorphism for calendar week range and container */
        @media (min-width: 769px) {
            #calendar-view .week-range {
                color: rgba(255, 255, 255, 0.95) !important;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            #calendar-view #weekly-calendar-container {
                background: rgba(30, 41, 59, 0.25) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-radius: 24px !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
                padding: 24px !important;
            }
        }

        #calendar-view #weekly-calendar-grid {
            background: transparent !important;
        }

        #calendar-view .day-column {
            background: rgba(30, 41, 59, 0.4) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
        }

        #calendar-view .day-column:hover {
            background: rgba(30, 41, 59, 0.5) !important;
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18) !important;
            border-color: rgba(255, 255, 255, 0.15) !important;
        }

        #calendar-view .day-column.today {
            background: rgba(16, 163, 127, 0.15) !important;
            border-color: rgba(16, 163, 127, 0.4) !important;
            box-shadow: 0 0 0 1px rgba(16, 163, 127, 0.3), 0 8px 32px rgba(0, 0, 0, 0.12) !important;
        }

        #calendar-view .day-name,
        #calendar-view .day-number,
        #calendar-view .day-date {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #calendar-view .appointment-slot {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }

        #calendar-view .appointment-slot:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
        }

        #calendar-view .calendar-nav-btn {
            background: rgba(16, 163, 127, 0.2) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(16, 163, 127, 0.3) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }

        #calendar-view .calendar-nav-btn:hover {
            background: rgba(16, 163, 127, 0.3) !important;
            border-color: rgba(16, 163, 127, 0.5) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15) !important;
        }

        #calendar-view .gas-cost-outside {
            background: rgba(255, 255, 255, 0.12) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }

        .main-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
        }

        [data-theme="dark"] .main-content {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%) !important;
        }

        /* ================================
           2025 MODERN PAGE TRANSITIONS
           ================================ */

        .view-enter {
            animation: viewEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes viewEnter {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
                filter: blur(8px);
            }
            50% {
                opacity: 0.5;
                filter: blur(4px);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        .container {
            transition: opacity 0.3s ease-out;
        }

        /* Smooth exit for landing page */
        .landing-exit {
            animation: landingExit 0.3s cubic-bezier(0.4, 0, 1, 1) forwards;
        }

        @keyframes landingExit {
            0% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
            100% {
                opacity: 0;
                transform: scale(0.95);
                filter: blur(4px);
            }
        }

        /* Back to grid entrance */
        .landing-enter {
            animation: landingEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes landingEnter {
            0% {
                opacity: 0;
                transform: scale(1.05);
                filter: blur(8px);
            }
            100% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            .view-enter,
            .landing-exit,
            .landing-enter {
                animation: none;
            }

            @keyframes viewEnter {
                0% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }
        }
    </style>
</head>
<body>
    <!-- Hexagonal Loading Animation -->
    <div class="hex-loader-overlay" id="hex-loader" style="display: flex;">
        <div class="socket">
            <div class="gel center-gel">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c1 r1">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c2 r1">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c3 r1">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c4 r1">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c5 r1">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c6 r1">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c7 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c8 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c9 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c10 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c11 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c12 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c13 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c14 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c15 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c16 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c17 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c18 r2">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c19 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c20 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c21 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c22 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c23 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c24 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c25 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c26 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c28 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c29 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c30 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c31 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c32 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c33 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c34 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c35 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c36 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
            <div class="gel c37 r3">
                <div class="hex-brick h1"></div>
                <div class="hex-brick h2"></div>
                <div class="hex-brick h3"></div>
            </div>
        </div>
    </div>

    <!-- Landing Page with Bento Grid -->
    <div class="landing-view" id="landing-view">
        <div class="bento-grid">
            <!-- Agendar Citas - LARGE -->
            <div class="bento-item bento-item-large" onclick="navigateToView('schedule')" style="animation-delay: 0.1s">
                <div class="bento-item-content bento-item-image" style="padding: 24px; justify-content: flex-start; align-items: flex-start;">
                    <h3 style="font-size: 16px; font-weight: 600; color: rgba(255,255,255,0.95); margin-bottom: 16px; width: 100%; text-align: left;">Citas de hoy - Nov 27</h3>
                    <div style="display: flex; gap: 20px; width: 100%; align-items: center;">
                        <!-- CÃ­rculo con monto y progreso -->
                        <div class="today-amount-circle">
                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring-bg" cx="70" cy="70" r="60" />
                                <circle id="today-progress-ring" class="progress-ring-fill" cx="70" cy="70" r="60" style="stroke-dasharray: 377; stroke-dashoffset: 377;" />
                            </svg>
                            <div class="circle-content">
                                <div class="amount" id="today-total-amount">$0</div>
                                <div class="today-label">Today</div>
                            </div>
                        </div>
                        <!-- Lista de citas -->
                        <div class="appointments-list" id="today-appointments-list">
                            <div class="appointment-item" style="color: rgba(200, 200, 200, 0.6);">Cargando citas...</div>
                        </div>
                    </div>
                    <!-- Tomorrow's locations -->
                    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.15); width: 100%;">
                        <p style="line-height: 1.5;">
                            <span style="font-size: 15px; font-weight: 600; color: rgba(255, 255, 255, 0.95);">MaÃ±ana trabajas en:</span>
                            <span id="tomorrow-cities" style="display: block; margin-top: 10px; font-size: 18px; font-weight: 600; color: rgba(180, 220, 255, 0.95);">Cargando...</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Datos - MEDIUM -->
            <div class="bento-item bento-item-medium analytics-slider" onclick="navigateToView('datos')" style="animation-delay: 0.2s">
                <div class="analytics-slides">
                    <!-- Slide 1: Stats minimalistas -->
                    <div class="analytics-slide">
                        <div class="bento-item-content bento-item-text" style="padding: 24px; justify-content: space-between; align-items: flex-start; height: 100%;">
                            <div style="width: 100%;">
                                <h3 style="font-size: 10px; font-weight: 600; color: rgba(200, 200, 200, 0.7); margin-bottom: 24px; text-transform: uppercase; letter-spacing: 1.2px;">Dashboard</h3>

                                <div style="display: flex; flex-direction: column; gap: 24px; width: 100%;">
                                    <!-- Total Clientes -->
                                    <div>
                                        <div style="font-size: 8px; color: rgba(200, 200, 200, 0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">Total Clientes</div>
                                        <div id="bento-total-clients" style="font-size: 36px; font-weight: 700; color: rgba(255, 255, 255, 0.95); line-height: 1;">0</div>
                                    </div>

                                    <!-- Citas del Mes -->
                                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                        <span style="font-size: 9px; color: rgba(200, 200, 200, 0.7); text-transform: uppercase; letter-spacing: 0.8px;">Citas este mes</span>
                                        <span id="bento-monthly-appts" style="font-size: 22px; font-weight: 700; color: rgba(255, 255, 255, 0.9);">0</span>
                                    </div>

                                    <!-- Ciudades -->
                                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                        <span style="font-size: 9px; color: rgba(200, 200, 200, 0.7); text-transform: uppercase; letter-spacing: 0.8px;">Ciudades activas</span>
                                        <span id="bento-active-cities" style="font-size: 22px; font-weight: 700; color: rgba(255, 255, 255, 0.9);">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Servicios - Footer -->
                            <div style="width: 100%; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="font-size: 9px; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">Servicios Ofrecidos</div>
                                <div id="bento-total-services" style="font-size: 24px; font-weight: 700; color: rgba(255, 255, 255, 0.95); line-height: 1;">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Slide 2: Logo moderno de datos -->
                    <div class="analytics-slide">
                        <div class="bento-item-content" style="padding: 24px; justify-content: center; align-items: center; background: rgba(59, 130, 246, 0.15); backdrop-filter: blur(10px); height: 100%;">
                            <!-- Logo moderno de base de datos -->
                            <div style="position: relative; width: 110px; height: 110px;">
                                <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                    <!-- Capas de base de datos (cilindros) -->
                                    <!-- Capa 1 (arriba) -->
                                    <ellipse cx="50" cy="25" rx="30" ry="8" fill="none" stroke="rgba(255, 255, 255, 0.5)" stroke-width="2"/>
                                    <path d="M 20 25 L 20 35 Q 20 40, 50 40 Q 80 40, 80 35 L 80 25"
                                          fill="rgba(255, 255, 255, 0.15)" stroke="rgba(255, 255, 255, 0.5)" stroke-width="2"/>

                                    <!-- Capa 2 (medio) -->
                                    <ellipse cx="50" cy="45" rx="30" ry="8" fill="none" stroke="rgba(255, 255, 255, 0.6)" stroke-width="2"/>
                                    <path d="M 20 45 L 20 55 Q 20 60, 50 60 Q 80 60, 80 55 L 80 45"
                                          fill="rgba(255, 255, 255, 0.2)" stroke="rgba(255, 255, 255, 0.6)" stroke-width="2"/>

                                    <!-- Capa 3 (abajo) -->
                                    <ellipse cx="50" cy="65" rx="30" ry="8" fill="none" stroke="rgba(255, 255, 255, 0.7)" stroke-width="2"/>
                                    <path d="M 20 65 L 20 75 Q 20 80, 50 80 Q 80 80, 80 75 L 80 65"
                                          fill="rgba(255, 255, 255, 0.25)" stroke="rgba(255, 255, 255, 0.7)" stroke-width="2"/>

                                    <!-- Puntos de datos (decorativos) -->
                                    <circle cx="50" cy="30" r="2" fill="rgba(255, 255, 255, 0.8)">
                                        <animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/>
                                    </circle>
                                    <circle cx="45" cy="50" r="2" fill="rgba(255, 255, 255, 0.8)">
                                        <animate attributeName="opacity" values="1;0.6;1" dur="2.5s" repeatCount="indefinite"/>
                                    </circle>
                                    <circle cx="55" cy="70" r="2" fill="rgba(255, 255, 255, 0.8)">
                                        <animate attributeName="opacity" values="0.6;1;0.6" dur="3s" repeatCount="indefinite"/>
                                    </circle>
                                </svg>
                            </div>
                            <h2 style="font-size: 16px; font-weight: 600; color: rgba(255, 255, 255, 1); margin-top: 16px; letter-spacing: 0.5px;">Datos</h2>
                            <p style="font-size: 9px; color: rgba(255, 255, 255, 0.7); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px;">Dashboard</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendario - SMALL -->
            <div class="bento-item bento-item-small calendar-slider" onclick="navigateToView('calendar')" style="animation-delay: 0.3s">
                <div class="calendar-slides">
                    <!-- Slide 1: Calendar con nÃºmeros -->
                    <div class="calendar-slide active">
                        <div class="bento-item-content bento-item-accent" style="padding: 16px 16px 28px 16px; justify-content: flex-start; align-items: flex-start;">
                            <h3 style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.95); margin-bottom: 6px; width: 100%; text-align: left; letter-spacing: 0.3px;">November 2025</h3>
                            <div class="mini-calendar">
                                <div class="mini-calendar-days">
                                    <div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div><div>S</div>
                                </div>
                                <div class="mini-calendar-dates">
                                    <div></div><div></div><div></div><div></div><div></div><div>1</div><div>2</div>
                                    <div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
                                    <div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div>
                                    <div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div>
                                    <div>24</div><div>25</div><div>26</div><div class="today">27</div><div>28</div><div>29</div><div>30</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Slide 2: Icono de calendario -->
                    <div class="calendar-slide">
                        <div class="bento-item-content" style="padding: 24px; justify-content: center; align-items: center; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px);">
                            <svg class="calendar-icon-large" viewBox="0 0 24 24" style="width: 80px; height: 80px; fill: rgba(60, 60, 60, 0.85);">
                                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                            </svg>
                            <h2 style="font-size: 18px; font-weight: 600; color: rgba(60, 60, 60, 0.95); margin-top: 12px;">Calendar</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finanzas - MEDIUM -->
            <div class="bento-item bento-item-medium" onclick="navigateToView('finance')" style="animation-delay: 0.4s">
                <div class="bento-item-content bento-item-image" style="padding: 24px; justify-content: center; align-items: center;">
                    <!-- Logo moderno -->
                    <div style="position: relative; width: 100px; height: 100px;">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <!-- CÃ­rculo exterior -->
                            <circle cx="50" cy="50" r="48" fill="none" stroke="rgba(16, 163, 127, 0.2)" stroke-width="2"/>
                            <!-- CÃ­rculo interior -->
                            <circle cx="50" cy="50" r="40" fill="rgba(16, 163, 127, 0.15)"/>
                            <!-- GrÃ¡fica de tendencia -->
                            <path d="M 25 60 L 35 50 L 45 55 L 55 40 L 65 45 L 75 35"
                                  fill="none"
                                  stroke="rgba(16, 163, 127, 1)"
                                  stroke-width="3"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"/>
                            <!-- Puntos en la grÃ¡fica -->
                            <circle cx="35" cy="50" r="3" fill="rgba(16, 163, 127, 1)"/>
                            <circle cx="55" cy="40" r="3" fill="rgba(16, 163, 127, 1)"/>
                            <circle cx="75" cy="35" r="3" fill="rgba(16, 163, 127, 1)"/>
                        </svg>
                    </div>
                    <h2 class="bento-title" style="color: rgba(16, 163, 127, 1);">Finanzas</h2>
                    <p class="bento-description" style="color: rgba(16, 163, 127, 0.7);">Control financiero</p>
                </div>
            </div>

            <!-- Registro - SMALL -->
            <div class="bento-item bento-item-small registry-slider" onclick="navigateToView('history')" style="animation-delay: 0.5s">
                <div class="registry-slides">
                    <!-- Slide 1: Client Registry Stats -->
                    <div class="registry-slide">
                        <div class="bento-item-content bento-item-text" style="padding: 16px; justify-content: space-between; align-items: flex-start; height: 100%;">
                            <div style="width: 100%;">
                                <h3 style="font-size: 11px; font-weight: 600; color: rgba(200, 200, 200, 0.7); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Registro</h3>

                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 8px; color: rgba(200, 200, 200, 0.6); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px;">Total Clientes</div>
                                    <div id="registry-total-clients" style="font-size: 32px; font-weight: 700; color: rgba(255, 255, 255, 0.95); line-height: 1;">0</div>
                                </div>
                            </div>

                            <div style="width: 100%; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px;">
                                    <span style="font-size: 8px; color: rgba(200, 200, 200, 0.7); text-transform: uppercase; letter-spacing: 0.8px;">Nuevos este mes</span>
                                    <span id="registry-new-clients" style="font-size: 20px; font-weight: 700; color: rgba(255, 255, 255, 0.9);">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Slide 2: Logo -->
                    <div class="registry-slide">
                        <div class="bento-item-content" style="padding: 16px; justify-content: center; align-items: center; background: rgba(139, 92, 246, 0.15); backdrop-filter: blur(10px); height: 100%;">
                            <!-- Logo de registro/usuarios -->
                            <div style="position: relative; width: 70px; height: 70px;">
                                <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                                    <!-- Personas/usuarios en grupo -->
                                    <!-- Usuario 1 (atrÃ¡s izquierda) -->
                                    <circle cx="35" cy="35" r="12" fill="rgba(255, 255, 255, 0.2)" stroke="rgba(255, 255, 255, 0.5)" stroke-width="2"/>
                                    <path d="M 20 60 Q 20 45, 35 45 Q 50 45, 50 60" fill="rgba(255, 255, 255, 0.2)" stroke="rgba(255, 255, 255, 0.5)" stroke-width="2"/>

                                    <!-- Usuario 2 (atrÃ¡s derecha) -->
                                    <circle cx="65" cy="35" r="12" fill="rgba(255, 255, 255, 0.25)" stroke="rgba(255, 255, 255, 0.6)" stroke-width="2"/>
                                    <path d="M 50 60 Q 50 45, 65 45 Q 80 45, 80 60" fill="rgba(255, 255, 255, 0.25)" stroke="rgba(255, 255, 255, 0.6)" stroke-width="2"/>

                                    <!-- Usuario principal (adelante centro) -->
                                    <circle cx="50" cy="50" r="15" fill="rgba(255, 255, 255, 0.3)" stroke="rgba(255, 255, 255, 0.8)" stroke-width="2.5"/>
                                    <path d="M 30 85 Q 30 65, 50 65 Q 70 65, 70 85" fill="rgba(255, 255, 255, 0.3)" stroke="rgba(255, 255, 255, 0.8)" stroke-width="2.5"/>
                                </svg>
                            </div>
                            <h2 style="font-size: 13px; font-weight: 600; color: rgba(255, 255, 255, 1); margin-top: 12px; letter-spacing: 0.5px;">Registro</h2>
                            <p style="font-size: 7px; color: rgba(255, 255, 255, 0.7); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.8px;">Clientes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mensajes - SMALL -->
            <div class="bento-item bento-item-small" onclick="navigateToView('messages')" style="animation-delay: 0.6s">
                <div class="bento-item-content" style="padding: 16px; justify-content: center; align-items: center; background: rgba(34, 197, 94, 0.12); backdrop-filter: blur(10px); height: 100%;">
                    <!-- Logo de mensajes/chat -->
                    <div style="position: relative; width: 70px; height: 70px;">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <!-- Burbuja principal de mensaje -->
                            <rect x="15" y="25" width="60" height="40" rx="8" fill="rgba(255, 255, 255, 0.25)" stroke="rgba(255, 255, 255, 0.6)" stroke-width="2.5"/>
                            <!-- Cola de la burbuja -->
                            <path d="M 25 65 L 20 75 L 30 65" fill="rgba(255, 255, 255, 0.25)" stroke="rgba(255, 255, 255, 0.6)" stroke-width="2.5" stroke-linejoin="round"/>

                            <!-- LÃ­neas de texto dentro del mensaje -->
                            <line x1="25" y1="35" x2="60" y2="35" stroke="rgba(255, 255, 255, 0.7)" stroke-width="2" stroke-linecap="round"/>
                            <line x1="25" y1="45" x2="55" y2="45" stroke="rgba(255, 255, 255, 0.7)" stroke-width="2" stroke-linecap="round"/>
                            <line x1="25" y1="55" x2="50" y2="55" stroke="rgba(255, 255, 255, 0.6)" stroke-width="2" stroke-linecap="round"/>

                            <!-- Burbuja secundaria (mÃ¡s pequeÃ±a, arriba derecha) -->
                            <circle cx="70" cy="25" r="8" fill="rgba(255, 255, 255, 0.2)" stroke="rgba(255, 255, 255, 0.5)" stroke-width="2"/>
                            <circle cx="68" cy="23" r="1.5" fill="rgba(255, 255, 255, 0.8)"/>
                            <circle cx="72" cy="23" r="1.5" fill="rgba(255, 255, 255, 0.8)"/>
                            <path d="M 67 27 Q 70 29, 73 27" stroke="rgba(255, 255, 255, 0.8)" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2 style="font-size: 13px; font-weight: 600; color: rgba(255, 255, 255, 1); margin-top: 12px; letter-spacing: 0.5px;">Mensajes</h2>
                    <p style="font-size: 7px; color: rgba(255, 255, 255, 0.7); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.8px;">Templates</p>
                </div>
            </div>

            <!-- ConfiguraciÃ³n - SMALL -->
            <div class="bento-item bento-item-small" onclick="navigateToView('settings')" style="animation-delay: 0.7s">
                <div class="bento-item-content" style="padding: 16px; justify-content: center; align-items: center; background: rgba(99, 102, 241, 0.12); backdrop-filter: blur(10px); height: 100%;">
                    <!-- Logo de configuraciÃ³n/settings -->
                    <div style="position: relative; width: 70px; height: 70px;">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <!-- Slider 1 (arriba) -->
                            <line x1="20" y1="30" x2="80" y2="30" stroke="rgba(255, 255, 255, 0.4)" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="60" cy="30" r="7" fill="rgba(255, 255, 255, 0.9)" stroke="rgba(255, 255, 255, 1)" stroke-width="2"/>

                            <!-- Slider 2 (medio) -->
                            <line x1="20" y1="50" x2="80" y2="50" stroke="rgba(255, 255, 255, 0.4)" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="35" cy="50" r="7" fill="rgba(255, 255, 255, 0.9)" stroke="rgba(255, 255, 255, 1)" stroke-width="2"/>

                            <!-- Slider 3 (abajo) -->
                            <line x1="20" y1="70" x2="80" y2="70" stroke="rgba(255, 255, 255, 0.4)" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="55" cy="70" r="7" fill="rgba(255, 255, 255, 0.9)" stroke="rgba(255, 255, 255, 1)" stroke-width="2"/>
                        </svg>
                    </div>
                    <h2 style="font-size: 13px; font-weight: 600; color: rgba(255, 255, 255, 1); margin-top: 12px; letter-spacing: 0.5px;">ConfiguraciÃ³n</h2>
                    <p style="font-size: 7px; color: rgba(255, 255, 255, 0.7); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.8px;">Ajustes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Bento Grid button (replaces mobile menu button when in a section) -->
    <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="returnToBentoGrid()">
        <svg id="menu-icon" viewBox="0 0 24 24" fill="currentColor">
            <!-- Back arrow icon -->
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
    </button>

    <!-- Mobile overlay -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="mobile-sidebar">
            <div class="sidebar-header">
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                    </svg>
                    Agendar Citas
                </div>
                <div class="menu-item">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2-7h-3V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                    </svg>
                    Calendario
                </div>
                <div class="menu-item">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V7h10v2z"/>
                    </svg>
                    Registro
                </div>
                <div class="menu-item">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h2v2H7V7zm4 0h6v2h-6V7zm-4 4h2v2H7v-2zm4 0h6v2h-6v-2zm-4 4h2v2H7v-2zm4 0h6v2h-6v-2z"></path>
                    </svg>
                    Datos
                </div>
                <div class="menu-item">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    Finanzas
                </div>
                <div class="menu-item">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>
                    </svg>
                    Mensajes
                </div>
                <div class="menu-item">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                    ConfiguraciÃ³n
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Agendamiento Inteligente</h1>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="current-datetime" id="datetime"></div>
                    <div class="status-indicator sync-status" id="sync-status" title="Online">
                        <svg class="status-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        </svg>
                        <span class="status-text">Online</span>
                    </div>
                    <div class="status-indicator backup-status" id="backup-status" 
                         onclick="BackupSystem.downloadBackup()" title="Backup">
                        <svg class="status-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM8 15.01l1.41 1.41L11 14.84V19h2v-4.16l1.59 1.59L16 15.01 12.01 11 8 15.01z"/>
                        </svg>
                        <span class="status-text">Never backed up</span>
                    </div>
                    <button class="status-indicator dark-mode-toggle" id="dark-mode-toggle" onclick="toggleDarkMode()" title="Theme">
                        <svg class="theme-icon light-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                        </svg>
                        <svg class="theme-icon dark-icon" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                            <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="content-area">
                <!-- Upload Section -->
                <div class="upload-section" id="upload-area">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17,8 12,3 7,8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <div style="flex: 1;">
                        <span style="color: var(--text-upload); font-weight: 500; font-size: 14px;">Subir imÃ¡genes</span>
                        <span style="color: var(--text-upload-light); font-size: 13px; margin-left: 8px;">o arrastra aquÃ­</span>
                    </div>
                    <button class="upload-btn" onclick="document.getElementById('file-input').click()" style="padding: 8px 16px; font-size: 13px;">
                        Seleccionar
                    </button>
                    <input type="file" id="file-input" accept="image/*" multiple>
                </div>

                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loading-text">Procesando imÃ¡genes y extrayendo datos...</p>
                </div>

                <!-- Preview Section -->
                <div class="preview-section" id="preview-section">
                    <h3>ImÃ¡genes cargadas:</h3>
                    <div class="images-grid" id="images-grid">
                        <!-- Images will be dynamically added here -->
                    </div>
                    <div class="preview-actions">
                        <button type="button" class="clear-images-btn" onclick="clearAllImages()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                            Limpiar todas
                        </button>
                    </div>
                </div>

                <!-- Form Section -->
                <div class="form-section">
                    <h3>Datos de la cita</h3>
                    <form id="appointment-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="name">Nombre completo</label>
                                <input type="text" id="name" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="time">Hora</label>
                                <select id="time" name="time" required>
                                    <option value="">Seleccionar hora</option>
                                    <option value="07:00">7:00 AM</option>
                                    <option value="07:30">7:30 AM</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="08:30">8:30 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="09:30">9:30 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="10:30">10:30 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="11:30">11:30 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="12:30">12:30 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="13:30">1:30 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="14:30">2:30 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="15:30">3:30 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="16:30">4:30 PM</option>
                                    <option value="17:00">5:00 PM</option>
                                    <option value="17:30">5:30 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                    <option value="18:30">6:30 PM</option>
                                    <option value="19:00">7:00 PM</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="city">Ciudad</label>
                                <select id="city" name="city" required>
                                    <option value="">Seleccionar ciudad</option>
                                    <option value="Alpine">Alpine</option>
                                    <option value="American Fork">American Fork</option>
                                    <option value="Bluffdale">Bluffdale</option>
                                    <option value="Bountiful">Bountiful</option>
                                    <option value="Cedar Hills">Cedar Hills</option>
                                    <option value="Cottonwood Heights">Cottonwood Heights</option>
                                    <option value="Draper">Draper</option>
                                    <option value="Eagle Mountain">Eagle Mountain</option>
                                    <option value="Elk Ridge">Elk Ridge</option>
                                    <option value="Herriman">Herriman</option>
                                    <option value="Highland">Highland</option>
                                    <option value="Holladay">Holladay</option>
                                    <option value="Kearns">Kearns</option>
                                    <option value="Lehi">Lehi</option>
                                    <option value="Lindon">Lindon</option>
                                    <option value="Mapleton">Mapleton</option>
                                    <option value="Midvale">Midvale</option>
                                    <option value="Millcreek">Millcreek</option>
                                    <option value="Murray">Murray</option>
                                    <option value="North Salt Lake">North Salt Lake</option>
                                    <option value="Orem">Orem</option>
                                    <option value="Payson">Payson</option>
                                    <option value="Pleasant Grove">Pleasant Grove</option>
                                    <option value="Provo">Provo</option>
                                    <option value="Riverton">Riverton</option>
                                    <option value="Salem">Salem</option>
                                    <option value="Salt Lake City">Salt Lake City</option>
                                    <option value="Sandy">Sandy</option>
                                    <option value="Santaquin">Santaquin</option>
                                    <option value="Saratoga Springs">Saratoga Springs</option>
                                    <option value="South Jordan">South Jordan</option>
                                    <option value="South Salt Lake">South Salt Lake</option>
                                    <option value="Spanish Fork">Spanish Fork</option>
                                    <option value="Springville">Springville</option>
                                    <option value="Taylorsville">Taylorsville</option>
                                    <option value="West Jordan">West Jordan</option>
                                    <option value="West Valley City">West Valley City</option>
                                    <option value="Woodland Hills">Woodland Hills</option>
                                    <option value="Woods Cross">Woods Cross</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="address">DirecciÃ³n</label>
                                <input type="text" id="address" name="address" required>
                            </div>
                            <div class="form-group">
                                <label for="job">Tipo de Trabajo</label>
                                <div class="custom-dropdown" id="job-dropdown">
                                    <div class="dropdown-header" onclick="toggleJobDropdown()">
                                        <span id="job-placeholder">Seleccionar trabajo</span>
                                        <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="6,9 12,15 18,9"></polyline>
                                        </svg>
                                    </div>
                                    <div class="dropdown-list" id="job-list">
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-alfombras" value="alfombras">
                                            <label for="job-alfombras">Alfombras</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-sillones" value="sillones">
                                            <label for="job-sillones">Sillones</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-escaleras" value="escaleras">
                                            <label for="job-escaleras">Escaleras</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-cuartos" value="cuartos">
                                            <label for="job-cuartos">Cuartos</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-sala" value="sala">
                                            <label for="job-sala">Sala</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-pasillo" value="pasillo">
                                            <label for="job-pasillo">Pasillo</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-sillas" value="sillas">
                                            <label for="job-sillas">Sillas</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-colchon" value="colchon">
                                            <label for="job-colchon">ColchÃ³n</label>
                                        </div>
                                        <div class="dropdown-item">
                                            <input type="checkbox" id="job-auto" value="auto">
                                            <label for="job-auto">Auto</label>
                                        </div>
                                    </div>
                                </div>
                                <!-- Hidden select for form submission -->
                                <select id="job" name="job" multiple style="display: none;">
                                    <option value="alfombras">Alfombras</option>
                                    <option value="sillones">Sillones</option>
                                    <option value="escaleras">Escaleras</option>
                                    <option value="cuartos">Cuartos</option>
                                    <option value="sala">Sala</option>
                                    <option value="pasillo">Pasillo</option>
                                    <option value="sillas">Sillas</option>
                                    <option value="colchon">ColchÃ³n</option>
                                    <option value="auto">Auto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="price">Precio</label>
                                <select id="price" name="price" required>
                                    <option value="">Seleccionar precio</option>
                                    <option value="50">$50</option>
                                    <option value="60">$60</option>
                                    <option value="70">$70</option>
                                    <option value="80">$80</option>
                                    <option value="90">$90</option>
                                    <option value="100">$100</option>
                                    <option value="110">$110</option>
                                    <option value="120">$120</option>
                                    <option value="130">$130</option>
                                    <option value="140">$140</option>
                                    <option value="150">$150</option>
                                    <option value="160">$160</option>
                                    <option value="170">$170</option>
                                    <option value="180">$180</option>
                                    <option value="190">$190</option>
                                    <option value="200">$200</option>
                                    <option value="250">$250</option>
                                    <option value="300">$300</option>
                                    <option value="350">$350</option>
                                    <option value="400">$400</option>
                                    <option value="450">$450</option>
                                    <option value="500">$500</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="date">Fecha</label>
                                <input type="date" id="date" name="date" required>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn" id="submit-btn">Agendar Cita</button>
                    </form>
                </div>

                <!-- Success Message -->
                <div class="success-message" id="success-message">
                    Â¡Cita agendada exitosamente!
                </div>

                <!-- Error Message -->
                <div class="error-message" id="error-message">
                    Error al procesar la solicitud. IntÃ©ntalo de nuevo.
                </div>
            </div>

            <!-- Calendar View (Hidden by default) -->
            <div class="content-area" id="calendar-view" style="display: none;">
                <div class="gas-price-header" style="text-align: center; font-weight: 600;">
                    Precio de Gasolina Hoy en Utah: <span style="color: var(--gas-price-value);" class="gas-price-display">$3.32</span>/<span style="color: var(--gas-price-unit);">galÃ³n</span> <span style="font-size: 12px; color: var(--gas-price-status);">(actualizando...)</span>
                </div>
                
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button onclick="changeWeek(-1)" class="calendar-nav-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15,18 9,12 15,6"></polyline>
                            </svg>
                            Anterior
                        </button>
                        <span id="current-week-range" class="week-range"></span>
                        <button onclick="changeWeek(1)" class="calendar-nav-btn">
                            Siguiente
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9,18 15,12 9,6"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="weekly-calendar-container">
                    <div id="weekly-calendar-grid">
                        <!-- Weekly calendar will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Receipt Preview Modal (New simplified workflow) -->
            <div id="receipt-preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1003; align-items: center; justify-content: center;">
                <div style="background: var(--modal-bg); border-radius: 12px; padding: 0; max-width: 800px; width: 95%; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px 24px 0 24px;">
                        <h3 style="margin: 0; color: var(--text-primary);">ðŸ§¾ Receipt Preview</h3>
                        <button onclick="closeReceiptPreview()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-close-btn);">Ã—</button>
                    </div>

                    <!-- Receipt Content Area -->
                    <div style="flex: 1; overflow-y: auto; padding: 20px 24px;">
                        <div id="receipt-preview-content" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                            <!-- Receipt HTML will be generated here -->
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="padding: 20px 24px; border-top: 1px solid var(--border-color); background: var(--bg-tertiary);">
                        <div class="action-buttons" style="display: flex; gap: 12px; align-items: center;">
                            <button onclick="closeReceiptPreview()" style="background: var(--bg-tertiary); color: var(--text-primary); border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                â† Back to Edit
                            </button>
                            <button onclick="downloadReceiptPDF()" style="background: var(--button-purple); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; width: 100%;">
                                ðŸ“„ Download Mobile PDF
                            </button>
                        </div>
                        <div style="margin-top: 8px; text-align: center; color: var(--text-muted); font-size: 12px;">
                            Review your receipt above, then download as PDF to share
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointment Details Modal -->
            <div id="appointment-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--modal-bg); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Detalles de la Cita</h3>
                        <button onclick="closeAppointmentModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-close-btn);">Ã—</button>
                    </div>
                    <div id="appointment-details-content">
                        <!-- Appointment details will be loaded here -->
                    </div>
                    <!-- Action buttons - 2x2 layout -->
                    <div style="margin-top: 20px;">
                        <!-- Top row -->
                        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                            <button onclick="editAppointment()" style="background: var(--brand-secondary); color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; flex: 1; font-size: 13px; font-weight: 500;">Editar</button>
                            <button onclick="rescheduleAppointment()" style="background: var(--brand-primary); color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; flex: 1; font-size: 13px; font-weight: 500;">Reagendar</button>
                        </div>
                        <!-- Bottom row -->
                        <div style="display: flex; gap: 12px;">
                            <button onclick="generateReceiptModal()" style="background: var(--button-purple); color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; flex: 1; font-size: 13px; font-weight: 500;">Recibo</button>
                            <button onclick="deleteAppointment()" style="background: var(--button-danger); color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; flex: 1; font-size: 13px; font-weight: 500;">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Generation Modal -->
            <div id="receipt-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002; align-items: center; justify-content: center;">
                <div style="background: var(--modal-bg); border-radius: 12px; padding: 24px; max-width: 500px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">ðŸ“„ Generate Detailed Receipt</h3>
                        <button onclick="closeReceiptModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-close-btn);">Ã—</button>
                    </div>
                    
                    <!-- Client Info Preview -->
                    <div id="receipt-client-info" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--button-purple);">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <!-- Service Selection Section -->
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                        <h4 style="margin: 0 0 16px 0; color: var(--text-primary);">ðŸ› ï¸ Services Performed</h4>
                        
                        <div style="display: grid; gap: 12px; margin-bottom: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Service Type:</label>
                                    <select id="service-type" onchange="updateServicePrice()" style="width: 100%; padding: 8px; border: 1px solid var(--border-input); border-radius: 4px; background: var(--bg-input); color: var(--text-tertiary);">
                                        <option value="">Select service</option>
                                        <option value="Bedrooms">Bedrooms - $30 each</option>
                                        <option value="Hallways">Hallways - $10 - $30</option>
                                        <option value="Living Rooms">Living Rooms - $30 - $60</option>
                                        <option value="Stairs">Stairs - $45 - $55</option>
                                        <option value="Odor Removal">Odor Removal - $20 per area</option>
                                        <option value="1-Seat Chair">1-Seat Chair - $35</option>
                                        <option value="2-Seat Loveseat">2-Seat Loveseat - $65</option>
                                        <option value="3-Seat Sofa">3-Seat Sofa - $85</option>
                                        <option value="Sectionals">Sectionals - From $100</option>
                                        <option value="Dining Chairs">Dining Chairs - $10 each</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Quantity:</label>
                                    <input type="number" id="service-quantity" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid var(--border-input); border-radius: 4px; background: var(--bg-input); color: var(--text-tertiary);">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Unit Price:</label>
                                    <input type="number" id="service-price" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-input); border-radius: 4px; background: var(--bg-input); color: var(--text-tertiary);">
                                    <small style="color: var(--text-muted); font-size: 12px;" id="price-suggestion">Adjust price based on actual work performed</small>
                                </div>
                                <button onclick="addDetailedService()" style="background: var(--brand-primary); color: white; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; white-space: nowrap;">Add</button>
                            </div>
                        </div>
                        
                        <!-- Services List -->
                        <div style="background: var(--bg-secondary); border-radius: 6px; border: 1px solid var(--border-color); overflow: hidden;">
                            <div style="background: var(--bg-tertiary); padding: 8px 12px; font-weight: 600; font-size: 13px; color: var(--text-tertiary); border-bottom: 1px solid var(--border-color);">
                                Added Services
                            </div>
                            <div id="services-list" style="min-height: 60px; padding: 12px;">
                                <div style="color: var(--text-muted); text-align: center; padding: 20px; font-style: italic;">
                                    No services added yet
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generar Recibo -->
                    <div style="background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: var(--text-primary);">ðŸ“„ Generar Recibo</h4>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">NÃºmero del cliente:</label>
                            <input type="tel" id="phone-number" placeholder="Ej: 8015551234" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            <small style="color: #6b7280; font-size: 12px;">Solo nÃºmeros, sin espacios ni guiones (formato: 8015551234)</small>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button onclick="generateReceiptOnly()" style="background: #10b981; color: white; border: none; padding: 16px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                ðŸ“„ Generar Recibo
                            </button>
                            <button onclick="closeReceiptModal()" style="background: var(--bg-tertiary); color: var(--text-primary); border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reschedule Modal -->
            <div id="reschedule-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center;">
                <div style="background: var(--modal-bg); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0; color: var(--text-primary);">Reagendar Cita</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">Nueva Fecha:</label>
                        <input type="date" id="reschedule-date" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">Nueva Hora:</label>
                        <select id="reschedule-time" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);">
                            <option value="">Seleccionar hora</option>
                            <option value="07:00">7:00 AM</option>
                            <option value="07:30">7:30 AM</option>
                            <option value="08:00">8:00 AM</option>
                            <option value="08:30">8:30 AM</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="09:30">9:30 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="10:30">10:30 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="11:30">11:30 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="12:30">12:30 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="13:30">1:30 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="14:30">2:30 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="15:30">3:30 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="16:30">4:30 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="17:30">5:30 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="18:30">6:30 PM</option>
                            <option value="19:00">7:00 PM</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeRescheduleModal()" style="background: var(--bg-tertiary); color: var(--text-tertiary); border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; flex: 1;">Cancelar</button>
                        <button onclick="confirmReschedule()" style="background: var(--brand-primary); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; flex: 1;">Confirmar</button>
                    </div>
                </div>
            </div>

            <!-- Edit Appointment Modal -->
            <div id="edit-appointment-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center;">
                <div style="background: var(--modal-bg); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Editar Cita</h3>
                        <button onclick="closeEditAppointmentModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>

                    <form id="edit-appointment-form">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">Nombre del Cliente:</label>
                            <input type="text" id="edit-client-name" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);" required>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">TelÃ©fono:</label>
                            <input type="tel" id="edit-client-phone" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);">
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">Ciudad:</label>
                            <input type="text" id="edit-client-city" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);" required>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">DirecciÃ³n:</label>
                            <input type="text" id="edit-client-address" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);" required>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">Fecha:</label>
                            <input type="date" id="edit-appointment-date" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);" required>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">Hora:</label>
                            <select id="edit-appointment-time" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);" required>
                                <option value="">Seleccionar hora</option>
                                <option value="07:00">7:00 AM</option>
                                <option value="07:30">7:30 AM</option>
                                <option value="08:00">8:00 AM</option>
                                <option value="08:30">8:30 AM</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="09:30">9:30 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="10:30">10:30 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="11:30">11:30 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="12:30">12:30 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="13:30">1:30 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="14:30">2:30 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="15:30">3:30 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="16:30">4:30 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="17:30">5:30 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="18:30">6:30 PM</option>
                                <option value="19:00">7:00 PM</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">Tipo de Trabajo:</label>
                            <input type="text" id="edit-appointment-job" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);" required>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-tertiary);">Precio:</label>
                            <input type="number" id="edit-appointment-price" step="0.01" min="0" style="width: 100%; padding: 12px; border: 1px solid var(--border-input); border-radius: 6px; background: var(--bg-input); color: var(--text-tertiary);" required>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button type="button" onclick="closeEditAppointmentModal()" style="background: var(--bg-tertiary); color: var(--text-tertiary); border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; flex: 1;">Cancelar</button>
                            <button type="submit" style="background: var(--brand-primary); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; flex: 1;">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Client Details Modal -->
            <div id="client-details-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center;">
                <div style="background: var(--modal-bg); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Detalles del Cliente</h3>
                        <button onclick="closeClientDetailsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    <div id="client-details-content">
                        <!-- Client details will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- History View (Hidden by default) -->
            <!-- Registry View -->
            <div class="content-area" id="history-view" style="display: none;">
                <div class="registry-header">
                    <h1 class="registry-title">Registro de Clientes</h1>
                </div>

                <div class="search-container">
                    <div class="search-grid">
                        <div class="search-field">
                            <label for="search-name">Buscar Cliente</label>
                            <input type="text" id="search-name" class="search-input" placeholder="Nombre del cliente...">
                        </div>
                        <div class="search-field">
                            <label for="search-city">Ciudad</label>
                            <select id="search-city" class="search-select">
                                <option value="">Todas las ciudades</option>
                            </select>
                        </div>
                        <div class="search-field">
                            <label for="search-job">Tipo de Trabajo</label>
                            <select id="search-job" class="search-select">
                                <option value="">Todos los trabajos</option>
                                <option value="alfombras">Alfombras</option>
                                <option value="sillones">Sillones</option>
                                <option value="escaleras">Escaleras</option>
                                <option value="cuartos">Cuartos</option>
                                <option value="sala">Sala</option>
                                <option value="pasillo">Pasillo</option>
                                <option value="sillas">Sillas</option>
                                <option value="colchon">ColchÃ³n</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                        <button class="search-btn" onclick="searchClients()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="M21 21l-4.35-4.35"></path>
                            </svg>
                            Buscar
                        </button>
                    </div>
                </div>

                <div class="clients-container">
                    <div class="clients-grid" id="clients-grid">
                        <!-- Client cards will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Finance View -->
            <div class="content-area" id="finance-view" style="display: none;">
                <div class="finance-header">
                    <h1 class="finance-title">Finanzas</h1>
                    <div class="current-month">
                        <span id="current-month-label">Septiembre 2024</span>
                    </div>
                </div>

                <!-- Weekly Summary -->
                <div class="weekly-finance-section">
                    <h2>Resumen Semanal</h2>
                    <div class="weekly-grid" id="weekly-grid">
                        <!-- Weekly cards will be generated here -->
                    </div>
                </div>

                <!-- Monthly Summary -->
                <div class="monthly-finance-section">
                    <h2>Resumen Mensual</h2>
                    <div class="monthly-summary-grid">
                        <div class="finance-card total-income">
                            <div class="finance-card-header">
                                <h3>Ingresos Brutos</h3>
                            </div>
                            <div class="finance-amount" id="monthly-gross-income">$0.00</div>
                        </div>

                        <div class="finance-card gas-expense">
                            <div class="finance-card-header">
                                <h3>Gasolina</h3>
                            </div>
                            <div class="finance-amount expense" id="monthly-gas-expense">-$0.00</div>
                        </div>

                        <div class="finance-card advertising-expense">
                            <div class="finance-card-header">
                                <h3>Publicidad</h3>
                                <small>$45/semana</small>
                            </div>
                            <div class="finance-amount expense" id="monthly-advertising-expense">-$0.00</div>
                        </div>

                        <div class="finance-card net-income">
                            <div class="finance-card-header">
                                <h3>Ganancia Neta</h3>
                            </div>
                            <div class="finance-amount" id="monthly-net-income">$0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Tithe Section -->
                <div class="tithe-section">
                    <h2>Diezmo (10%)</h2>
                    <div class="tithe-card">
                        <div class="tithe-calculation">
                            <div class="tithe-description">
                                Basado en ganancia neta (Ingresos - Gasolina - Publicidad)
                            </div>
                            <div class="tithe-amount" id="monthly-tithe">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datos View -->
            <div class="content-area" id="datos-view" style="display: none;">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Dashboard de Datos</h1>
                    <div class="dashboard-subtitle">AnÃ¡lisis completo de tu negocio</div>
                </div>

                <!-- Key Metrics Cards -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="total-clients-count">0</div>
                        <div class="metric-label">Total Clientes</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value" id="average-ticket-amount">$0</div>
                        <div class="metric-label">Ticket Promedio</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value" id="total-appointments">0</div>
                        <div class="metric-label">Citas Totales</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value" id="total-revenue">$0</div>
                        <div class="metric-label">Ingresos Totales</div>
                    </div>
                </div>

                <!-- Desktop Layout -->
                <div class="charts-row">
                    <!-- Cities Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Ciudades mÃ¡s Visitadas</h3>
                        </div>
                        <div class="chart-content">
                            <canvas id="cities-chart" width="350" height="220"></canvas>
                        </div>
                    </div>

                    <!-- Jobs Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Trabajos mÃ¡s Solicitados</h3>
                        </div>
                        <div class="chart-content">
                            <canvas id="jobs-chart" width="350" height="220"></canvas>
                        </div>
                    </div>
                </div>

                <div class="analytics-row">
                    <!-- Revenue by City -->
                    <div class="analytics-panel">
                        <div class="panel-header">
                            <h3>Ingresos por Ciudad</h3>
                        </div>
                        <div class="panel-content">
                            <div id="revenue-by-city" class="revenue-bars">
                                <!-- Revenue bars will be generated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="analytics-panel">
                        <div class="panel-header">
                            <h3>Actividad Reciente</h3>
                        </div>
                        <div class="panel-content">
                            <div id="recent-activity" class="activity-list">
                                <!-- Recent appointments will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Trend Chart -->
                <div class="trend-section">
                    <div class="trend-card">
                        <div class="trend-header">
                            <h3>Tendencia Mensual de Citas</h3>
                        </div>
                        <div class="trend-content">
                            <canvas id="monthly-trend-chart" width="700" height="160"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages View -->
            <div class="content-area" id="messages-view" style="display: none;">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">ðŸ’¬ Mensajes para Clientes</h2>
                    <p class="dashboard-subtitle">Mensajes predefinidos listos para copiar y enviar</p>
                </div>

                <div style="display: grid; gap: 24px; max-width: 800px;">
                    <!-- Message 1: Alfombras -->
                    <div class="message-card" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; color: #2d333a; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                ðŸ  Limpieza de Alfombras
                            </h3>
                            <button onclick="copyMessage('carpet')" class="copy-btn" style="background: #10a37f; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                                ðŸ“‹ Copiar
                            </button>
                        </div>
                        <div id="carpet-message" class="message-content" style="background: #f9fafb; padding: 20px; border-radius: 8px; font-size: 15px; line-height: 1.8; color: #374151; white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">El costo del lavado de alfombras varÃ­a segÃºn el Ã¡rea que necesite limpiar:

â€¢ Cuartos: $30 c/u
â€¢ Pasillos: $10 a $30
â€¢ Salas: $30 a $60
â€¢ Escaleras: $45 a $55
â€¢ EliminaciÃ³n de olores: $20 por Ã¡rea
â€¢ ProtecciÃ³n de alfombra: $20 por Ã¡rea adicional*

*La protecciÃ³n de alfombra es un quÃ­mico especializado que se aplica despuÃ©s de la limpieza profunda para proteger contra lÃ­quidos, manchas y desgaste. Prolonga la vida Ãºtil de su alfombra.

ðŸ”¹ Pedido mÃ­nimo: $90
ðŸ›  Trabajamos desde Santaquin hasta Salt Lake City.</div>
                    </div>

                    <!-- Message 2: Sillones -->
                    <div class="message-card" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; color: #2d333a; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                ðŸ›‹ï¸ Limpieza de Sillones
                            </h3>
                            <button onclick="copyMessage('furniture')" class="copy-btn" style="background: #10a37f; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                                ðŸ“‹ Copiar
                            </button>
                        </div>
                        <div id="furniture-message" class="message-content" style="background: #f9fafb; padding: 20px; border-radius: 8px; font-size: 15px; line-height: 1.8; color: #374151; white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">El valor por la limpieza de sillones depende del tamaÃ±o:

â€¢ SillÃ³n de 1 puesto: $35
â€¢ SillÃ³n de 2 puestos o loveseat: $65
â€¢ SofÃ¡ de 3 puestos: $85
â€¢ Seccionales: desde $100
â€¢ ProtecciÃ³n de telas: $30 por sillÃ³n adicional*

*La protecciÃ³n de telas es un tratamiento especial que crea una barrera invisible contra lÃ­quidos, manchas y suciedad. Mantiene sus muebles como nuevos por mÃ¡s tiempo.

Incluye:
âœ¨ Aspirado y eliminaciÃ³n de polvo
âœ¨ Limpieza de manchas, pelos, Ã¡caros, olores y grasa
âœ¨ Lavado profundo con mÃ¡quinas de extracciÃ³n profesionales
âœ¨ Lavado a vapor, ideal para eliminar bacterias, gÃ©rmenes y Ã¡caros, dejando el tejido desinfectado

ðŸ’¨ Secado rÃ¡pido asegurado con ventiladores.</div>
                    </div>

                    <!-- Message 3: CotizaciÃ³n EspecÃ­fica -->
                    <div class="message-card" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; color: #2d333a; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                ðŸ’¬ CotizaciÃ³n EspecÃ­fica
                            </h3>
                            <button onclick="copyMessage('general')" class="copy-btn" style="background: #10a37f; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                                ðŸ“‹ Copiar
                            </button>
                        </div>
                        <div id="general-message" class="message-content" style="background: #f9fafb; padding: 20px; border-radius: 8px; font-size: 15px; line-height: 1.8; color: #374151; white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">El valor por la limpieza de un sillÃ³n como ese es $

Incluye:
âœ¨ Aspirado y eliminaciÃ³n de polvo
âœ¨ Limpieza de manchas, pelos, Ã¡caros, olores y grasa
âœ¨ Lavado profundo con mÃ¡quinas profesionales
âœ¨ Limpieza con vapor, ideal para eliminar bacterias y gÃ©rmenes

ðŸ’¨ Secado rÃ¡pido garantizado con ventiladores

â€¢ ProtecciÃ³n de telas: $30 por sillÃ³n adicional*

*La protecciÃ³n de telas es un tratamiento especial que crea una barrera invisible contra lÃ­quidos, manchas y suciedad. Mantiene sus muebles como nuevos por mÃ¡s tiempo.</div>
                    </div>
                </div>

                <!-- Notification Toast -->
                <div id="copy-notification" style="position: fixed; bottom: 24px; right: 24px; background: #10a37f; color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; align-items: center; gap: 12px; z-index: 1000; animation: slideIn 0.3s ease;">
                    <span style="font-size: 24px;">âœ…</span>
                    <span style="font-weight: 600;">Mensaje copiado al portapapeles</span>
                </div>
            </div>

            <!-- Settings View (Hidden by default) -->

            <div class="content-area" id="settings-view" style="display: none;">
                <!-- Settings Header -->
                <div class="dashboard-header">
                    <h2 class="dashboard-title">ConfiguraciÃ³n</h2>
                    <p class="dashboard-subtitle">Administra backups y configuraciÃ³n del sistema</p>
                </div>

                <!-- Backup Management Section -->
                <div class="form-section" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px; color: #2d333a;">ðŸ“¦ Sistema de Backup</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div style="padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e5e7;">
                            <h4 style="margin: 0 0 8px 0; color: #374151; font-size: 14px;">Estado del Backup</h4>
                            <div id="backup-status-detailed" style="font-size: 13px; color: #666;">
                                Verificando...
                            </div>
                        </div>
                        <div style="padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e5e7;">
                            <h4 style="margin: 0 0 8px 0; color: #374151; font-size: 14px;">Backup AutomÃ¡tico</h4>
                            <div style="font-size: 13px; color: #666;">
                                âœ… Activo (diariamente)
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button onclick="BackupSystem.downloadBackup()" 
                                style="background: #10a37f; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ðŸ“¥ Descargar Backup Completo
                        </button>
                        <button onclick="forceBackupCheck()" 
                                style="background: #3b82f6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ðŸ”„ Forzar Backup Diario
                        </button>
                        <input type="file" id="backup-restore-input" accept=".json" style="display: none;" 
                               onchange="handleBackupRestore(event)">
                        <button onclick="document.getElementById('backup-restore-input').click()" 
                                style="background: #f59e0b; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ðŸ“¤ Restaurar Backup
                        </button>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px;">
                        <div style="font-size: 13px; color: #92400e;">
                            <strong>ðŸ’¡ Recomendaciones:</strong><br>
                            â€¢ Los backups se crean automÃ¡ticamente cada dÃ­a<br>
                            â€¢ Descarga backups manualmente antes de cambios importantes<br>
                            â€¢ Los backups incluyen: citas, configuraciÃ³n, contadores de facturas
                        </div>
                    </div>
                </div>

                <!-- System Info Section -->
                <div class="form-section">
                    <h3 style="margin-bottom: 16px; color: #2d333a;">â„¹ï¸ InformaciÃ³n del Sistema</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">AplicaciÃ³n</div>
                            <div style="font-size: 14px; font-weight: 500;">RIZE Professional Cleaning v1.0</div>
                        </div>
                        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Base de Datos</div>
                            <div style="font-size: 14px; font-weight: 500;">IndexedDB + Supabase</div>
                        </div>
                        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Modo Offline</div>
                            <div id="offline-status" style="font-size: 14px; font-weight: 500;">âœ… Activado</div>
                        </div>
                        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Ãšltima SincronizaciÃ³n</div>
                            <div id="last-sync-time" style="font-size: 14px; font-weight: 500;">Verificando...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
    <!-- IndexedDB library for offline-first functionality -->
    <script src="https://unpkg.com/idb@8/build/umd.js"></script>
    <!-- Tesseract.js for free OCR in the browser -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script>
        // ================================================================
        // RIZE PROFESSIONAL CLEANING - PWA
        // MODULARIZED JAVASCRIPT ARCHITECTURE
        // ================================================================

        // Hexagonal Loading Animation Functions
        function showHexLoader() {
            const loader = document.getElementById('hex-loader');
            if (loader) {
                loader.style.display = 'flex';
            }
        }

        function hideHexLoader() {
            const loader = document.getElementById('hex-loader');
            if (loader) {
                loader.style.display = 'none';
            }

            // Show landing page with Bento Grid
            const landingView = document.getElementById('landing-view');
            if (landingView) {
                landingView.style.display = 'flex';
            }

            // Hide main container initially (will show when navigating from Bento Grid)
            const container = document.querySelector('.container');
            if (container) {
                container.style.display = 'none';
            }

            // Hide mobile menu button initially
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.style.display = 'none';
            }

            // Hide header initially (will show when navigating to a section)
            const header = document.querySelector('.header');
            if (header) {
                header.style.display = 'none';
            }
        }

        // Example usage functions for different operations
        function showLoadingForImageProcess() {
            showHexLoader();
            setTimeout(hideHexLoader, 3000); // Hide after 3 seconds as example
        }

        function showLoadingForAppointmentSave() {
            showHexLoader();
            setTimeout(hideHexLoader, 2000); // Hide after 2 seconds as example
        }

        // Mobile menu functions - define early to avoid reference errors
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
            if (overlay) {
                overlay.classList.toggle('active');
            }
            if (body) {
                body.classList.toggle('mobile-menu-open');
            }
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            
            if (sidebar) {
                sidebar.classList.remove('open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
            if (body) {
                body.classList.remove('mobile-menu-open');
            }
        }
        
        // ================================
        // MODULE 1: CONFIGURATION & SETUP
        // ================================

        // SECURITY FIX: API keys now stored in backend (Vercel serverless functions)
        // This prevents key exposure in frontend code and protects against unauthorized use

        // API endpoints configuration
        const isFileProtocol = window.location.protocol === 'file:';
        const isLocalhost = window.location.hostname === 'localhost';

        // Determine API base URL based on environment
        const API_BASE_URL = isFileProtocol
            ? null // No API calls from file:// protocol
            : (isLocalhost
                ? 'http://localhost:3000/api' // Local development
                : '/api'); // Production (Vercel)

        // ================================
        // MODULE 0: DARK MODE SYSTEM
        // ================================
        
        // Dark mode functionality
        function initDarkMode() {
            // Check for saved theme preference or default to light mode
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            updateThemeToggleIcon(savedTheme);
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }
        
        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            updateThemeToggleIcon(newTheme);
        }
        
        function updateThemeToggleIcon(theme) {
            const lightIcon = document.querySelector('.light-icon');
            const darkIcon = document.querySelector('.dark-icon');
            
            if (lightIcon && darkIcon) {
                if (theme === 'dark') {
                    lightIcon.style.display = 'none';
                    darkIcon.style.display = 'block';
                } else {
                    lightIcon.style.display = 'block';
                    darkIcon.style.display = 'none';
                }
            }
        }
        
        // Backup status UI updater
        function updateBackupStatusUI() {
            const statusElement = document.getElementById('backup-status');
            const statusText = statusElement?.querySelector('.status-text');
            
            if (!statusElement || !statusText) return;
            
            const backupStatus = BackupSystem.getBackupStatus();
            statusText.textContent = backupStatus.status;
            
            // Update title for mobile tooltips
            const shortStatus = backupStatus.status.includes('Never') ? 'No backup' : 
                              backupStatus.status.includes('hours ago') || backupStatus.status.includes('Today') ? 'Recent backup' : 
                              'Old backup';
            statusElement.setAttribute('title', shortStatus);
            
            // Remove existing status classes
            statusElement.classList.remove('recent', 'old');
            
            // Add appropriate class based on backup age
            if (backupStatus.status.includes('Never')) {
                // No additional class needed
            } else if (backupStatus.status.includes('hours ago') || backupStatus.status.includes('Today')) {
                statusElement.classList.add('recent');
            } else {
                statusElement.classList.add('old');
            }
        }

        // Sync status UI updater
        async function updateSyncStatusUI() {
            const statusElement = document.getElementById('sync-status');
            const statusText = statusElement?.querySelector('.status-text');
            const statusIcon = statusElement?.querySelector('.status-icon');
            
            if (!statusElement || !statusText || !statusIcon) {
                console.log('âŒ Sync status elements not found');
                return;
            }
            
            const isOnline = navigator.onLine;
            
            // Remove existing status classes
            statusElement.classList.remove('online', 'offline', 'syncing');
            
            if (!isOnline) {
                statusElement.classList.add('offline');
                statusText.textContent = 'Offline';
                statusElement.setAttribute('title', 'Offline');
                // Update icon to disconnected/offline state
                statusIcon.innerHTML = '<path d="M17 7L15.59 5.59L12 9.17 8.41 5.59L7 7l4 4-4 4 1.41 1.41L12 12.83l3.59 3.58L17 15l-4-4 4-4zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>';
            } else {
                try {
                    const syncStatus = await OfflineDB.getSyncStatus();
                    
                    if (syncStatus.queued > 0) {
                        statusElement.classList.add('syncing');
                        statusText.textContent = `Syncing (${syncStatus.queued})`;
                        statusElement.setAttribute('title', `Syncing (${syncStatus.queued})`);
                        // Update icon to syncing state
                        statusIcon.innerHTML = '<path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>';
                    } else {
                        statusElement.classList.add('online');
                        statusText.textContent = 'Online';
                        statusElement.setAttribute('title', 'Online');
                        // Update icon to online/connected state
                        statusIcon.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>';
                    }
                } catch (error) {
                    statusElement.classList.add('online');
                    statusText.textContent = 'Online';
                    statusElement.setAttribute('title', 'Online');
                    statusIcon.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>';
                }
            }
        }

        // Backend health check
        let backendAvailable = false;
        async function checkBackendHealth() {
            // Skip backend check if running from file://
            if (isFileProtocol || !API_BASE_URL) {
                backendAvailable = false;
                console.log('ðŸ“ Running from file system. OCR features disabled. Use "npm start" for full functionality.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                backendAvailable = response.ok;
                if (backendAvailable) {
                    console.log('âœ… Secure backend connected');
                } else {
                    console.warn('âš ï¸  Backend unhealthy. OCR features disabled.');
                }
            } catch (error) {
                backendAvailable = false;
                console.warn('âš ï¸  Backend not available. OCR features disabled. Run "npm start" to enable full functionality.');
            }
        }
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://stodvmbmvtxljfsdzghc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0b2R2bWJtdnR4bGpmc2R6Z2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyODMyMTYsImV4cCI6MjA3Mjg1OTIxNn0.7y3RPDV_xYFzXSTUM7oCt_WgSSRLm2HoGsCq5-5Jm5M';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ================================
        // DATA RECOVERY DIAGNOSTIC TOOL
        // ================================

        // FunciÃ³n de recuperaciÃ³n de emergencia
        window.recoverData = function() {
            console.log('ðŸš‘ ===== DATA RECOVERY MODE =====');

            const localAppointments = localStorage.getItem('appointments');
            const localRegistry = localStorage.getItem('clientRegistry');

            if (!localAppointments && !localRegistry) {
                console.log('âŒ No hay datos para recuperar en localStorage');
                return;
            }

            if (localAppointments) {
                const appts = JSON.parse(localAppointments);
                console.log(`âœ… Recuperados ${appts.length} appointments de localStorage`);
                console.table(appts);
            }

            if (localRegistry) {
                const registry = JSON.parse(localRegistry);
                console.log(`âœ… Recuperados ${registry.length} clientes del registro`);
                console.table(registry);
            }

            console.log('âœ… Datos recuperados. Recarga la pÃ¡gina (F5) para verlos.');
        };

        // Run this from browser console: await checkAllData()
        window.checkAllData = async function() {
            console.log('ðŸ” ========== DATA DIAGNOSTIC REPORT ==========');

            // 1. Check Supabase
            console.log('\nðŸ“Š 1. CHECKING SUPABASE DATABASE...');
            try {
                const { data: appointments, error } = await supabaseClient
                    .from('appointments')
                    .select('*')
                    .order('date', { ascending: true });

                if (error) {
                    console.error('âŒ Supabase Error:', error);
                } else {
                    console.log(`âœ… Supabase appointments found: ${appointments?.length || 0}`);
                    if (appointments && appointments.length > 0) {
                        console.table(appointments);
                    }
                }
            } catch (e) {
                console.error('âŒ Supabase connection failed:', e);
            }

            // 2. Check localStorage
            console.log('\nðŸ’¾ 2. CHECKING LOCALSTORAGE...');
            const localAppointments = localStorage.getItem('appointments');
            const localRegistry = localStorage.getItem('clientRegistry');

            if (localAppointments) {
                const appts = JSON.parse(localAppointments);
                console.log(`âœ… localStorage appointments: ${appts.length}`);
                console.table(appts);
            } else {
                console.log('âŒ No appointments in localStorage');
            }

            if (localRegistry) {
                const registry = JSON.parse(localRegistry);
                console.log(`âœ… localStorage client registry: ${registry.length}`);
                console.table(registry);
            } else {
                console.log('âŒ No client registry in localStorage');
            }

            // 3. Check IndexedDB
            console.log('\nðŸ—„ï¸  3. CHECKING INDEXEDDB...');
            try {
                const request = indexedDB.open('AppointmentDB', 2);
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const tx = db.transaction('appointments', 'readonly');
                    const store = tx.objectStore('appointments');
                    const getAllRequest = store.getAll();

                    getAllRequest.onsuccess = function() {
                        const idbAppointments = getAllRequest.result;
                        console.log(`âœ… IndexedDB appointments: ${idbAppointments.length}`);
                        if (idbAppointments.length > 0) {
                            console.table(idbAppointments);
                        }
                    };
                };
                request.onerror = function() {
                    console.log('âŒ Cannot access IndexedDB');
                };
            } catch (e) {
                console.error('âŒ IndexedDB error:', e);
            }

            console.log('\nðŸ” ========== END OF REPORT ==========');
            console.log('ðŸ’¡ To restore data, we can sync from Supabase if data exists there');
        };

        // ================================
        // MODULE 2: OFFLINE-FIRST DATABASE
        // ================================
        // FEATURE: IndexedDB for reliable offline storage
        // Replaces localStorage for critical business data
        
        let dbInstance = null;
        
        // Initialize IndexedDB
        async function initDB() {
            try {
                if (!window.idb) {
                    console.warn('âš ï¸  IndexedDB library not loaded, falling back to localStorage');
                    return null;
                }
                
                dbInstance = await window.idb.openDB('RizeCleaningDB', 1, {
                    upgrade(db) {
                        // Appointments store
                        if (!db.objectStoreNames.contains('appointments')) {
                            const appointmentStore = db.createObjectStore('appointments', {
                                keyPath: 'id'
                            });
                            appointmentStore.createIndex('date', 'date');
                            appointmentStore.createIndex('status', 'status');
                            console.log('âœ… Created appointments store');
                        }
                        
                        // Settings store
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', {
                                keyPath: 'key'
                            });
                            console.log('âœ… Created settings store');
                        }
                        
                        // Sync queue for when back online
                        if (!db.objectStoreNames.contains('syncQueue')) {
                            const syncStore = db.createObjectStore('syncQueue', {
                                keyPath: 'id',
                                autoIncrement: true
                            });
                            syncStore.createIndex('timestamp', 'timestamp');
                            syncStore.createIndex('action', 'action');
                            console.log('âœ… Created sync queue store');
                        }
                    }
                });
                
                console.log('âœ… IndexedDB initialized successfully');
                return dbInstance;
            } catch (error) {
                console.error('âŒ IndexedDB initialization failed:', error);
                return null;
            }
        }
        
        // Track recent offline saves to prioritize local data
        let recentOfflineSave = false;

        // Phone number management system
        const PhoneManager = {
            save(appointmentId, phoneNumber) {
                const phones = this.getAll();
                phones[appointmentId] = phoneNumber;
                localStorage.setItem('client_phones', JSON.stringify(phones));
                console.log('ðŸ“ž Saved phone to PhoneManager:', appointmentId, phoneNumber);
            },

            get(appointmentId) {
                const phones = this.getAll();
                return phones[appointmentId] || null;
            },

            getAll() {
                const stored = localStorage.getItem('client_phones');
                return stored ? JSON.parse(stored) : {};
            },

            applyToAppointments(appointments) {
                const phones = this.getAll();
                return appointments.map(apt => ({
                    ...apt,
                    phone: phones[apt.id] || apt.phone
                }));
            }
        };

        // Offline-first data operations
        const OfflineDB = {
            // Get all appointments - FIXED LOGIC
            async getAppointments() {
                console.log('ðŸ“Š getAppointments called - recentOfflineSave flag:', recentOfflineSave);
                console.log('ðŸ” DEBUGGING: navigator.onLine status:', navigator.onLine);

                // If we recently saved offline, prioritize local data
                if (recentOfflineSave) {
                    console.log('ðŸ”„ Using local data due to recent offline save');
                    console.log('ðŸ” DEBUGGING: Taking recentOfflineSave path');
                    if (dbInstance) {
                        try {
                            const tx = dbInstance.transaction('appointments', 'readonly');
                            const store = tx.objectStore('appointments');
                            const appointments = await store.getAll();
                            return PhoneManager.applyToAppointments(appointments);
                        } catch (error) {
                            console.error('Error getting appointments from IndexedDB:', error);
                        }
                    }

                    // Fallback to localStorage
                    const stored = localStorage.getItem('appointments');
                    return stored ? JSON.parse(stored) : [];
                }

                // ONLINE: Use Supabase as primary source
                if (navigator.onLine) {
                    console.log('ðŸ” DEBUGGING: Taking online/Supabase path');
                    try {
                        const supabaseAppointments = await getAppointmentsFromSupabase();
                        if (supabaseAppointments && supabaseAppointments.length >= 0) {
                            // Update local cache with latest data
                            if (dbInstance) {
                                const tx = dbInstance.transaction('appointments', 'readwrite');
                                const store = tx.objectStore('appointments');
                                await store.clear();
                                for (const apt of supabaseAppointments) {
                                    await store.put(apt);
                                }
                            }
                            localStorage.setItem('appointments', JSON.stringify(supabaseAppointments));

                            // Apply phone numbers before returning
                            return PhoneManager.applyToAppointments(supabaseAppointments);
                        }
                    } catch (error) {
                        console.warn('âš ï¸  Supabase failed, falling back to offline data:', error.message);
                    }
                }
                
                // OFFLINE: Use local data
                // Intentar IndexedDB primero (si estÃ¡ disponible)
                if (dbInstance) {
                    try {
                        const tx = dbInstance.transaction('appointments', 'readonly');
                        const store = tx.objectStore('appointments');
                        const idbAppointments = await store.getAll();
                        console.log('âœ… Loaded from IndexedDB:', idbAppointments.length);
                        return PhoneManager.applyToAppointments(idbAppointments);
                    } catch (error) {
                        console.warn('âš ï¸  IndexedDB failed, using localStorage:', error.message);
                        // Continuar a localStorage si IndexedDB falla
                    }
                }

                // FALLBACK PRINCIPAL: localStorage (SIEMPRE debe funcionar)
                console.log('ðŸ’¾ Loading from localStorage...');
                const stored = localStorage.getItem('appointments');
                const appointments = stored ? JSON.parse(stored) : [];
                console.log('âœ… Loaded from localStorage:', appointments.length, 'appointments');
                if (appointments.length > 0) {
                    console.table(appointments);
                }

                // Always apply phone numbers before returning
                return PhoneManager.applyToAppointments(appointments);
            },
            
            // Save appointment - FIXED LOGIC
            async saveAppointment(appointment) {
                console.log('ðŸ’¾ ===== SAVE APPOINTMENT CALLED =====');
                console.log('ðŸ’¾ Appointment data:', appointment);

                // PASO 1: SIEMPRE guardar en localStorage PRIMERO (fuente de verdad)
                console.log('ðŸ’¾ Step 1: Saving to localStorage (primary storage)...');
                const currentAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const existingIndex = currentAppointments.findIndex(apt =>
                    apt.timestamp === appointment.timestamp || apt.id === appointment.id
                );
                if (existingIndex >= 0) {
                    currentAppointments[existingIndex] = appointment;
                    console.log('âœ… Updated existing appointment in localStorage');
                } else {
                    currentAppointments.push(appointment);
                    console.log('âœ… Added new appointment to localStorage');
                }
                localStorage.setItem('appointments', JSON.stringify(currentAppointments));
                console.log('âœ… localStorage saved successfully:', currentAppointments.length, 'appointments');
                console.table(currentAppointments);

                // PASO 2: Intentar guardar en Supabase (opcional, mejor esfuerzo)
                if (navigator.onLine) {
                    try {
                        console.log('ðŸŒ Step 2: Attempting Supabase backup...');
                        if (appointment.originalTimestamp || appointment.id) {
                            const originalTimestamp = appointment.originalTimestamp || appointment.timestamp;
                            await updateAppointmentInSupabase(originalTimestamp, appointment);
                            console.log('âœ… Appointment updated in Supabase');
                        } else {
                            const savedData = await saveAppointmentToSupabase(appointment);
                            if (savedData?.id) {
                                appointment.id = savedData.id;
                                // Actualizar localStorage con el ID de Supabase
                                const idx = currentAppointments.findIndex(apt => apt.timestamp === appointment.timestamp);
                                if (idx >= 0) {
                                    currentAppointments[idx].id = savedData.id;
                                    localStorage.setItem('appointments', JSON.stringify(currentAppointments));
                                }
                            }
                            console.log('âœ… Appointment saved to Supabase with ID:', appointment.id);
                        }
                    } catch (error) {
                        console.warn('âš ï¸  Supabase save failed (data is safe in localStorage):', error.message);
                    }
                }

                // PASO 3: Intentar guardar en IndexedDB (opcional)
                if (dbInstance) {
                    try {
                        const tx = dbInstance.transaction('appointments', 'readwrite');
                        const store = tx.objectStore('appointments');
                        await store.put(appointment);
                        console.log('âœ… Also saved to IndexedDB');
                    } catch (err) {
                        console.warn('âš ï¸  IndexedDB save failed (data is safe in localStorage):', err.message);
                    }
                }

                // Mark that we saved offline recently
                recentOfflineSave = true;
                console.log('ðŸ SET recentOfflineSave flag to TRUE');

                // Reset after 5 seconds
                setTimeout(() => {
                    recentOfflineSave = false;
                    console.log('ðŸ”„ Reset offline save flag');
                }, 5000);

                console.log('âœ… ===== SAVE COMPLETED SUCCESSFULLY =====');
                return appointment;
            },
            
            // Delete appointment
            async deleteAppointment(appointmentId) {
                // ONLINE: Delete from Supabase first
                if (navigator.onLine) {
                    try {
                        // Find the appointment to get its timestamp for Supabase deletion
                        const appointments = await this.getAppointments();
                        const appointmentToDelete = appointments.find(apt => apt.id === appointmentId);
                        
                        if (appointmentToDelete) {
                            await deleteAppointmentFromSupabase(appointmentToDelete.timestamp);
                            console.log('âœ… Appointment deleted from Supabase');
                        }
                    } catch (error) {
                        console.warn('âš ï¸  Supabase delete failed, deleting offline:', error.message);
                    }
                }
                
                // Delete from localStorage
                const appointments = await this.getAppointments();
                const filtered = appointments.filter(apt => apt.id !== appointmentId);
                localStorage.setItem('appointments', JSON.stringify(filtered));
                
                // Delete from IndexedDB
                if (dbInstance) {
                    try {
                        const tx = dbInstance.transaction('appointments', 'readwrite');
                        const store = tx.objectStore('appointments');
                        await store.delete(appointmentId);
                        console.log('âœ… Appointment deleted from IndexedDB');
                        
                        // If offline, queue for sync when back online
                        if (!navigator.onLine) {
                            await this.queueForSync('delete', 'appointments', { id: appointmentId });
                        }
                    } catch (error) {
                        console.error('Error deleting from IndexedDB:', error);
                    }
                }
                
                console.log('âœ… Appointment deleted successfully');
            },
            
            // Queue operation for sync when back online
            async queueForSync(action, table, data) {
                if (!dbInstance) return;
                
                try {
                    const tx = dbInstance.transaction('syncQueue', 'readwrite');
                    const store = tx.objectStore('syncQueue');
                    await store.add({
                        action,
                        table,
                        data,
                        timestamp: new Date().toISOString()
                    });
                    console.log(`ðŸ“¥ Queued ${action} for sync:`, data);
                } catch (error) {
                    console.error('Error queuing for sync:', error);
                }
            },
            
            // Sync with Supabase when back online
            async syncWithSupabase() {
                if (!dbInstance || !navigator.onLine) return;
                
                try {
                    const tx = dbInstance.transaction('syncQueue', 'readwrite');
                    const store = tx.objectStore('syncQueue');
                    const queuedItems = await store.getAll();
                    
                    for (const item of queuedItems) {
                        try {
                            if (item.table === 'appointments') {
                                if (item.action === 'update') {
                                    await supabaseClient
                                        .from('appointments')
                                        .upsert(item.data);
                                } else if (item.action === 'delete') {
                                    await supabaseClient
                                        .from('appointments')
                                        .delete()
                                        .eq('id', item.data.id);
                                }
                            }
                            
                            // Remove from queue after successful sync
                            await store.delete(item.id);
                            console.log(`âœ… Synced ${item.action} for ${item.table}`);
                        } catch (syncError) {
                            console.error('Sync error for item:', item, syncError);
                        }
                    }
                } catch (error) {
                    console.error('Error during sync:', error);
                }
            },
            
            // Check if we're working offline
            isOffline() {
                return !navigator.onLine;
            },
            
            // Get sync status
            async getSyncStatus() {
                if (!dbInstance) return { queued: 0, lastSync: null };
                
                try {
                    const tx = dbInstance.transaction('syncQueue', 'readonly');
                    const store = tx.objectStore('syncQueue');
                    const queuedItems = await store.getAll();
                    
                    return {
                        queued: queuedItems.length,
                        lastSync: localStorage.getItem('lastSyncTime'),
                        isOnline: navigator.onLine
                    };
                } catch (error) {
                    return { queued: 0, lastSync: null };
                }
            }
        };

        // ================================
        // MODULE 3: AUTOMATIC BACKUP SYSTEM
        // ================================
        // FEATURE: Protect your business data with daily backups
        
        const BackupSystem = {
            // Generate backup filename with timestamp
            generateBackupFilename(type = 'full') {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
                return `RIZE-backup-${type}-${dateStr}-${timeStr}.json`;
            },
            
            // Create full backup of all business data
            async createFullBackup() {
                try {
                    const appointments = await OfflineDB.getAppointments();
                    const syncStatus = await OfflineDB.getSyncStatus();
                    
                    const backupData = {
                        metadata: {
                            version: '1.0',
                            created: new Date().toISOString(),
                            type: 'full_backup',
                            app: 'RIZE Professional Cleaning',
                            totalAppointments: appointments.length,
                            syncStatus: syncStatus
                        },
                        data: {
                            appointments: appointments,
                            settings: {
                                gasPrice: localStorage.getItem('gasPrice_current'),
                                lastGasUpdate: localStorage.getItem('gasPrice_lastUpdate'),
                                invoiceCounters: this.getInvoiceCounters()
                            },
                            // Include localStorage data for complete backup
                            localStorage: this.getLocalStorageData()
                        }
                    };
                    
                    return backupData;
                } catch (error) {
                    console.error('âŒ Error creating backup:', error);
                    throw error;
                }
            },
            
            // Get all invoice counters
            getInvoiceCounters() {
                const counters = {};
                for (let key in localStorage) {
                    if (key.startsWith('invoiceCounter_')) {
                        counters[key] = localStorage.getItem(key);
                    }
                }
                return counters;
            },
            
            // Get important localStorage data
            getLocalStorageData() {
                const important = {};
                const importantKeys = [
                    'appointments',
                    'lastSyncTime',
                    'lastReminderCheck',
                    'gasPrice_current',
                    'gasPrice_lastUpdate'
                ];
                
                importantKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        important[key] = localStorage.getItem(key);
                    }
                });
                
                return important;
            },
            
            // Download backup file
            async downloadBackup(type = 'full') {
                try {
                    console.log('ðŸ“¦ Creating backup...');
                    const backupData = await this.createFullBackup();
                    const jsonString = JSON.stringify(backupData, null, 2);
                    
                    // Create download link
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = this.generateBackupFilename(type);
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    console.log('âœ… Backup downloaded successfully');
                    
                    // Update last backup time
                    localStorage.setItem('lastBackupTime', new Date().toISOString());
                    
                    return backupData;
                } catch (error) {
                    console.error('âŒ Backup failed:', error);
                    alert('Error creating backup: ' + error.message);
                }
            },
            
            // Auto backup (daily)
            async checkAndCreateDailyBackup() {
                try {
                    const lastBackup = localStorage.getItem('lastBackupTime');
                    const now = new Date();
                    const today = now.toDateString();
                    
                    if (!lastBackup || new Date(lastBackup).toDateString() !== today) {
                        console.log('ðŸ“… Time for daily backup...');
                        
                        // Create backup data but don't download automatically
                        const backupData = await this.createFullBackup();
                        
                        // Store backup in IndexedDB for safety
                        if (dbInstance) {
                            await this.storeBackupLocally(backupData);
                        }
                        
                        localStorage.setItem('lastBackupTime', now.toISOString());
                        console.log('âœ… Daily backup completed and stored locally');
                        
                        // Show subtle notification
                        this.showBackupNotification('Daily backup completed successfully');
                        
                        return true;
                    }
                    
                    return false; // No backup needed today
                } catch (error) {
                    console.error('âŒ Daily backup failed:', error);
                    return false;
                }
            },
            
            // Store backup in IndexedDB
            async storeBackupLocally(backupData) {
                if (!dbInstance) return;
                
                try {
                    const tx = dbInstance.transaction('settings', 'readwrite');
                    const store = tx.objectStore('settings');
                    
                    await store.put({
                        key: 'latest_backup',
                        value: backupData,
                        timestamp: new Date().toISOString()
                    });
                    
                    console.log('ðŸ’¾ Backup stored in IndexedDB');
                } catch (error) {
                    console.error('Error storing backup locally:', error);
                }
            },
            
            // Show backup notification
            showBackupNotification(message) {
                // Create temporary notification in the UI
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: var(--brand-primary);
                    color: white;
                    padding: 12px 16px;
                    border-radius: 6px;
                    font-size: 14px;
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                notification.textContent = 'ðŸ“¦ ' + message;
                
                document.body.appendChild(notification);
                
                // Show notification
                setTimeout(() => notification.style.opacity = '1', 100);
                
                // Hide and remove after 3 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            },
            
            // Restore from backup file
            async restoreFromBackup(backupFile) {
                try {
                    const backupText = await backupFile.text();
                    const backupData = JSON.parse(backupText);
                    
                    if (!backupData.metadata || backupData.metadata.app !== 'RIZE Professional Cleaning') {
                        throw new Error('Invalid backup file format');
                    }
                    
                    console.log('ðŸ“¥ Restoring from backup created:', backupData.metadata.created);
                    
                    // Restore appointments
                    if (backupData.data.appointments) {
                        for (const appointment of backupData.data.appointments) {
                            await OfflineDB.saveAppointment(appointment);
                        }
                        console.log(`âœ… Restored ${backupData.data.appointments.length} appointments`);
                    }
                    
                    // Restore settings
                    if (backupData.data.settings) {
                        Object.entries(backupData.data.settings).forEach(([key, value]) => {
                            if (value !== null) {
                                localStorage.setItem(key, value);
                            }
                        });
                        console.log('âœ… Settings restored');
                    }
                    
                    // Restore localStorage data
                    if (backupData.data.localStorage) {
                        Object.entries(backupData.data.localStorage).forEach(([key, value]) => {
                            localStorage.setItem(key, value);
                        });
                        console.log('âœ… LocalStorage data restored');
                    }
                    
                    alert(`Backup restored successfully!\n\nRestored:\n- ${backupData.data.appointments.length} appointments\n- Settings and preferences\n\nPlease reload the page to see changes.`);
                    
                    return true;
                } catch (error) {
                    console.error('âŒ Restore failed:', error);
                    alert('Error restoring backup: ' + error.message);
                    return false;
                }
            },
            
            // Get backup status
            getBackupStatus() {
                const lastBackup = localStorage.getItem('lastBackupTime');
                if (!lastBackup) {
                    return { status: 'Never backed up', color: '#dc2626' };
                }
                
                const backupDate = new Date(lastBackup);
                const now = new Date();
                const hoursSince = (now - backupDate) / (1000 * 60 * 60);
                
                if (hoursSince < 24) {
                    return { 
                        status: `Last backup: ${Math.floor(hoursSince)}h ago`, 
                        color: '#059669' 
                    };
                } else {
                    return { 
                        status: `Last backup: ${Math.floor(hoursSince / 24)}d ago`, 
                        color: '#f59e0b' 
                    };
                }
            }
        };

        // ================================
        // MODULE 4: BUSINESS CONFIGURATION
        // ================================
        
        // Square Configuration 
        // SANDBOX (para pruebas - no cobra dinero real)
        const SQUARE_APPLICATION_ID_SANDBOX = 'sandbox-sq0idb-twSpS3n2QwxZvYGFvCXKsA';
        const SQUARE_ACCESS_TOKEN_SANDBOX = 'EAAAl4d5K9AoeXdQRhFVlp_CYNUb1WjZDUm50d3tbz1XSb3VpDaXrCtvD4NdR35N';
        
        // PRODUCTION (para dinero real - cÃ¡mbialo cuando tengas credenciales de producciÃ³n)
        const SQUARE_APPLICATION_ID_PROD = 'PEGA_AQUÃ_TU_PRODUCTION_APP_ID';
        const SQUARE_ACCESS_TOKEN_PROD = 'PEGA_AQUÃ_TU_PRODUCTION_ACCESS_TOKEN';
        
        // âš ï¸ CAMBIAR ESTO PARA ACTIVAR DINERO REAL
        const USE_PRODUCTION = false; // Cambiar a true para cobrar dinero real
        
        const SQUARE_APPLICATION_ID = USE_PRODUCTION ? SQUARE_APPLICATION_ID_PROD : SQUARE_APPLICATION_ID_SANDBOX;
        const SQUARE_ACCESS_TOKEN = USE_PRODUCTION ? SQUARE_ACCESS_TOKEN_PROD : SQUARE_ACCESS_TOKEN_SANDBOX;
        const SQUARE_ENVIRONMENT = USE_PRODUCTION ? 'production' : 'sandbox';
        
        // State management
        let appointmentsToday = 0;
        const MAX_APPOINTMENTS_PER_DAY = 3;
        let currentView = 'schedule';
        let currentWeekStart; // Will be initialized in setCurrentWeek()
        let selectedAppointment = null;
        let uploadedImages = []; // Store uploaded images data
        // Removed: reminder system variables no longer used

        // Supabase Functions
        async function saveAppointmentToSupabase(appointmentData) {
            try {
                // Filter out phone field since it doesn't exist in Supabase schema
                const { phone, ...supabaseData } = appointmentData;

                // Remove id from data if it's null/undefined so Supabase can auto-generate
                if (!supabaseData.id) {
                    delete supabaseData.id;
                }

                const { data, error } = await supabaseClient
                    .from('appointments')
                    .insert([supabaseData])
                    .select(); // Return the inserted record with generated ID

                if (error) throw error;
                console.log('âœ… Appointment saved to Supabase:', data);
                return data?.[0]; // Return the first (and only) inserted record
            } catch (error) {
                console.error('âŒ Error saving appointment:', error);
                throw error;
            }
        }

        async function getAppointmentsFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('appointments')
                    .select('*')
                    .order('date', { ascending: true });

                if (error) throw error;
                console.log('âœ… Appointments loaded from Supabase:', data?.length || 0);
                return data || [];
            } catch (error) {
                console.error('âŒ Error loading appointments:', error);
                // âš ï¸ IMPORTANTE: Lanzar el error para que el fallback a localStorage funcione
                throw error;
            }
        }

        async function deleteAppointmentFromSupabase(timestamp) {
            try {
                const { data, error } = await supabaseClient
                    .from('appointments')
                    .delete()
                    .eq('timestamp', timestamp);
                
                if (error) throw error;
                console.log('âœ… Appointment deleted from Supabase');
                return data;
            } catch (error) {
                console.error('âŒ Error deleting appointment:', error);
                throw error;
            }
        }

        async function updateAppointmentInSupabase(timestamp, updates) {
            try {
                // Filter out phone field and originalTimestamp since they don't exist in Supabase schema
                const { phone, originalTimestamp, ...supabaseUpdates } = updates;

                const { data, error } = await supabaseClient
                    .from('appointments')
                    .update(supabaseUpdates)
                    .eq('timestamp', timestamp);
                
                if (error) throw error;
                console.log('âœ… Appointment updated in Supabase');
                return data;
            } catch (error) {
                console.error('âŒ Error updating appointment:', error);
                throw error;
            }
        }

        async function saveDayEventToSupabase(date, eventType) {
            try {
                const { data, error } = await supabaseClient
                    .from('day_events')
                    .upsert([{ date, event_type: eventType }]);
                
                if (error) throw error;
                console.log('âœ… Day event saved to Supabase');
                return data;
            } catch (error) {
                console.error('âŒ Error saving day event:', error);
                throw error;
            }
        }

        async function getDayEventsFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('day_events')
                    .select('*');
                
                if (error) throw error;
                console.log('âœ… Day events loaded from Supabase:', data?.length || 0);
                return data || [];
            } catch (error) {
                console.error('âŒ Error loading day events:', error);
                return [];
            }
        }

        async function deleteDayEventFromSupabase(date) {
            try {
                const { data, error } = await supabaseClient
                    .from('day_events')
                    .delete()
                    .eq('date', date);
                
                if (error) throw error;
                console.log('âœ… Day event deleted from Supabase');
                return data;
            } catch (error) {
                console.error('âŒ Error deleting day event:', error);
                throw error;
            }
        }

        // Migration function to move localStorage data to Supabase
        async function migrateLocalStorageToSupabase() {
            try {
                console.log('ðŸ”„ Starting migration from localStorage to Supabase...');
                
                // Migrate appointments
                const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                if (localAppointments.length > 0) {
                    console.log(`ðŸ“… Migrating ${localAppointments.length} appointments...`);
                    for (const apt of localAppointments) {
                        await saveAppointmentToSupabase({
                            ...apt,
                            price: parseFloat(apt.price) || 0,
                            timestamp: apt.timestamp || Date.now()
                        });
                    }
                    console.log('âœ… Appointments migrated successfully');
                }
                
                // Migrate day events
                const localDayEvents = JSON.parse(localStorage.getItem('dayEvents') || '{}');
                const dayEventEntries = Object.entries(localDayEvents);
                if (dayEventEntries.length > 0) {
                    console.log(`ðŸ“… Migrating ${dayEventEntries.length} day events...`);
                    for (const [date, eventType] of dayEventEntries) {
                        await saveDayEventToSupabase(date, eventType);
                    }
                    console.log('âœ… Day events migrated successfully');
                }
                
                console.log('ðŸŽ‰ Migration completed successfully!');
                
                // Optional: Clear localStorage after successful migration
                // localStorage.removeItem('appointments');
                // localStorage.removeItem('dayEvents');
                
                return true;
            } catch (error) {
                console.error('ðŸ’¥ Error during migration:', error);
                return false;
            }
        }

        // Mobile menu functions (moved to top of file to avoid reference errors)

        // Close mobile menu when clicking menu items
        function setupMobileMenuClose() {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', closeMobileMenu);
            });
            
        }

        // Function to show event options
        function showEventOptions(dateStr) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 300px;
                width: 90%;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            `;
            
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long' 
            });
            
            modal.innerHTML = `
                <h3 style="margin: 0 0 16px 0; color: #2d333a; text-align: center;">Agregar Evento</h3>
                <p style="margin: 0 0 20px 0; color: #666; text-align: center; font-size: 14px;">${formattedDate}</p>
                
                <div style="display: grid; gap: 12px;">
                    <button class="event-option" data-type="agendar-cita" style="background: #10a37f; color: white;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            <path d="m9 14 2 2 4-4"></path>
                        </svg>
                        Agendar Cita
                    </button>
                    
                    <button class="event-option" data-type="vacaciones" style="background: #dc2626; color: white;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        Vacaciones
                    </button>
                    
                    <button class="event-option" data-type="libre" style="background: #059669; color: white;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                        Libre
                    </button>
                    
                    <button class="event-option" data-type="compromiso" style="background: #d97706; color: white;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                        Compromiso
                    </button>
                    
                    <button class="event-option" data-type="salida" style="background: #7c3aed; color: white;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                        </svg>
                        Salida
                    </button>
                    
                    <button class="event-option" data-type="sin-pega" style="background: #6b7280; color: white;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                        Sin Pega
                    </button>
                </div>
                
                <button onclick="this.closest('.event-modal-overlay').remove()" style="
                    width: 100%;
                    background: var(--bg-tertiary);
                    color: var(--text-tertiary);
                    border: none;
                    border-radius: 8px;
                    padding: 12px;
                    margin-top: 16px;
                    font-weight: 600;
                    cursor: pointer;
                ">Cancelar</button>
            `;
            
            // Add event listeners to options
            const options = modal.querySelectorAll('.event-option');
            options.forEach(option => {
                option.style.cssText += `
                    border: none;
                    border-radius: 8px;
                    padding: 12px;
                    font-weight: 600;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.2s;
                `;
                
                option.addEventListener('click', () => {
                    const eventType = option.getAttribute('data-type');
                    
                    if (eventType === 'agendar-cita') {
                        // Navigate to schedule view instead of adding an event
                        overlay.remove();
                        showView('schedule');
                    } else {
                        // Add regular event to the day
                        addEventToDay(dateStr, eventType);
                        overlay.remove();
                    }
                });
                
                option.addEventListener('mouseover', () => {
                    option.style.transform = 'translateY(-1px)';
                    option.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                });
                
                option.addEventListener('mouseout', () => {
                    option.style.transform = 'translateY(0)';
                    option.style.boxShadow = 'none';
                });
            });
            
            overlay.className = 'event-modal-overlay';
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }
        
        // Function to add event to day
        function addEventToDay(dateStr, eventType) {
            let events = JSON.parse(localStorage.getItem('dayEvents') || '{}');
            events[dateStr] = eventType;
            localStorage.setItem('dayEvents', JSON.stringify(events));
            
            // Regenerate calendar to show the event
            generateWeeklyCalendar();
        }
        
        // Function to get event for day
        function getDayEvent(dateStr) {
            const events = JSON.parse(localStorage.getItem('dayEvents') || '{}');
            return events[dateStr] || null;
        }
        
        // Function to remove event from day
        function removeEventFromDay(dateStr) {
            let events = JSON.parse(localStorage.getItem('dayEvents') || '{}');
            delete events[dateStr];
            localStorage.setItem('dayEvents', JSON.stringify(events));
            
            // Regenerate calendar to remove the event
            generateWeeklyCalendar();
        }

        // Function to open Google Maps
        function openGoogleMaps(address, city) {
            const fullAddress = `${address}, ${city}, Utah`;
            const encodedAddress = encodeURIComponent(fullAddress);
            
            // Try to open in Google Maps app first (mobile), then web
            const mapsAppUrl = `comgooglemaps://?q=${encodedAddress}`;
            const mapsWebUrl = `https://www.google.com/maps/search/${encodedAddress}`;
            
            // Detect if we're on mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Try to open native app first
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = mapsAppUrl;
                document.body.appendChild(iframe);
                
                // Fallback to web after a short delay
                setTimeout(() => {
                    document.body.removeChild(iframe);
                    window.open(mapsWebUrl, '_blank');
                }, 500);
            } else {
                // Desktop - open in new tab
                window.open(mapsWebUrl, '_blank');
            }
        }

        // Handle window resize for mobile/desktop view switching
        window.addEventListener('resize', function() {
            if (currentView === 'calendar') {
                generateWeeklyCalendar();
            }
        });

        // Initialize
        // Test functions for debugging
        window.testMobileMenu = function() {
            console.log('ðŸ§ª Testing mobile menu...');
            toggleMobileMenu();
        };
        
        window.testJobDropdown = function() {
            console.log('ðŸ§ª Testing job dropdown...');
            toggleJobDropdown();
        };
        
        // ================================
        // OFFLINE-FIRST TESTING FUNCTIONS
        // ================================
        
        window.testOfflineMode = async function() {
            console.log('ðŸ§ª Testing offline functionality...');
            const syncStatus = await OfflineDB.getSyncStatus();
            console.log('ðŸ“Š Current sync status:', syncStatus);
            
            // Create a test appointment
            const testAppointment = {
                id: 'test_' + Date.now(),
                name: 'Test Client',
                date: new Date().toISOString().split('T')[0],
                time: '10:00',
                job: 'Alfombras',
                address: 'Test Address',
                price: 100
            };
            
            console.log('ðŸ“ Creating test appointment...');
            await OfflineDB.saveAppointment(testAppointment);
            
            const appointments = await OfflineDB.getAppointments();
            console.log('ðŸ“‹ All appointments:', appointments.length);
            
            await updateSyncStatusUI();
            console.log('âœ… Offline test completed!');
        };
        
        window.testSync = async function() {
            console.log('ðŸ”„ Testing sync functionality...');
            await OfflineDB.syncWithSupabase();
            const status = await OfflineDB.getSyncStatus();
            console.log('ðŸ“Š Sync status after sync:', status);
            await updateSyncStatusUI();
            console.log('âœ… Sync test completed!');
        };
        
        window.clearOfflineData = async function() {
            if (confirm('ðŸš¨ This will clear all offline data. Are you sure?')) {
                localStorage.clear();
                if (dbInstance) {
                    await dbInstance.clear('appointments');
                    await dbInstance.clear('syncQueue');
                    await dbInstance.clear('settings');
                }
                console.log('ðŸ§¹ Offline data cleared!');
                await updateSyncStatusUI();
            }
        };
        
        // ================================
        // BACKUP SYSTEM TESTING FUNCTIONS
        // ================================
        
        window.testBackup = async function() {
            console.log('ðŸ“¦ Testing backup system...');
            const backupData = await BackupSystem.createFullBackup();
            console.log('âœ… Backup created:', {
                totalAppointments: backupData.metadata.totalAppointments,
                created: backupData.metadata.created,
                size: JSON.stringify(backupData).length + ' characters'
            });
            return backupData;
        };
        
        window.downloadBackupNow = async function() {
            console.log('ðŸ’¾ Downloading backup...');
            await BackupSystem.downloadBackup();
        };
        
        window.forceBackupCheck = async function() {
            console.log('ðŸ”„ Forcing daily backup check...');
            // Clear last backup time to force new backup
            localStorage.removeItem('lastBackupTime');
            const created = await BackupSystem.checkAndCreateDailyBackup();
            console.log(created ? 'âœ… Backup created' : 'âŒ No backup needed');
            updateBackupStatusUI();
        };
        
        window.showBackupStatus = function() {
            const status = BackupSystem.getBackupStatus();
            console.log('ðŸ“Š Backup Status:', status);
            const lastBackup = localStorage.getItem('lastBackupTime');
            if (lastBackup) {
                console.log('ðŸ“… Last backup:', new Date(lastBackup).toLocaleString());
            }
        };

        // Function to check if URL contains receipt data and display it
        async function checkForReceiptInURL() {
            const hash = window.location.hash;
            const params = new URLSearchParams(window.location.search);
            const path = window.location.pathname;
            
            console.log('=== URL DETECTION DEBUG ===');
            console.log('Full URL:', window.location.href);
            console.log('Hash:', hash);
            console.log('Search params:', window.location.search);
            console.log('Path:', path);
            console.log('Has r param:', params.has('r'));
            if (params.has('r')) {
                console.log('r param value:', params.get('r'));
            }
            console.log('========================');
            
            // Check for receipt data format in hash
            if (hash.startsWith('#receipt=')) {
                try {
                    const encodedData = hash.replace('#receipt=', '');
                    const receiptData = JSON.parse(atob(encodedData));
                    
                    // Create receipt page and replace current content
                    displayReceiptPage(receiptData);
                    return true; // Receipt displayed
                } catch (error) {
                    console.error('Error loading receipt from hash:', error);
                    alert('Error cargando el recibo. El enlace puede estar daÃ±ado.');
                    return false;
                }
            }
            
            // Check for short receipt ID format in hash (#RC001)
            if (hash.startsWith('#RC')) {
                try {
                    const shortId = hash.replace('#', '');
                    console.log('Looking for receipt short ID in localStorage:', shortId);
                    
                    const receiptDataStr = localStorage.getItem(shortId);
                    if (receiptDataStr) {
                        const receiptData = JSON.parse(receiptDataStr);
                        console.log('Found receipt in localStorage:', receiptData);
                        
                        // Create receipt page and replace current content
                        displayReceiptPage(receiptData);
                        return true; // Receipt displayed
                    } else {
                        console.error('Receipt not found in localStorage for short ID:', shortId);
                        alert('Recibo no encontrado. El enlace puede haber expirado.');
                        return false;
                    }
                } catch (error) {
                    console.error('Error loading receipt from localStorage:', error);
                    alert('Error cargando el recibo. El enlace puede estar daÃ±ado.');
                    return false;
                }
            }
            
            // Check for compressed receipt data in query params (?data=)
            if (params.has('data')) {
                try {
                    const encodedData = params.get('data');
                    console.log('Found compressed receipt data in URL');
                    
                    const compressedData = JSON.parse(atob(encodedData));
                    console.log('Decoded compressed data:', compressedData);
                    
                    // Reconstruct full receipt data from compressed format
                    const receiptData = {
                        receiptNumber: compressedData.n,
                        clientName: compressedData.c,
                        clientPhone: compressedData.p,
                        services: compressedData.s.map(s => ({ service: s.n, total: s.p })),
                        totalAmount: compressedData.t,
                        date: new Date().toISOString(), // Use current date
                        address: '', // Not included in compressed data
                        city: '' // Not included in compressed data
                    };
                    
                    console.log('Reconstructed receipt data:', receiptData);
                    
                    // AUTO-GENERATE the receipt (expert solution)
                    await autoGenerateReceiptPage(receiptData);
                    return true; // Receipt displayed
                } catch (error) {
                    console.error('Error loading compressed receipt:', error);
                    alert('Error cargando el recibo. El enlace puede estar daÃ±ado.');
                    return false;
                }
            }
            
            // Check for short receipt ID in query params (?id=) - legacy support
            if (params.has('id')) {
                try {
                    const shortId = params.get('id');
                    console.log('Found short receipt ID in URL:', shortId);
                    
                    // Try to find receipt data in localStorage
                    let receiptDataStr = localStorage.getItem(`receipt_${shortId}`);
                    
                    // If not found, try backup keys
                    if (!receiptDataStr) {
                        console.log('Trying backup storage keys...');
                        const possibleKeys = [
                            `RC_${shortId}`,
                            `RC_${shortId.slice(0, 3)}`,
                            shortId,
                            `receipt_${shortId.slice(0, 7)}`
                        ];
                        
                        for (const key of possibleKeys) {
                            receiptDataStr = localStorage.getItem(key);
                            if (receiptDataStr) {
                                console.log('Found receipt data with backup key:', key);
                                break;
                            }
                        }
                    }
                    
                    if (receiptDataStr) {
                        const receiptData = JSON.parse(receiptDataStr);
                        console.log('Found receipt data:', receiptData);
                        
                        // Create receipt page and replace current content
                        displayReceiptPage(receiptData);
                        return true; // Receipt displayed
                    } else {
                        console.error('Receipt not found for ID:', shortId);
                        alert('Recibo no encontrado. El enlace puede haber expirado o necesita ser generado desde el mismo dispositivo.');
                        return false;
                    }
                } catch (error) {
                    console.error('Error loading receipt by ID:', error);
                    alert('Error cargando el recibo. El enlace puede estar daÃ±ado.');
                    return false;
                }
            }
            
            // Check for self-contained receipt data in query params (?receipt=) - legacy support
            if (params.has('receipt')) {
                try {
                    const encodedData = params.get('receipt');
                    console.log('Found self-contained receipt data in URL');
                    
                    const receiptData = JSON.parse(atob(encodedData));
                    console.log('Decoded receipt data:', receiptData);
                    
                    // Create receipt page and replace current content
                    displayReceiptPage(receiptData);
                    return true; // Receipt displayed
                } catch (error) {
                    console.error('Error loading self-contained receipt:', error);
                    alert('Error cargando el recibo. El enlace puede estar daÃ±ado.');
                    return false;
                }
            }
            
            // Check for ultra-short receipt ID in URL path (bit.ly/RZR123ABC redirects to /r/123ABC)
            const pathMatch = path.match(/\/r\/([A-Z0-9]{6})$/);
            if (pathMatch) {
                try {
                    const shortId = pathMatch[1];
                    console.log('Looking for ultra-short receipt ID:', shortId);
                    
                    // Try localStorage first
                    let receiptDataStr = localStorage.getItem(`receipt_${shortId}`);
                    
                    // If not found, try server
                    if (!receiptDataStr) {
                        console.log('Not found in localStorage, trying server...');
                        try {
                            const response = await fetch(`/api/get-receipt/${shortId}`);
                            if (response.ok) {
                                const serverData = await response.json();
                                receiptDataStr = JSON.stringify(serverData.data || serverData);
                            }
                        } catch (e) {
                            console.log('Server not available');
                        }
                    }
                    
                    if (receiptDataStr) {
                        const receiptData = JSON.parse(receiptDataStr);
                        console.log('Found receipt data, AUTO-GENERATING PDF:', receiptData);
                        
                        // EXPERT SOLUTION: Auto-generate receipt page immediately
                        await autoGenerateReceiptPage(receiptData);
                        return true; // Receipt displayed
                    } else {
                        console.error('Receipt not found for ID:', shortId);
                        document.body.innerHTML = `
                            <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                                <h2>ðŸ” Recibo no encontrado</h2>
                                <p>El enlace puede haber expirado o el recibo fue generado en otro dispositivo.</p>
                                <a href="/" style="background: #10a37f; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Volver al inicio</a>
                            </div>`;
                        return true; // We handled it
                    }
                } catch (error) {
                    console.error('Error loading ultra-short receipt:', error);
                    document.body.innerHTML = `
                        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                            <h2>âŒ Error</h2>
                            <p>No se pudo cargar el recibo. El enlace puede estar daÃ±ado.</p>
                            <a href="/" style="background: #10a37f; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Volver al inicio</a>
                        </div>`;
                    return true; // We handled it
                }
            }
            
            // Check for receipt ID format in query params (?r=) - LEGACY SUPPORT
            if (params.has('r')) {
                try {
                    const receiptId = params.get('r');
                    console.log('Looking for receipt ID:', receiptId);
                    
                    // Try localStorage first
                    let receiptDataStr = localStorage.getItem(`receipt_${receiptId}`);
                    
                    // If not found, try server
                    if (!receiptDataStr) {
                        console.log('Not found in localStorage, trying server...');
                        try {
                            const response = await fetch(`/api/get-receipt/${receiptId}`);
                            if (response.ok) {
                                const serverData = await response.json();
                                receiptDataStr = JSON.stringify(serverData.data);
                            }
                        } catch (e) {
                            console.log('Server not available');
                        }
                    }
                    
                    if (receiptDataStr) {
                        const receiptData = JSON.parse(receiptDataStr);
                        console.log('Found receipt data, AUTO-GENERATING PDF:', receiptData);
                        
                        // EXPERT SOLUTION: Auto-generate receipt page immediately
                        await autoGenerateReceiptPage(receiptData);
                        return true; // Receipt displayed
                    } else {
                        console.error('Receipt not found for ID:', receiptId);
                        document.body.innerHTML = `
                            <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                                <h2>ðŸ” Recibo no encontrado</h2>
                                <p>El enlace puede haber expirado o el recibo fue generado en otro dispositivo.</p>
                                <a href="/" style="background: #10a37f; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Volver al inicio</a>
                            </div>`;
                        return true; // We handled it
                    }
                } catch (error) {
                    console.error('Error loading receipt:', error);
                    document.body.innerHTML = `
                        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                            <h2>âŒ Error</h2>
                            <p>No se pudo cargar el recibo. El enlace puede estar daÃ±ado.</p>
                            <a href="/" style="background: #10a37f; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Volver al inicio</a>
                        </div>`;
                    return true; // We handled it
                }
            }
            
            // Check for receipt ID format in path (/RC220)
            const legacyPathMatch = path.match(/\/RC(\d+)$/);
            if (legacyPathMatch) {
                try {
                    const shortId = `RC${legacyPathMatch[1]}`;
                    console.log('Looking for receipt short ID in localStorage:', shortId);
                    
                    const receiptDataStr = localStorage.getItem(shortId);
                    if (receiptDataStr) {
                        const receiptData = JSON.parse(receiptDataStr);
                        console.log('Found receipt in localStorage:', receiptData);
                        
                        // Create receipt page and replace current content
                        displayReceiptPage(receiptData);
                        return true; // Receipt displayed
                    } else {
                        console.error('Receipt not found in localStorage for short ID:', shortId);
                        alert('Recibo no encontrado. El enlace puede haber expirado.');
                        return false;
                    }
                } catch (error) {
                    console.error('Error loading receipt from localStorage:', error);
                    alert('Error cargando el recibo. El enlace puede estar daÃ±ado.');
                    return false;
                }
            }
            
            // Check if we should show the latest receipt (when no specific receipt requested)
            if (path === '/' || path === '/receipt' || path === '') {
                const latestReceipt = localStorage.getItem('latestReceipt');
                const timestamp = localStorage.getItem('latestReceiptTimestamp');
                
                // Show latest receipt if it's recent (within 24 hours)
                if (latestReceipt && timestamp) {
                    const ageInHours = (Date.now() - parseInt(timestamp)) / (1000 * 60 * 60);
                    if (ageInHours < 24) {
                        try {
                            const receiptData = JSON.parse(latestReceipt);
                            console.log('Showing latest receipt:', receiptData);
                            displayReceiptPage(receiptData);
                            return true;
                        } catch (error) {
                            console.error('Error loading latest receipt:', error);
                        }
                    }
                }
            }
            
            return false; // No receipt in URL
        }

        // EXPERT SOLUTION: Auto-generate receipt page with PDF ready
        async function autoGenerateReceiptPage(data) {
            console.log('AUTO-GENERATING receipt page for:', data);
            
            // Clear the page
            document.body.innerHTML = '';
            document.body.style.fontFamily = 'Arial, sans-serif';
            document.body.style.margin = '0';
            document.body.style.padding = '20px';
            document.body.style.background = '#f5f5f5';
            
            // Show loading first
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h2>ðŸ§¾ Generando tu recibo...</h2>
                    <p>Un momento por favor</p>
                </div>`;
            
            // Wait a moment for visual feedback
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Auto-generate the receipt display
            displayReceiptPage(data);
            
            // Auto-generate PDF after showing receipt
            setTimeout(async () => {
                if (typeof window.jspdf !== 'undefined') {
                    console.log('Auto-generating PDF...');
                    // Create a download button that works
                    const downloadBtn = document.createElement('button');
                    downloadBtn.innerHTML = 'ðŸ“„ Descargar PDF';
                    downloadBtn.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10a37f; color: white; border: none; padding: 15px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                    downloadBtn.onclick = () => generatePDFFromDataHTML(data);
                    document.body.appendChild(downloadBtn);
                }
            }, 500);
        }

        // Display receipt page  
        function displayReceiptPage(data) {
            const receiptDate = new Date(data.date).toLocaleDateString('es-ES');
            
            // Create simple receipt page
            document.body.innerHTML = '';
            document.body.style.fontFamily = 'Arial, sans-serif';
            document.body.style.margin = '0';
            document.body.style.padding = '20px';
            document.body.style.background = '#f5f5f5';
            
            const container = document.createElement('div');
            container.style.maxWidth = '800px';
            container.style.margin = '0 auto';
            container.style.background = 'white';
            container.style.padding = isMobile ? '15px' : '30px';
            container.style.borderRadius = '10px';
            container.style.boxShadow = '0 4px 20px rgba(0,0,0,0.1)';
            
            // Add mobile responsive styling to body
            if (isMobile) {
                document.body.style.padding = '10px';
            }
            
            // Header - Mobile optimized
            const header = document.createElement('div');
            header.style.background = 'linear-gradient(135deg, #444 60%, #00bfff 60%)';
            header.style.color = 'white';
            header.style.padding = window.innerWidth <= 768 ? '20px' : '30px';
            header.style.borderRadius = '10px';
            header.style.marginBottom = '20px';
            
            // Check if mobile
            const isMobile = window.innerWidth <= 768;
            
            header.innerHTML = `
                <div style="display: ${isMobile ? 'block' : 'flex'}; ${isMobile ? '' : 'justify-content: space-between;'}">
                    <div style="${isMobile ? 'text-align: center; margin-bottom: 20px;' : ''}">
                        <h1 style="margin: 0; color: #00bfff; font-size: ${isMobile ? '18px' : '24px'};">ðŸ§½ RIZE PROFESSIONAL CLEANING</h1>
                        <p style="margin: 5px 0; font-size: ${isMobile ? '12px' : '14px'};">Professional Cleaning Services</p>
                        <p style="margin: 2px 0; font-size: ${isMobile ? '11px' : '14px'};">ðŸ“ž (801) 739-0700</p>
                        ${isMobile ? '' : '<p style="margin: 2px 0; font-size: 14px;">ðŸ“§ info@rizecleaning.com</p>'}
                    </div>
                    <div style="text-align: ${isMobile ? 'center' : 'right'};">
                        <h2 style="margin: 0; font-size: ${isMobile ? '24px' : '32px'}; color: #333;">INVOICE</h2>
                        <p style="font-size: ${isMobile ? '12px' : '14px'};">Invoice No: ${data.receiptNumber}</p>
                        <p style="font-size: ${isMobile ? '12px' : '14px'};">Date: ${receiptDate}</p>
                        <div style="background: #333; padding: ${isMobile ? '8px 12px' : '10px'}; border-radius: 5px; margin-top: 10px; display: inline-block;">
                            <strong style="font-size: ${isMobile ? '16px' : '18px'};">TOTAL: $${data.totalAmount.toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            // Client info
            const clientInfo = document.createElement('div');
            clientInfo.style.marginBottom = '30px';
            clientInfo.innerHTML = `
                <h3 style="color: #333; margin-bottom: 15px;">BILL TO</h3>
                <p style="margin: 5px 0; font-weight: bold;">${data.clientName.toUpperCase()}</p>
                <p style="margin: 5px 0;">ðŸ“ž ${data.clientPhone}</p>
                ${data.address ? `<p style="margin: 5px 0;">ðŸ“ ${data.address}</p>` : ''}
                ${data.city ? `<p style="margin: 5px 0;">${data.city}</p>` : ''}
            `;
            
            // Services table - Mobile optimized
            const servicesTable = document.createElement('div');
            servicesTable.style.marginBottom = '20px';
            servicesTable.style.overflowX = 'auto';
            
            if (isMobile) {
                // Mobile: Stack format instead of table
                let mobileServicesHTML = '<div>';
                data.services.forEach((service, index) => {
                    mobileServicesHTML += `
                        <div style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; padding: 15px; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">${service.service}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px;">
                                <span>Cantidad: 1</span>
                                <span style="font-weight: bold; color: #00bfff;">$${service.total.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                mobileServicesHTML += '</div>';
                servicesTable.innerHTML = mobileServicesHTML;
            } else {
                // Desktop: Table format
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                
                let tableHTML = `
                    <thead>
                        <tr style="background: #00bfff; color: white;">
                            <th style="padding: 15px; text-align: left; border: 1px solid #ddd;">Service</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #ddd;">Qty</th>
                            <th style="padding: 15px; text-align: right; border: 1px solid #ddd;">Unit Price</th>
                            <th style="padding: 15px; text-align: right; border: 1px solid #ddd;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                data.services.forEach((service, index) => {
                    const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                    tableHTML += `
                        <tr style="background: ${rowColor};">
                            <td style="padding: 12px; border: 1px solid #ddd;">${service.service}</td>
                            <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">1</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${service.total.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$${service.total.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody>';
                table.innerHTML = tableHTML;
                servicesTable.appendChild(table);
            }
            
            // Totals section - Mobile optimized
            const totals = document.createElement('div');
            totals.style.display = isMobile ? 'block' : 'flex';
            totals.style.justifyContent = isMobile ? 'center' : 'space-between';
            totals.style.marginBottom = '20px';
            
            if (isMobile) {
                totals.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="background: #333; color: white; padding: 20px; border-radius: 8px; margin: 10px 0;">
                            <div style="font-size: 18px; font-weight: bold;">GRAND TOTAL: $${data.totalAmount.toFixed(2)}</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="color: #00bfff; margin: 0 0 10px 0; font-size: 16px;">Payment Methods</h4>
                            <p style="margin: 5px 0; font-size: 13px;">Cash, Check, Credit Card, Zelle</p>
                            <p style="margin: 5px 0; font-size: 13px;">PayPal, Venmo, Apple Pay</p>
                            <h4 style="color: #00bfff; margin: 15px 0 5px 0; font-size: 16px;">Terms</h4>
                            <p style="margin: 5px 0; font-size: 13px;">Payment due within 30 days</p>
                        </div>
                    </div>
                `;
            } else {
                totals.innerHTML = `
                    <div>
                        <h4 style="color: #00bfff;">Payment Methods We Accept</h4>
                        <p>Cash, Check, Credit Card, Zelle, PayPal, Venmo, Apple Pay</p>
                        <h4 style="color: #00bfff;">Terms & Conditions</h4>
                        <p>Payment due within 30 days</p>
                    </div>
                    <div style="text-align: right; min-width: 250px;">
                        <div style="border-bottom: 1px solid #eee; padding: 8px 0;">
                            <span>SUB TOTAL: </span><strong>$${data.totalAmount.toFixed(2)}</strong>
                        </div>
                        <div style="border-bottom: 1px solid #eee; padding: 8px 0;">
                            <span>TAX, VAT: </span><strong>$0.00</strong>
                        </div>
                        <div style="border-bottom: 1px solid #eee; padding: 8px 0;">
                            <span>DISCOUNT: </span><strong>$0.00</strong>
                        </div>
                        <div style="background: #333; color: white; padding: 15px; margin: 15px 0; border-radius: 5px;">
                            <span>GRAND TOTAL: </span><strong>$${data.totalAmount.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            }
            
            // Action buttons - Mobile optimized
            const buttons = document.createElement('div');
            buttons.style.textAlign = 'center';
            buttons.style.marginBottom = isMobile ? '15px' : '30px';
            
            const printBtn = document.createElement('button');
            printBtn.innerHTML = 'ðŸ–¨ï¸ Imprimir Recibo';
            printBtn.style.background = '#00bfff';
            printBtn.style.color = 'white';
            printBtn.style.border = 'none';
            printBtn.style.padding = isMobile ? '15px 20px' : '12px 24px';
            printBtn.style.borderRadius = '8px';
            printBtn.style.fontSize = isMobile ? '18px' : '16px';
            printBtn.style.cursor = 'pointer';
            printBtn.style.margin = isMobile ? '8px 0' : '5px';
            printBtn.style.width = isMobile ? '90%' : 'auto';
            printBtn.style.display = isMobile ? 'block' : 'inline-block';
            printBtn.onclick = () => window.print();
            
            const downloadBtn = document.createElement('button');
            downloadBtn.innerHTML = 'ðŸ“„ Descargar PDF';
            downloadBtn.style.background = '#444';
            downloadBtn.style.color = 'white';
            downloadBtn.style.border = 'none';
            downloadBtn.style.padding = isMobile ? '15px 20px' : '12px 24px';
            downloadBtn.style.borderRadius = '8px';
            downloadBtn.style.fontSize = isMobile ? '18px' : '16px';
            downloadBtn.style.cursor = 'pointer';
            downloadBtn.style.margin = isMobile ? '8px 0' : '5px';
            downloadBtn.style.width = isMobile ? '90%' : 'auto';
            downloadBtn.style.display = isMobile ? 'block' : 'inline-block';
            downloadBtn.onclick = () => {
                window.print();
                setTimeout(() => {
                    alert('ðŸ’¡ Para descargar como PDF:\n1. En la ventana de impresiÃ³n, selecciona "Guardar como PDF"\n2. O usa "Imprimir a PDF" segÃºn tu navegador');
                }, 1000);
            };
            
            buttons.appendChild(printBtn);
            buttons.appendChild(downloadBtn);
            
            // Footer
            const footer = document.createElement('div');
            footer.style.background = 'linear-gradient(135deg, #00bfff 70%, #444 70%)';
            footer.style.color = 'white';
            footer.style.textAlign = 'center';
            footer.style.padding = '20px';
            footer.style.borderRadius = '10px';
            footer.innerHTML = '<h3 style="margin: 0;">THANK YOU FOR YOUR BUSINESS</h3>';
            
            // Append all elements
            container.appendChild(header);
            container.appendChild(clientInfo);
            container.appendChild(servicesTable);
            container.appendChild(totals);
            container.appendChild(buttons);
            container.appendChild(footer);
            
            document.body.appendChild(container);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize mobile menu button event listener
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }
            
            // Check if we need to show a receipt from URL
            if (await checkForReceiptInURL()) {
                return; // Stop normal initialization if showing receipt
            }
            
            // Initialize dark mode first
            initDarkMode();
            
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Check backend availability
            checkBackendHealth();
            
            // Initialize IndexedDB for offline-first functionality
            console.log('ðŸ—„ï¸  Initializing offline database...');
            await initDB();
            
            // Show sync status in console
            const syncStatus = await OfflineDB.getSyncStatus();
            console.log('ðŸ“Š Sync Status:', syncStatus);
            
            // Setup online/offline event handlers
            window.addEventListener('online', async () => {
                console.log('ðŸŒ Back online! Syncing queued changes...');
                await updateSyncStatusUI();
                await OfflineDB.syncWithSupabase();
                const newStatus = await OfflineDB.getSyncStatus();
                console.log('ðŸ“Š Sync completed. New status:', newStatus);
                await updateSyncStatusUI();
            });
            
            window.addEventListener('offline', async () => {
                console.log('ðŸ“´ Gone offline. Changes will be queued for sync.');
                await updateSyncStatusUI();
            });
            
            // Update sync status more frequently to catch online/offline changes
            setInterval(updateSyncStatusUI, 2000); // Every 2 seconds
            
            // Initial sync status update
            await updateSyncStatusUI();
            
            // Add manual test function for status (for debugging)
            window.testOfflineStatus = function() {
                console.log('ðŸ§ª Testing offline status simulation...');
                const statusElement = document.getElementById('sync-status');
                const statusText = statusElement?.querySelector('.status-text');
                const statusIcon = statusElement?.querySelector('.status-icon');
                
                if (statusElement && statusText && statusIcon) {
                    statusElement.classList.remove('online', 'syncing');
                    statusElement.classList.add('offline');
                    statusText.textContent = 'Offline (Test)';
                    statusIcon.innerHTML = '<path d="M17 7L15.59 5.59L12 9.17 8.41 5.59L7 7l4 4-4 4 1.41 1.41L12 12.83l3.59 3.58L17 15l-4-4 4-4zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>';
                    console.log('ðŸ“´ Status manually set to offline for testing');
                }
                
                // Reset after 3 seconds
                setTimeout(() => {
                    console.log('ðŸ”„ Resetting status to actual state...');
                    updateSyncStatusUI();
                }, 3000);
            };

            // Add debug functions for calendar
            window.debugCalendar = function() {
                console.log('ðŸ” CALENDAR DEBUG INFO:');
                console.log('ðŸ“… currentWeekStart:', currentWeekStart ? currentWeekStart.toDateString() : 'undefined');
                console.log('ðŸ“… Today:', new Date().toDateString());
                console.log('ðŸ“… Current view:', currentView);
                console.log('ðŸ“… Is mobile:', window.innerWidth <= 768);
                
                // Show the 7 days that should be displayed
                if (currentWeekStart) {
                    console.log('ðŸ“… Week days:');
                    for (let i = 0; i < 7; i++) {
                        const day = new Date(currentWeekStart);
                        day.setDate(currentWeekStart.getDate() + i);
                        console.log(`  Day ${i}: ${day.toDateString()} (${day.getDate()})`);
                    }
                }
            };

            window.resetToToday = function() {
                console.log('ðŸ”„ Resetting calendar to today...');
                setCurrentWeek();
                if (currentView === 'calendar') {
                    generateWeeklyCalendar();
                }
            };

            // Production mode helper
            window.switchToProductionMode = function() {
                console.log('ðŸš€ SWITCHING TO PRODUCTION MODE');
                console.log('This would disable all development logs and enable production optimizations.');
                console.log('In a real deployment, you would:');
                console.log('1. Remove all console.log statements');
                console.log('2. Minify the code');
                console.log('3. Enable service worker for offline functionality');
                console.log('4. Set production API endpoints');
                console.log('5. Enable error reporting');
            };
            
            // Initialize backup system
            console.log('ðŸ“¦ Initializing backup system...');
            updateBackupStatusUI();
            
            // Check for daily backup
            const backupCreated = await BackupSystem.checkAndCreateDailyBackup();
            if (backupCreated) {
                updateBackupStatusUI();
            }
            
            // Update backup status every hour
            setInterval(() => {
                updateBackupStatusUI();
            }, 60 * 60 * 1000); // Every hour
            
            // Development mode only
            if (window.location.hostname === 'localhost' || window.location.protocol === 'file:') {
                console.log('ðŸš€ Page loaded. Test with: testMobileMenu() or testJobDropdown()');
            }
            
            // Update gas prices on load and check daily
            updateGasPrice();
            
            // Removed: reminder system initialization
            
            // Check every minute if the day changed and update calendar if needed
            setInterval(function() {
                if (currentView === 'calendar' && updateToCurrentDay()) {
                    generateWeeklyCalendar();
                }
                // Also check if we need to update gas prices (once per day)
                const today = new Date().toDateString();
                const lastGasUpdate = localStorage.getItem('gasPrice_lastUpdate');
                if (lastGasUpdate !== today) {
                    updateGasPrice();
                }
                
                // Removed: reminder checking code
            }, 60000); // Check every minute
            
            setupEventListeners();
            loadAppointments();
            setTodayDate();
            setupNavigation();
            setCurrentWeek();
            setupJobCheckboxes();
            setupRegistrySearch();
            setupMobileMenuClose();
            
            // Focus on direct SMS with PDF attachment only
        });
        
        // Removed: reminder system initialization function

        function setupRegistrySearch() {
            // Real-time search as user types
            const searchName = document.getElementById('search-name');
            const searchCity = document.getElementById('search-city');
            const searchJob = document.getElementById('search-job');

            if (searchName) {
                searchName.addEventListener('input', searchClients);
            }
            if (searchCity) {
                searchCity.addEventListener('change', searchClients);
            }
            if (searchJob) {
                searchJob.addEventListener('change', searchClients);
            }
        }

        function setCurrentWeek() {
            // Always start from today (not traditional week start)
            const today = new Date();
            currentWeekStart = new Date(today);
            currentWeekStart.setHours(0, 0, 0, 0);
        }

        function updateToCurrentDay() {
            // Check if we need to update currentWeekStart to today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // If today is not the first day being shown, update to start from today
            if (currentWeekStart.getTime() !== today.getTime()) {
                currentWeekStart = new Date(today);
                return true; // Indicates update was needed
            }
            return false; // No update needed
        }

        function setupJobCheckboxes() {
            // Setup event listeners for the custom dropdown
            const checkboxes = document.querySelectorAll('#job-list input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateJobSelection);
                
                // Add touch-friendly click handler for PWA mode
                checkbox.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    setTimeout(() => {
                        this.checked = !this.checked;
                        updateJobSelection();
                    }, 50);
                });
            });
            
            // Setup dropdown item click handlers for PWA mode
            const dropdownItems = document.querySelectorAll('#job-list .dropdown-item');
            dropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    if (checkbox && e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        updateJobSelection();
                    }
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('job-dropdown');
                if (!dropdown.contains(event.target)) {
                    closeJobDropdown();
                }
            });
            
            updateJobSelection(); // Initialize
        }

        function toggleJobDropdown() {
            const isDevelopment = window.location.hostname === 'localhost' || window.location.protocol === 'file:';
            
            if (isDevelopment) {
                console.log('ðŸ“‹ toggleJobDropdown called');
            }
            
            const dropdown = document.getElementById('job-dropdown');
            const header = dropdown.querySelector('.dropdown-header');
            const list = document.getElementById('job-list');
            
            if (isDevelopment) {
                console.log('Elements found:', {dropdown: !!dropdown, header: !!header, list: !!list});
            }
            
            if (list.classList.contains('show')) {
                closeJobDropdown();
            } else {
                openJobDropdown();
            }
        }

        function openJobDropdown() {
            const header = document.querySelector('.dropdown-header');
            const list = document.getElementById('job-list');
            
            header.classList.add('open');
            list.classList.add('show');
        }

        function closeJobDropdown() {
            const header = document.querySelector('.dropdown-header');
            const list = document.getElementById('job-list');
            
            header.classList.remove('open');
            list.classList.remove('show');
        }

        function updateJobSelection() {
            const checkboxes = document.querySelectorAll('#job-list input[type="checkbox"]');
            const hiddenSelect = document.getElementById('job');
            const placeholder = document.getElementById('job-placeholder');
            
            // Get selected values
            const selectedValues = [];
            const selectedLabels = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedValues.push(checkbox.value);
                    selectedLabels.push(checkbox.nextElementSibling.textContent);
                }
            });
            
            // Update hidden select for form submission
            Array.from(hiddenSelect.options).forEach(option => {
                option.selected = selectedValues.includes(option.value);
            });
            
            // Update placeholder text
            if (selectedLabels.length === 0) {
                placeholder.textContent = 'Seleccionar trabajo';
            } else if (selectedLabels.length === 1) {
                placeholder.textContent = selectedLabels[0];
            } else {
                placeholder.textContent = `${selectedLabels.length} trabajos seleccionados`;
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('es-ES', options);
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function setupEventListeners() {
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.getElementById('upload-area');
            const form = document.getElementById('appointment-form');

            console.log('ðŸ”§ Setting up event listeners...');
            console.log('ðŸ”§ Form element found:', !!form);
            console.log('ðŸ”§ Form element:', form);

            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            // Form submit
            if (form) {
                form.addEventListener('submit', handleFormSubmit);
                console.log('ðŸ”§ Form submit listener added');
            } else {
                console.error('ðŸ”§ ERROR: appointment-form not found!');
            }

            // Edit form submit
            const editForm = document.getElementById('edit-appointment-form');
            if (editForm) {
                editForm.addEventListener('submit', handleEditFormSubmit);
                console.log('ðŸ”§ Edit form submit listener added');
            }

            // Modal click outside to close
            document.getElementById('appointment-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAppointmentModal();
                }
            });

            document.getElementById('reschedule-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRescheduleModal();
                }
            });

            document.getElementById('client-details-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeClientDetailsModal();
                }
            });

            document.getElementById('edit-appointment-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditAppointmentModal();
                }
            });

            // Make functions globally available
            window.viewClientDetails = viewClientDetails;
            window.closeClientDetailsModal = closeClientDetailsModal;
            window.editAppointment = editAppointment;
            window.closeEditAppointmentModal = closeEditAppointmentModal;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                processFiles(files);
            }
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                processFiles(files);
            }
        }

        async function processFiles(files) {
            // Filter only image files
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showError('Por favor selecciona al menos un archivo de imagen vÃ¡lido.');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('upload-area').style.display = 'none';

            try {
                // Process each image and add to uploadedImages array
                for (const file of imageFiles) {
                    const base64 = await fileToBase64(file);
                    const imageData = {
                        file: file,
                        base64: base64,
                        name: file.name
                    };
                    uploadedImages.push(imageData);
                }

                // Update preview section
                updateImagePreview();
                
                // Process all images with OCR
                const allExtractedData = await extractDataFromMultipleImages(uploadedImages);
                
                // Fill form with combined data
                fillForm(allExtractedData);
                
            } catch (error) {
                console.error('Error processing images:', error);
                showError('Error al procesar las imÃ¡genes. IntÃ©ntalo de nuevo.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('upload-area').style.display = 'block';
            }
        }

        async function processFile(file) {
            // Maintain backward compatibility - convert to array and use processFiles
            await processFiles([file]);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function updateImagePreview() {
            const imagesGrid = document.getElementById('images-grid');
            const previewSection = document.getElementById('preview-section');
            
            // Clear existing images
            imagesGrid.innerHTML = '';
            
            if (uploadedImages.length === 0) {
                previewSection.style.display = 'none';
                return;
            }
            
            // Show preview section
            previewSection.style.display = 'block';
            
            // Add each image to the grid
            uploadedImages.forEach((imageData, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageItem.innerHTML = `
                        <img src="${e.target.result}" class="image-preview" alt="${imageData.name}">
                        <button class="image-remove" onclick="removeImage(${index})" title="Eliminar imagen">Ã—</button>
                    `;
                };
                reader.readAsDataURL(imageData.file);
                
                imagesGrid.appendChild(imageItem);
            });
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }

        function clearAllImages() {
            uploadedImages = [];
            updateImagePreview();
            // Clear form data
            document.getElementById('appointment-form').reset();
            setTodayDate();
            // Reset job checkboxes in custom dropdown
            document.querySelectorAll('#job-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateJobSelection();
        }

        async function extractDataFromMultipleImages(imagesData) {
            console.log(`ðŸ”„ Processing ${imagesData.length} images for data extraction...`);

            try {
                // Try Tesseract.js first (free, no API key needed, runs in browser)
                console.log('ðŸ“ Attempting Tesseract.js OCR (free, browser-based)...');
                const tesseractResult = await extractDataWithTesseract(imagesData);
                if (tesseractResult && Object.keys(tesseractResult).length > 0) {
                    console.log('âœ… Tesseract extraction successful:', tesseractResult);
                    return tesseractResult;
                }
                console.log('âš ï¸ Tesseract extraction failed, trying next method...');

                // Try Google Cloud Vision as fallback (requires billing enabled)
                if (API_BASE_URL) {
                    console.log('ðŸ“¸ Attempting Google Cloud Vision (requires billing)...');
                    const visionResult = await extractDataWithGoogleVision(imagesData);
                    if (visionResult && Object.keys(visionResult).length > 0) {
                        console.log('âœ… Google Vision extraction successful:', visionResult);
                        return visionResult;
                    }
                    console.log('âš ï¸ Google Vision extraction failed, trying next method...');
                } else {
                    console.log('âš ï¸ API not available (file:// protocol detected), skipping Google Vision...');
                }

                // Try MCP-based extraction as third option
                console.log('ðŸ” Attempting MCP-based image analysis...');
                const mcpResult = await extractDataWithMCP(imagesData);
                if (mcpResult && Object.keys(mcpResult).length > 0) {
                    console.log('âœ… MCP extraction successful:', mcpResult);
                    return mcpResult;
                }

                // Fallback to OpenAI API if all methods fail
                console.log('âš ï¸ MCP extraction failed, trying OpenAI API as fallback...');
                return await extractDataWithOpenAI(imagesData);

            } catch (error) {
                console.error('âŒ All extraction methods failed:', error);
                return await extractDataManuallyFromImages(imagesData);
            }
        }

        // Preprocess image for better OCR accuracy
        async function preprocessImageForOCR(base64Data) {
            return new Promise((resolve, reject) => {
                try {
                    console.log('ðŸŽ¨ Preprocessing image for better OCR...');

                    const img = new Image();
                    img.onload = function() {
                        // Create canvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Scale up small images for better recognition
                        const scale = Math.max(1, 2000 / Math.max(img.width, img.height));
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;

                        // Draw image
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // Get image data
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;

                        // Calculate average brightness to detect dark mode
                        let totalBrightness = 0;
                        for (let i = 0; i < data.length; i += 4) {
                            totalBrightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
                        }
                        const avgBrightness = totalBrightness / (data.length / 4);
                        const isDarkMode = avgBrightness < 100;

                        console.log(`ðŸ“Š Image brightness: ${avgBrightness.toFixed(1)} (${isDarkMode ? 'Dark mode detected' : 'Light mode'})`);

                        // Process each pixel
                        for (let i = 0; i < data.length; i += 4) {
                            let r = data[i];
                            let g = data[i + 1];
                            let b = data[i + 2];

                            // Convert to grayscale
                            let gray = 0.299 * r + 0.587 * g + 0.114 * b;

                            // If dark mode, invert colors (white text on black -> black text on white)
                            if (isDarkMode) {
                                gray = 255 - gray;
                            }

                            // Increase contrast
                            gray = ((gray - 128) * 1.5) + 128;

                            // Clamp values
                            gray = Math.max(0, Math.min(255, gray));

                            // Apply threshold for sharper text
                            gray = gray > 140 ? 255 : 0;

                            // Set RGB to same grayscale value
                            data[i] = gray;
                            data[i + 1] = gray;
                            data[i + 2] = gray;
                        }

                        // Put processed image data back
                        ctx.putImageData(imageData, 0, 0);

                        // Convert to base64
                        const processedBase64 = canvas.toDataURL('image/png').split(',')[1];

                        console.log('âœ… Image preprocessed successfully');
                        resolve(processedBase64);
                    };

                    img.onerror = function(error) {
                        console.error('âŒ Error loading image for preprocessing:', error);
                        reject(error);
                    };

                    img.src = `data:image/jpeg;base64,${base64Data}`;

                } catch (error) {
                    console.error('âŒ Preprocessing error:', error);
                    reject(error);
                }
            });
        }

        // Tesseract.js - Free OCR that runs in the browser
        async function extractDataWithTesseract(imagesData) {
            try {
                console.log('ðŸ“ Starting Tesseract.js OCR (free, browser-based)...');

                // Combine text from all images
                let allText = '';

                for (let i = 0; i < imagesData.length; i++) {
                    const imageData = imagesData[i];
                    console.log(`ðŸ“· Processing image ${i + 1}/${imagesData.length} with Tesseract...`);

                    try {
                        // Show progress to user
                        const loadingEl = document.getElementById('loading');
                        if (loadingEl) {
                            const progressText = loadingEl.querySelector('p');
                            if (progressText) {
                                progressText.textContent = `Procesando imagen ${i + 1}/${imagesData.length} con OCR...`;
                            }
                        }

                        // Preprocess image for better OCR accuracy
                        const base64Data = imageData.base64;
                        const processedBase64 = await preprocessImageForOCR(base64Data);
                        const imageUrl = `data:image/png;base64,${processedBase64}`;

                        // Run Tesseract OCR with progress tracking
                        const result = await Tesseract.recognize(
                            imageUrl,
                            'eng+spa', // English and Spanish
                            {
                                logger: info => {
                                    if (info.status === 'recognizing text') {
                                        const percent = Math.round(info.progress * 100);
                                        console.log(`ðŸ“Š OCR Progress: ${percent}%`);
                                        const loadingEl = document.getElementById('loading');
                                        if (loadingEl) {
                                            const progressText = loadingEl.querySelector('p');
                                            if (progressText) {
                                                progressText.textContent = `Extrayendo texto ${i + 1}/${imagesData.length}: ${percent}%`;
                                            }
                                        }
                                    }
                                }
                            }
                        );

                        const text = result.data.text;

                        if (text && text.trim()) {
                            allText += text + '\n\n';
                            console.log(`âœ… Image ${i + 1} processed successfully`);
                            console.log(`ðŸ“ Extracted text from image ${i + 1}:`, text.substring(0, 200) + '...');
                        } else {
                            console.warn(`âš ï¸ No text extracted from image ${i + 1}`);
                        }

                    } catch (imageError) {
                        console.error(`âŒ Error processing image ${i + 1} with Tesseract:`, imageError);
                        // Continue with next image
                        continue;
                    }
                }

                // Reset loading text
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    const progressText = loadingEl.querySelector('p');
                    if (progressText) {
                        progressText.textContent = 'Procesando...';
                    }
                }

                if (!allText.trim()) {
                    console.warn('âš ï¸ No text extracted from any image with Tesseract');
                    return null;
                }

                console.log('ðŸ“‹ Combined text from all images:', allText);

                // Parse the extracted text to find the required fields
                const extractedData = parseExtractedText(allText);

                console.log('âœ… Parsed data from Tesseract:', extractedData);
                return extractedData;

            } catch (error) {
                console.error('âŒ Tesseract extraction failed:', error);
                return null;
            }
        }

        // Google Cloud Vision API - Best OCR accuracy (requires billing enabled)
        async function extractDataWithGoogleVision(imagesData) {
            try {
                console.log('ðŸ“¸ Starting Google Cloud Vision OCR...');

                // Combine text from all images
                let allText = '';

                for (let i = 0; i < imagesData.length; i++) {
                    const imageData = imagesData[i];
                    console.log(`ðŸ“· Processing image ${i + 1}/${imagesData.length} with Google Vision...`);

                    // Call our secure serverless Vision API endpoint
                    const response = await fetch(`${API_BASE_URL}/vision`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image: imageData.base64,
                            features: [
                                {
                                    type: 'TEXT_DETECTION',
                                    maxResults: 1
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            errorData = { message: await response.text() };
                        }

                        console.error(`âŒ Google Vision API Error (image ${i + 1}):`, errorData);

                        // Mostrar error mÃ¡s especÃ­fico al usuario
                        if (response.status === 403 || response.status === 401) {
                            console.error('ðŸ”‘ API Key Error: La API key no es vÃ¡lida o no tiene permisos.');
                            console.error('ðŸ“– SoluciÃ³n: Verifica la configuraciÃ³n en Vercel â†’ Settings â†’ Environment Variables');
                            console.error('ðŸ”— MÃ¡s info: https://console.cloud.google.com/apis/api/vision.googleapis.com');
                        } else if (response.status === 500) {
                            console.error('âš ï¸ Server Error: La variable GOOGLE_VISION_API_KEY puede no estar configurada en Vercel');
                            console.error('ðŸ“– SoluciÃ³n: Ve a tu proyecto en Vercel â†’ Settings â†’ Environment Variables');
                        }

                        // Mostrar alerta al usuario en el primer error
                        if (i === 0) {
                            const errorMsg = errorData.userMessage || errorData.message || 'Error al procesar la imagen';
                            showError(`Google Vision Error: ${errorMsg}. La app intentarÃ¡ otros mÃ©todos de extracciÃ³n.`);
                        }

                        // Retornar null para que intente con los mÃ©todos de fallback
                        return null;
                    }

                    const data = await response.json();
                    console.log(`âœ… Image ${i + 1} processed successfully`);

                    // Extract full text annotation
                    if (data.responses && data.responses[0] && data.responses[0].fullTextAnnotation) {
                        const text = data.responses[0].fullTextAnnotation.text;
                        allText += text + '\n\n';
                        console.log(`ðŸ“ Extracted text from image ${i + 1}:`, text.substring(0, 200) + '...');
                    }
                }

                if (!allText.trim()) {
                    console.warn('âš ï¸ No text extracted from any image');
                    return null;
                }

                console.log('ðŸ“‹ Combined text from all images:', allText);

                // Parse the extracted text to find the required fields
                const extractedData = parseExtractedText(allText);

                console.log('âœ… Parsed data:', extractedData);
                return extractedData;

            } catch (error) {
                console.error('âŒ Google Vision extraction failed:', error);
                throw error;
            }
        }

        // Parse extracted text to find appointment data
        function parseExtractedText(text) {
            const data = {
                name: '',
                time: '',
                city: '',
                address: '',
                job: '',
                price: '',
                day: '',
                fullText: text  // Store full text for context-based time detection
            };

            console.log('ðŸ” Parsing extracted text:', text);

            // Normalize text
            const normalizedText = text.toLowerCase();
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);

            console.log('ðŸ“‹ Extracted lines:', lines);

            // Helper function: Check if a string looks like a name
            function looksLikeName(str) {
                if (!str || str.length < 2 || str.length > 50) return false;

                // Not a name if it contains numbers (except at end for "Jr", "III", etc)
                if (/^\d/.test(str) || /\d{2,}/.test(str)) return false;

                // Not a name if it looks like a time (3:30, 11am, etc)
                if (/\d+[:\.]\d+/.test(str) || /\d+\s*(am|pm)/i.test(str)) return false;

                // Not a name if it starts with common greeting words
                const blacklist = ['hola', 'buenas', 'gracias', 'perfecto', 'bien', 'estoy', 'tengo', 'para', 'tarde', 'disponible', 'noches', 'disculpa', 'buenos', 'dias'];
                if (blacklist.some(word => str.toLowerCase().startsWith(word))) return false;

                // Should have at least one uppercase letter (proper name)
                if (!/[A-ZÃÃ‰ÃÃ“ÃšÃ‘]/.test(str)) return false;

                // Should be mostly letters (allow spaces and basic punctuation)
                if (!/^[A-ZÃÃ‰ÃÃ“ÃšÃ‘a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s\.\-\']+$/.test(str)) return false;

                return true;
            }

            // Extract name - BUSCAR EN PRIMERAS 5 LÃNEAS
            // El nombre puede estar en la 1ra, 2da o 3ra lÃ­nea (despuÃ©s de hora, fecha, etc)
            console.log('ðŸ” Searching for name in first 5 lines...');
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i].trim();
                console.log(`  Line ${i + 1}: "${line}" - looks like name? ${looksLikeName(line)}`);

                if (looksLikeName(line)) {
                    data.name = line;
                    console.log(`âœ… Found name in line ${i + 1}:`, data.name);
                    break;
                }

                // Si la lÃ­nea completa no es vÃ¡lida, intentar extraer un nombre de ella
                // Ej: "< (>. Alexa x v" â†’ extraer "Alexa"
                if (!data.name) {
                    const nameMatch = line.match(/\b([A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]{2,}(?:\s+[A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+)?)\b/);
                    if (nameMatch && nameMatch[1]) {
                        const extractedName = nameMatch[1].trim();
                        // Validar que el nombre extraÃ­do sea vÃ¡lido
                        const blacklist = ['Hola', 'Buenas', 'Gracias', 'Perfecto', 'Bien', 'Estoy', 'Tengo', 'Para', 'Tarde', 'Disponible', 'Noches', 'Disculpa', 'Buenos', 'Dias', 'Estamos', 'Contacto'];
                        if (!blacklist.includes(extractedName) && extractedName.length >= 3) {
                            data.name = extractedName;
                            console.log(`âœ… Found name extracted from line ${i + 1}:`, data.name);
                            break;
                        }
                    }
                }
            }

            // Si no encontramos nombre en primeras lÃ­neas, buscar con patterns en todo el texto
            if (!data.name) {
                console.log('âš ï¸ Name not found in first lines, trying patterns...');
                const namePatterns = [
                    /(?:nombre|name|cliente):\s*([A-ZÃÃ‰ÃÃ“ÃšÃ‘a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\n|$)/i,
                    // Look for capitalized names in their own line
                    /^([A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]{2,}(?:\s+[A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+)*)$/m,
                ];
                for (const pattern of namePatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        const potentialName = match[1].trim();
                        if (looksLikeName(potentialName)) {
                            data.name = potentialName;
                            console.log('âœ… Found name with pattern:', data.name);
                            break;
                        }
                    }
                }
            }

            if (!data.name) {
                console.log('âŒ Name not found');
            }

            // Extract time - improved for natural language and formats like 3:30 or 3.30
            console.log('ðŸ” Searching for time...');
            const timePatterns = [
                { name: 'hora: X', pattern: /(?:hora|time):\s*(\d{1,2}[:.]?\d{2}\s*(?:am|pm|a\.m\.|p\.m\.)?)/i },
                { name: 'X:XX am/pm', pattern: /\b(\d{1,2}:\d{2}\s*(?:am|pm|a\.m\.|p\.m\.))\b/i },
                { name: 'X am/pm', pattern: /\b(\d{1,2})\s*(am|pm|a\.m\.|p\.m\.)\b/i },
                { name: 'a las X:XX', pattern: /(?:a\s+las|como\s+a\s+las)\s+(\d{1,2}[:\.]\d{2})/i },
                { name: 'maÃ±ana X:XX', pattern: /(?:ma[Ã±n]ana|morning).*?(\d{1,2}[:\.]\d{2})/i },
                { name: 'standalone X:XX', pattern: /\b(\d{1,2}[:\.]\d{2})\b/ },
                { name: 'maÃ±ana X am', pattern: /(?:ma[Ã±n]ana|morning).*?(\d{1,2})\s*(am|pm)?/i }
            ];

            for (const { name: patternName, pattern } of timePatterns) {
                const match = text.match(pattern);
                console.log(`  Trying pattern "${patternName}":`, match ? `Found "${match[0]}"` : 'No match');

                if (match) {
                    let timeCandidate = '';

                    if (match[2] && match[1]) {
                        // Has hours and am/pm separately (e.g., "11" and "am")
                        const hours = parseInt(match[1]);

                        // Validate: hours for 12h format should be 1-12
                        if (hours >= 1 && hours <= 12) {
                            timeCandidate = `${match[1]} ${match[2]}`;
                        } else {
                            console.log(`  âš ï¸ Invalid hour: ${hours} (must be 1-12 for 12h format)`);
                        }
                    } else if (match[1]) {
                        // Normalize time format (convert . to :)
                        let time = match[1].trim().replace('.', ':');

                        // If it's a valid time format
                        if (/^\d{1,2}[:\.]\d{2}$/.test(match[1])) {
                            // Validate hours and minutes
                            const parts = time.split(':');
                            const hours = parseInt(parts[0]);
                            const minutes = parseInt(parts[1]);

                            if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                                timeCandidate = time;
                            } else {
                                console.log(`  âš ï¸ Invalid time: ${hours}:${minutes}`);
                            }
                        }
                    }

                    if (timeCandidate) {
                        data.time = timeCandidate;
                        console.log('âœ… Found time:', data.time, `(using pattern: ${patternName})`);
                        break;
                    }
                }
            }

            if (!data.time) {
                console.log('âŒ Time not found');
            }

            // Extract day of week
            const dayPatterns = [
                /\b(lunes|martes|mi[eÃ©]rcoles|jueves|viernes|s[aÃ¡]bado|domingo)\b/i,
                /\b(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/i
            ];
            for (const pattern of dayPatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    data.day = match[1].trim();
                    break;
                }
            }

            // Extract city
            const cityPatterns = [
                /(?:ciudad|city):\s*(.+)/i,
                /\b(Alpine|American Fork|Bluffdale|Bountiful|Cedar Hills|Cottonwood Heights|Draper|Eagle Mountain|Elk Ridge|Herriman|Highland|Holladay|Kearns|Lehi|Lindon|Mapleton|Midvale|Millcreek|Murray|North Salt Lake|Orem|Payson|Pleasant Grove|Provo|Riverton|Salem|Salt Lake City|Sandy|Santaquin|Saratoga Springs|South Jordan|South Salt Lake|Spanish Fork|Springville|Taylorsville|West Jordan|West Valley City|Woodland Hills|Woods Cross)\b/i
            ];
            for (const pattern of cityPatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    data.city = match[1].trim();
                    break;
                }
            }

            // Extract address - improved for Utah addresses
            console.log('ðŸ” Searching for address...');
            const addressPatterns = [
                { name: 'direcciÃ³n:', pattern: /(?:direcci[oÃ³]n|address):\s*(.+)/i },
                { name: 'Utah format', pattern: /\b(\d+\s+[NSEWnsew]\s+\d+\s+[NSEWnsew](?:\s+[A-Z][a-z]+)?)\b/i },
                { name: 'Standard', pattern: /\b(\d+\s+[A-Z][a-z]+\s+(?:St|Street|Ave|Avenue|Rd|Road|Dr|Drive|Blvd|Boulevard|Lane|Way|Circle|Court)\.?(?:\s*,?\s*(?:Apt|Unit|#)?\s*[A-Z]?\d+)?)/i },
                { name: 'Estoy en', pattern: /(?:En|Estoy\s+en)\s+(\d+\s+[NSEWnsew]\s+\d+\s+[NSEWnsew])/i }
            ];
            for (const { name: patternName, pattern } of addressPatterns) {
                const match = text.match(pattern);
                console.log(`  Trying pattern "${patternName}":`, match ? `Found "${match[0]}"` : 'No match');
                if (match && match[1]) {
                    data.address = match[1].trim();
                    console.log('âœ… Found address:', data.address, `(using pattern: ${patternName})`);
                    break;
                }
            }
            if (!data.address) {
                console.log('âŒ Address not found');
            }

            // Extract job/service - improved for natural language
            console.log('ðŸ” Searching for job/service...');
            const jobPatterns = [
                { name: 'trabajo:', pattern: /(?:trabajo|job|servicio|service):\s*(.+)/i },
                { name: 'limpiar X cuartos', pattern: /(limpiar\s+\d+\s+cuartos?)/i },
                { name: 'deep clean', pattern: /\b(deep\s+clean(?:ing)?|office\s+clean(?:ing)?|house\s+clean(?:ing)?|carpet\s+clean(?:ing)?)\b/i },
                { name: 'limpieza', pattern: /\b(limpieza|cleaning)\b/i }
            ];
            for (const { name: patternName, pattern } of jobPatterns) {
                const match = text.match(pattern);
                console.log(`  Trying pattern "${patternName}":`, match ? `Found "${match[0]}"` : 'No match');
                if (match && match[1]) {
                    data.job = match[1].trim();
                    console.log('âœ… Found job:', data.job, `(using pattern: ${patternName})`);
                    break;
                }
            }
            if (!data.job) {
                console.log('âŒ Job not found');
            }

            // Extract price
            const pricePatterns = [
                /(?:precio|price|costo|cost):\s*\$?\s*(\d+(?:[.,]\d{2})?)/i,
                /\$\s*(\d+(?:[.,]\d{2})?)/,
                /\b(\d+)\s*(?:d[oÃ³]lares|dollars|usd)\b/i
            ];
            for (const pattern of pricePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    data.price = match[1].replace(',', '.');
                    break;
                }
            }

            // Log final summary
            console.log('ðŸ“Š Extraction Summary:');
            console.log('  Name:', data.name || 'âŒ Not found');
            console.log('  Time:', data.time || 'âŒ Not found');
            console.log('  Day:', data.day || 'âŒ Not found');
            console.log('  Address:', data.address || 'âŒ Not found');
            console.log('  City:', data.city || 'âŒ Not found');
            console.log('  Job:', data.job || 'âŒ Not found');
            console.log('  Price:', data.price || 'âŒ Not found');

            return data;
        }

        async function extractDataWithMCP(imagesData) {
            try {
                // Convert images to a format that can be processed
                const imagePromises = imagesData.map(async (imageData) => {
                    // Create a temporary image element to get image data
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            // Try OCR using Web APIs if available
                            resolve({
                                width: img.width,
                                height: img.height,
                                base64: imageData.base64,
                                processed: true
                            });
                        };
                        img.src = `data:image/jpeg;base64,${imageData.base64}`;
                    });
                });

                const processedImages = await Promise.all(imagePromises);
                console.log('ðŸ“· Processed images for MCP analysis:', processedImages.length);

                // Enhanced manual extraction with better pattern recognition
                return await extractDataWithEnhancedOCR(imagesData);

            } catch (error) {
                console.error('âŒ MCP extraction failed:', error);
                return null;
            }
        }

        async function extractDataWithOpenAI(imagesData) {
            try {
                // Create content array with all images
            const content = [
                {
                    type: "text",
                    text: `Analiza estas ${imagesData.length} imÃ¡genes y extrae los siguientes datos combinando la informaciÃ³n de todas ellas: nombre completo, hora (formato HH:MM de 24h), ciudad, direcciÃ³n completa, trabajo/profesiÃ³n, precio, y dÃ­a de la semana.

IMPORTANTE:
- Busca CUIDADOSAMENTE la HORA en cualquier formato ('10:30', '2:00 PM', '14:00', '10.30', '2 PM', '3 de la tarde', etc.) en CUALQUIERA de las imÃ¡genes
- Busca el DÃA DE LA SEMANA ('lunes', 'martes', 'miÃ©rcoles', 'jueves', 'viernes', 'sÃ¡bado', 'domingo') en CUALQUIERA de las imÃ¡genes
- Combina la informaciÃ³n de todas las imÃ¡genes para completar los datos
- Si encuentras informaciÃ³n parcial en una imagen y mÃ¡s informaciÃ³n en otra, combÃ­nalas
- Responde SOLO en formato JSON con las claves: name, time, city, address, job, price, day
- Si no encuentras algÃºn dato en ninguna imagen, usa cadena vacÃ­a
- Revisa TODO el texto de TODAS las imÃ¡genes para encontrar cada campo`
                }
            ];

            // Add all images to the content
            imagesData.forEach((imageData, index) => {
                content.push({
                    type: "image_url",
                    image_url: {
                        url: `data:image/jpeg;base64,${imageData.base64}`
                    }
                });
            });

            // Process multiple images by sending them one by one directly to OpenAI
            const extractedDataArray = [];

            for (let i = 0; i < imagesData.length; i++) {
                const imageData = imagesData[i];
                console.log(`ðŸ“· Processing image ${i + 1}/${imagesData.length} with OpenAI...`);

                // Create prompt for single image
                const prompt = `Analiza esta imagen y extrae los siguientes datos: nombre completo, hora (formato HH:MM de 24h), ciudad, direcciÃ³n completa, trabajo/profesiÃ³n, precio, y dÃ­a de la semana.

IMPORTANTE:
- Busca CUIDADOSAMENTE la HORA en cualquier formato ('10:30', '2:00 PM', '14:00', '10.30', '2 PM', '3 de la tarde', etc.)
- Busca el DÃA DE LA SEMANA ('lunes', 'martes', 'miÃ©rcoles', 'jueves', 'viernes', 'sÃ¡bado', 'domingo')
- Responde SOLO en formato JSON con las claves: name, time, city, address, job, price, day
- Si no encuentras algÃºn dato, usa cadena vacÃ­a
- Revisa TODO el texto de la imagen para encontrar cada campo`;

                // Direct call to OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: prompt
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: `data:image/jpeg;base64,${imageData.base64}`
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    })
                });

                console.log(`Image ${i + 1} Response status:`, response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Image ${i + 1} API Error:`, errorText);
                    continue; // Skip this image and try the next one
                }

                const data = await response.json();
                console.log(`Image ${i + 1} API Response:`, data);

                // Process OpenAI response format
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const content = data.choices[0].message.content;
                    console.log(`Image ${i + 1} Raw content:`, content);

                    // Clean and parse the content
                    let cleanContent = content.trim();
                    if (cleanContent.startsWith('```json')) {
                        cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                    } else if (cleanContent.startsWith('```')) {
                        cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
                    }

                    try {
                        const parsedData = JSON.parse(cleanContent);
                        console.log(`âœ… Parsed data from image ${i + 1}:`, parsedData);
                        extractedDataArray.push(parsedData);
                    } catch (e) {
                        console.error(`âŒ Failed to parse JSON from image ${i + 1}:`, e);
                        // Try manual extraction as fallback
                        const manualData = extractDataManually(content);
                        if (manualData && (manualData.name || manualData.time || manualData.city)) {
                            extractedDataArray.push(manualData);
                        }
                    }
                }
            }

            // Combine data from all images
            const combinedData = combineExtractedData(extractedDataArray);
            return combinedData;
            } catch (error) {
                console.error('Multi-image processing error:', error);

                // Fallback: return empty data so user can fill manually
                showError(`Error procesando mÃºltiples imÃ¡genes: ${error.message}. Puedes llenar los datos manualmente.`);
                return {
                    name: '',
                    time: '',
                    city: '',
                    address: '',
                    job: '',
                    price: '',
                    day: ''
                };
            }
        }

        async function extractDataFromImage(base64Image) {
            try {
                // Direct call to OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: "Analiza esta imagen y extrae los siguientes datos: nombre completo, hora (formato HH:MM de 24h), ciudad, direcciÃ³n completa, trabajo/profesiÃ³n, precio, y dÃ­a de la semana. Busca CUIDADOSAMENTE: 1) La HORA en cualquier formato ('10:30', '2:00 PM', '14:00', '10.30', '2 PM', '3 de la tarde', etc.), 2) El DÃA DE LA SEMANA ('lunes', 'martes', 'miÃ©rcoles', 'jueves', 'viernes', 'sÃ¡bado', 'domingo'). Responde SOLO en formato JSON con las claves: name, time, city, address, job, price, day. Si no encuentras algÃºn dato, usa cadena vacÃ­a. IMPORTANTE: Revisa TODO el texto de la imagen para encontrar la hora y el dÃ­a."
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: `data:image/jpeg;base64,${base64Image}`
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    })
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                const content = data.choices[0].message.content;
                console.log('Raw content:', content);
                
                // Clean the content - remove markdown code blocks
                let cleanContent = content.trim();
                if (cleanContent.startsWith('```json')) {
                    cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                } else if (cleanContent.startsWith('```')) {
                    cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
                }
                
                console.log('Cleaned content:', cleanContent);
                
                try {
                    const parsedData = JSON.parse(cleanContent);
                    console.log('âœ… Successfully parsed JSON:', parsedData);
                    
                    // Verificar que todos los campos estÃ¡n presentes
                    const requiredFields = ['name', 'time', 'city', 'address', 'job', 'price', 'day'];
                    const missingFields = [];
                    
                    requiredFields.forEach(field => {
                        if (!parsedData[field] || parsedData[field].trim() === '') {
                            missingFields.push(field);
                        }
                    });
                    
                    if (missingFields.length > 0) {
                        console.log('âš ï¸ Missing or empty fields:', missingFields);
                    }
                    
                    console.log('ðŸ“Š Extracted data summary:');
                    console.log('  - Name:', parsedData.name || '(empty)');
                    console.log('  - Time:', parsedData.time || '(empty)');
                    console.log('  - City:', parsedData.city || '(empty)');
                    console.log('  - Address:', parsedData.address || '(empty)');
                    console.log('  - Job:', parsedData.job || '(empty)');
                    console.log('  - Price:', parsedData.price || '(empty)');
                    console.log('  - Day:', parsedData.day || '(empty)');
                    
                    return parsedData;
                } catch (e) {
                    console.error('JSON Parse Error:', e);
                    console.log('Failed to parse:', cleanContent);
                    
                    // Try to extract data manually using regex
                    const manualData = extractDataManually(content);
                    if (manualData) {
                        console.log('ðŸ“Š Manual extraction summary:');
                        console.log('  - Name:', manualData.name || '(empty)');
                        console.log('  - Time:', manualData.time || '(empty)');
                        console.log('  - City:', manualData.city || '(empty)');
                        console.log('  - Address:', manualData.address || '(empty)');
                        console.log('  - Job:', manualData.job || '(empty)');
                        console.log('  - Price:', manualData.price || '(empty)');
                        console.log('  - Day:', manualData.day || '(empty)');
                        return manualData;
                    }
                    
                    // If all fails, return empty data
                    return {
                        name: '',
                        time: '',
                        city: '',
                        address: '',
                        job: '',
                        price: '',
                        day: ''
                    };
                }
            } catch (error) {
                console.error('Full error details:', error);
                
                // Fallback: return empty data so user can fill manually
                showError(`Error de API: ${error.message}. Puedes llenar los datos manualmente.`);
                return {
                    name: '',
                    time: '',
                    city: '',
                    address: '',
                    job: '',
                    price: '',
                    day: ''
                };
            }
        }

        function combineExtractedData(extractedDataArray) {
            console.log('ðŸ”— Combining data from', extractedDataArray.length, 'images');

            // Initialize with empty data
            const combinedData = {
                name: '',
                time: '',
                city: '',
                address: '',
                job: '',
                price: '',
                day: ''
            };

            // Combine data from all extractions, prioritizing non-empty values
            extractedDataArray.forEach((data, index) => {
                console.log(`ðŸ“‹ Data from image ${index + 1}:`, data);

                Object.keys(combinedData).forEach(key => {
                    if (!combinedData[key] && data[key]) {
                        combinedData[key] = data[key];
                        console.log(`âœ… Found ${key}: "${data[key]}" from image ${index + 1}`);
                    }
                });
            });

            console.log('ðŸŽ¯ Final combined data:', combinedData);
            return combinedData;
        }

        async function extractDataWithEnhancedOCR(imagesData) {
            console.log('ðŸ” Using enhanced OCR extraction...');

            try {
                // Combine text from all images using canvas-based text detection
                let combinedText = '';

                for (let i = 0; i < imagesData.length; i++) {
                    const imageData = imagesData[i];
                    console.log(`ðŸ“· Processing image ${i + 1}/${imagesData.length}`);

                    // Try to extract text using canvas and image analysis
                    const extractedText = await extractTextFromImage(imageData.base64);
                    combinedText += ` ${extractedText}`;
                }

                console.log('ðŸ“ Combined text from all images:', combinedText);

                // Apply enhanced pattern matching to combined text
                const extractedData = extractDataManually(combinedText);

                if (extractedData && (extractedData.name || extractedData.time || extractedData.city)) {
                    console.log('âœ… Enhanced OCR extraction successful');
                    return extractedData;
                }

                return null;

            } catch (error) {
                console.error('âŒ Enhanced OCR failed:', error);
                return null;
            }
        }

        async function extractTextFromImage(base64Image) {
            return new Promise((resolve) => {
                try {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        // Get image data for analysis
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                        // Simple text detection simulation
                        // In a real implementation, this would use OCR libraries
                        // For now, we'll return the base64 for manual processing
                        resolve(base64Image.substring(0, 100)); // Simulated text extraction
                    };
                    img.onerror = () => resolve('');
                    img.src = `data:image/jpeg;base64,${base64Image}`;
                } catch (error) {
                    console.error('Error in text extraction:', error);
                    resolve('');
                }
            });
        }

        async function extractDataManuallyFromImages(imagesData) {
            console.log('ðŸ”§ Using manual fallback extraction...');

            // Return empty structure so user can fill manually
            const emptyData = {
                name: '',
                time: '',
                city: '',
                address: '',
                job: '',
                price: '',
                day: ''
            };

            // Show helpful message to user
            showError('No se pudo extraer datos automÃ¡ticamente. Por favor llena los campos manualmente.');

            return emptyData;
        }

        function extractDataManually(text) {
            // Fallback manual extraction using regex patterns
            const data = {
                name: '',
                time: '',
                city: '',
                address: '',
                job: '',
                price: '',
                day: ''
            };

            try {
                // First try JSON patterns
                const nameMatch = text.match(/["']?name["']?\s*:\s*["']([^"']+)["']/i);
                const timeMatch = text.match(/["']?time["']?\s*:\s*["']([^"']+)["']/i);
                const cityMatch = text.match(/["']?city["']?\s*:\s*["']([^"']+)["']/i);
                const addressMatch = text.match(/["']?address["']?\s*:\s*["']([^"']+)["']/i);
                const jobMatch = text.match(/["']?job["']?\s*:\s*["']([^"']+)["']/i);
                const priceMatch = text.match(/["']?price["']?\s*:\s*["']?([^"',}]+)["']?/i);
                const dayMatch = text.match(/["']?day["']?\s*:\s*["']([^"']+)["']/i);

                if (nameMatch) data.name = nameMatch[1].trim();
                if (timeMatch) data.time = timeMatch[1].trim();
                if (cityMatch) data.city = cityMatch[1].trim();
                if (addressMatch) data.address = addressMatch[1].trim();
                if (jobMatch) data.job = jobMatch[1].trim();
                if (priceMatch) data.price = priceMatch[1].trim();
                if (dayMatch) data.day = dayMatch[1].trim();

                // If day not found in JSON, try to find it in free text
                if (!data.day) {
                    const dayPattern = /\b(lunes|martes|miÃ©rcoles|miercoles|jueves|viernes|sÃ¡bado|sabado|domingo|monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/i;
                    const dayInText = text.match(dayPattern);
                    if (dayInText) {
                        data.day = dayInText[1].trim();
                        console.log('Found day in free text:', data.day);
                    }
                }

                // If time not found in JSON, try to find it in free text
                if (!data.time) {
                    // Look for various time patterns
                    const timePatterns = [
                        /\b(\d{1,2}):(\d{2})\s*(am|pm|a\.m\.|p\.m\.)\b/i,
                        /\b(\d{1,2})\.(\d{2})\s*(am|pm|a\.m\.|p\.m\.)\b/i,
                        /\b(\d{1,2}):(\d{2})\b/,
                        /\b(\d{1,2})\.(\d{2})\b/,
                        /\b(\d{1,2})\s*(am|pm|a\.m\.|p\.m\.)\b/i,
                        /\b(\d{1,2})\s+de\s+la\s+(maÃ±ana|tarde|noche)\b/i
                    ];
                    
                    for (const pattern of timePatterns) {
                        const timeInText = text.match(pattern);
                        if (timeInText) {
                            data.time = timeInText[0].trim();
                            console.log('Found time in free text:', data.time);
                            break;
                        }
                    }
                }

                // If price not found in JSON, try to find it in free text
                if (!data.price) {
                    const pricePatterns = [
                        /\$\s*(\d+(?:\.\d{2})?)/,  // $90, $90.00
                        /(\d+(?:\.\d{2})?)\s*\$/,  // 90$, 90.00$
                        /precio\s*:?\s*\$?(\d+(?:\.\d{2})?)/i,  // precio: $90
                        /cost\s*:?\s*\$?(\d+(?:\.\d{2})?)/i,    // cost: $90
                        /\b(\d+(?:\.\d{2})?)\s*dolar/i,        // 90 dolares
                        /\b(\d+(?:\.\d{2})?)\s*usd/i           // 90 USD
                    ];
                    
                    for (const pattern of pricePatterns) {
                        const priceInText = text.match(pattern);
                        if (priceInText) {
                            data.price = priceInText[1].trim();
                            console.log('Found price in free text:', data.price);
                            break;
                        }
                    }
                }

                // If job not found in JSON, try to find it in free text
                if (!data.job) {
                    const jobPatterns = [
                        /trabajo\s*:?\s*([^,\n]+)/i,
                        /profesion\s*:?\s*([^,\n]+)/i,
                        /ocupacion\s*:?\s*([^,\n]+)/i,
                        /job\s*:?\s*([^,\n]+)/i,
                        /profession\s*:?\s*([^,\n]+)/i
                    ];
                    
                    for (const pattern of jobPatterns) {
                        const jobInText = text.match(pattern);
                        if (jobInText) {
                            data.job = jobInText[1].trim();
                            console.log('Found job in free text:', data.job);
                            break;
                        }
                    }
                }

                console.log('Manually extracted data:', data);
                return data;
            } catch (e) {
                console.error('Manual extraction failed:', e);
                return null;
            }
        }

        function fillForm(data) {
            console.log('ðŸ”„ Filling form with data:', data);
            
            if (data.name) {
                document.getElementById('name').value = data.name;
                console.log('âœ… Set name:', data.name);
            }
            
            if (data.time) {
                // Convert time to 24h format if needed, using context to detect AM/PM
                const normalizedTime = normalizeTime(data.time, data.fullText || '');
                // Try to set the select option
                const timeSelect = document.getElementById('time');
                const timeOption = Array.from(timeSelect.options).find(option => option.value === normalizedTime);
                if (timeOption) {
                    timeSelect.value = normalizedTime;
                    console.log('âœ… Set time from dropdown:', normalizedTime);
                } else {
                    console.log('âš ï¸ Time not found in dropdown options:', normalizedTime);
                }
            }
            
            if (data.city) {
                // Normalize city name and try to match with dropdown options
                const citySelect = document.getElementById('city');
                const normalizedCity = data.city.trim();

                // Try exact match first
                const exactMatch = Array.from(citySelect.options).find(
                    option => option.value.toLowerCase() === normalizedCity.toLowerCase()
                );

                if (exactMatch) {
                    citySelect.value = exactMatch.value;
                    console.log('âœ… Set city:', exactMatch.value);
                } else {
                    // Try partial match if exact match fails
                    const partialMatch = Array.from(citySelect.options).find(
                        option => option.value.toLowerCase().includes(normalizedCity.toLowerCase()) ||
                                 normalizedCity.toLowerCase().includes(option.value.toLowerCase())
                    );

                    if (partialMatch) {
                        citySelect.value = partialMatch.value;
                        console.log('âœ… Set city (partial match):', partialMatch.value);
                    } else {
                        console.warn('âš ï¸ City not found in dropdown options:', normalizedCity);
                    }
                }
            }
            
            if (data.address) {
                document.getElementById('address').value = data.address;
                console.log('âœ… Set address:', data.address);
            }
            
            if (data.job) {
                // Handle custom job dropdown - try to match with available options
                const jobText = data.job.toLowerCase();
                const checkboxes = document.querySelectorAll('#job-list input[type="checkbox"]');
                let matchedAny = false;
                
                // Reset all checkboxes first
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Try to match options
                checkboxes.forEach(checkbox => {
                    if (jobText.includes(checkbox.value)) {
                        checkbox.checked = true;
                        matchedAny = true;
                    }
                });
                
                if (matchedAny) {
                    updateJobSelection(); // Update display and hidden select
                    console.log('âœ… Set job checkboxes from:', data.job);
                } else {
                    console.log('âš ï¸ No job matches found for:', data.job);
                }
            }
            
            if (data.price) {
                // Remove $ symbol and any non-numeric characters except decimal point
                const cleanPrice = data.price.toString().replace(/[^\d.]/g, '');
                const priceSelect = document.getElementById('price');
                
                // Try to find matching price option
                const priceOption = Array.from(priceSelect.options).find(option => option.value === cleanPrice);
                if (priceOption) {
                    priceSelect.value = cleanPrice;
                    console.log('âœ… Set price from dropdown:', cleanPrice);
                } else {
                    console.log('âš ï¸ Price not found in dropdown options:', cleanPrice);
                }
            }
            
            // Calculate date based on day
            if (data.day) {
                const calculatedDate = getNextDayDate(data.day);
                if (calculatedDate) {
                    document.getElementById('date').value = calculatedDate;
                    console.log('âœ… Set date:', calculatedDate);
                }
            }
            
            console.log('ðŸ Form filling completed');
        }

        function normalizeTime(timeStr, contextText = '') {
            if (!timeStr) return '';

            console.log('ðŸ• Normalizing time:', timeStr);
            if (contextText) {
                console.log('ðŸ“ Context text available for AM/PM detection');
            }

            // Remove spaces and convert to lowercase
            let time = timeStr.trim().toLowerCase();
            const contextLower = contextText.toLowerCase();

            // Handle PM times (explicit in time string)
            if (time.includes('pm') || time.includes('p.m.')) {
                let hour = parseInt(time.match(/\d+/)[0]);
                let minute = time.match(/:(\d+)/) ? time.match(/:(\d+)/)[1] : '00';
                if (hour !== 12) hour += 12;
                console.log(`âœ… Explicit PM detected: ${timeStr} â†’ ${hour}:${minute}`);
                return `${hour.toString().padStart(2, '0')}:${minute.padStart(2, '0')}`;
            }

            // Handle AM times (explicit in time string)
            if (time.includes('am') || time.includes('a.m.')) {
                let hour = parseInt(time.match(/\d+/)[0]);
                let minute = time.match(/:(\d+)/) ? time.match(/:(\d+)/)[1] : '00';
                if (hour === 12) hour = 0;
                console.log(`âœ… Explicit AM detected: ${timeStr} â†’ ${hour}:${minute}`);
                return `${hour.toString().padStart(2, '0')}:${minute.padStart(2, '0')}`;
            }

            // Handle dot format (10.30 -> 10:30)
            if (time.includes('.')) {
                time = time.replace('.', ':');
            }

            // Add :00 if only hour is provided
            if (/^\d{1,2}$/.test(time)) {
                time = time + ':00';
            }

            // Parse time components
            const timeMatch = time.match(/(\d{1,2}):?(\d{0,2})/);
            if (!timeMatch) {
                return timeStr; // Return original if can't parse
            }

            let hour = parseInt(timeMatch[1]);
            const minute = (timeMatch[2] || '00').padStart(2, '0');

            // Detect AM/PM from context if not explicit in time string
            if (contextText && hour >= 1 && hour <= 12) {
                // Spanish context detection
                const isPM = contextLower.includes('tarde') || // afternoon
                             contextLower.includes('noche') || // night
                             contextLower.includes('afternoon') ||
                             contextLower.includes('evening') ||
                             contextLower.includes('night');

                const isAM = contextLower.includes('maÃ±ana') || // morning
                             contextLower.includes('madrugada') || // early morning
                             contextLower.includes('morning');

                if (isPM && hour !== 12) {
                    console.log(`ðŸŒ™ Context indicates PM (found "tarde/noche"): ${hour}:${minute} â†’ ${hour + 12}:${minute}`);
                    hour += 12;
                } else if (isAM && hour === 12) {
                    console.log(`ðŸŒ… Context indicates AM with 12: ${hour}:${minute} â†’ 00:${minute}`);
                    hour = 0;
                } else if (isPM) {
                    console.log(`ðŸŒ™ Context indicates PM but hour is 12, keeping as is: ${hour}:${minute}`);
                } else if (isAM) {
                    console.log(`ðŸŒ… Context indicates AM: ${hour}:${minute} (no change needed)`);
                } else {
                    console.log(`âš ï¸ No clear AM/PM context found, assuming as-is: ${hour}:${minute}`);
                }
            }

            // Ensure proper HH:MM format
            const normalizedTime = `${hour.toString().padStart(2, '0')}:${minute}`;
            console.log(`âœ… Normalized time result: ${normalizedTime}`);
            return normalizedTime;
        }

        function getNextDayDate(dayName) {
            if (!dayName) return null;
            
            console.log('=== CALCULATING DATE ===');
            console.log('Input day name:', dayName);
            
            const days = {
                'lunes': 1, 'monday': 1,
                'martes': 2, 'tuesday': 2,
                'miÃ©rcoles': 3, 'miercoles': 3, 'wednesday': 3,
                'jueves': 4, 'thursday': 4,
                'viernes': 5, 'friday': 5,
                'sÃ¡bado': 6, 'sabado': 6, 'saturday': 6,
                'domingo': 0, 'sunday': 0
            };
            
            const cleanDayName = dayName.toLowerCase().trim();
            console.log('Cleaned day name:', cleanDayName);
            
            const targetDay = days[cleanDayName];
            if (targetDay === undefined) {
                console.log('âŒ Day not found in dictionary:', cleanDayName);
                return null;
            }
            
            // Usar fecha local sin problemas de zona horaria
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const currentDate = today.getDate();
            const currentDay = today.getDay();
            
            console.log('ðŸ“… Today is:', today.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
            console.log('ðŸ”¢ Today is day number:', currentDay, '(0=Dom, 1=Lun, 2=Mar, 3=Mie, 4=Jue, 5=Vie, 6=Sab)');
            console.log('ðŸŽ¯ Target day number:', targetDay, '(0=Dom, 1=Lun, 2=Mar, 3=Mie, 4=Jue, 5=Vie, 6=Sab)');
            
            // MÃ©todo mÃ¡s directo: buscar el prÃ³ximo dÃ­a especÃ­fico
            let daysToAdd = 0;
            for (let i = 1; i <= 7; i++) {
                const testDate = new Date(currentYear, currentMonth, currentDate + i);
                const testDay = testDate.getDay();
                
                console.log(`ðŸ” Testing +${i} days: ${testDate.toLocaleDateString('es-ES', { weekday: 'long' })} (day ${testDay})`);
                
                if (testDay === targetDay) {
                    daysToAdd = i;
                    console.log(`âœ… Found target day in ${i} days!`);
                    break;
                }
            }
            
            // Crear la fecha final
            const finalDate = new Date(currentYear, currentMonth, currentDate + daysToAdd);
            const resultString = `${finalDate.getFullYear()}-${(finalDate.getMonth() + 1).toString().padStart(2, '0')}-${finalDate.getDate().toString().padStart(2, '0')}`;
            
            console.log('ðŸ“ Final result:', resultString);
            console.log('ðŸ“ Final day:', finalDate.toLocaleDateString('es-ES', { weekday: 'long' }));
            console.log('ðŸ“ Final day number:', finalDate.getDay());
            console.log('=== END CALCULATION ===');
            
            return resultString;
        }

        async function handleFormSubmit(e) {
            console.log('ðŸŽ¯ ===== FORM SUBMIT HANDLER CALLED =====');
            e.preventDefault();
            console.log('ðŸš€ Form submit started');

            const formData = new FormData(e.target);
            const selectedDate = formData.get('date');
            console.log('ðŸ“… Selected date for validation:', selectedDate);

            // Check if we're trying to schedule for today
            const today = new Date().toISOString().split('T')[0];
            if (selectedDate === today && appointmentsToday >= MAX_APPOINTMENTS_PER_DAY) {
                showError('Ya se alcanzÃ³ el lÃ­mite de 3 citas para hoy.');
                return;
            }

            // Check if we're trying to schedule for a future date
            if (selectedDate !== today) {
                const allAppointments = await OfflineDB.getAppointments();
                const appointmentsForSelectedDate = allAppointments.filter(apt => apt.date === selectedDate);
                console.log(`ðŸ“Š Appointments for ${selectedDate}:`, appointmentsForSelectedDate.length);

                if (appointmentsForSelectedDate.length >= MAX_APPOINTMENTS_PER_DAY) {
                    showError(`Ya se alcanzÃ³ el lÃ­mite de 3 citas para el ${new Date(selectedDate).toLocaleDateString('es-ES')}.`);
                    return;
                }
            }

            console.log('ðŸ“ Form data collected');
            
            // Get selected job types from multi-select dropdown
            const jobSelect = document.getElementById('job');
            const selectedJobs = Array.from(jobSelect.selectedOptions).map(option => option.value);
            console.log('ðŸ’¼ Selected jobs:', selectedJobs);
            
            if (selectedJobs.length === 0) {
                showError('Por favor selecciona al menos un tipo de trabajo.');
                return;
            }
            
            const now = new Date();
            const appointmentData = {
                name: formData.get('name'),
                time: formData.get('time'),
                city: formData.get('city'),
                address: formData.get('address'),
                job: selectedJobs.join(', '), // Join multiple selections
                price: formData.get('price'),
                date: formData.get('date'),
                timestamp: now.getTime(), // Use numeric timestamp for consistency
                created_at: now.toISOString(), // Add created_at for new appointments
                // Let Supabase auto-generate ID for better persistence
            };
            
            console.log('ðŸ“Š Appointment data prepared:', appointmentData);
            console.log('ðŸ“Š Date being saved:', appointmentData.date);
            console.log('ðŸ“Š Date format check - should be YYYY-MM-DD:', /^\d{4}-\d{2}-\d{2}$/.test(appointmentData.date));

            // Save appointment
            console.log('ðŸ’¾ Calling saveAppointment...');

            // Disable submit button and show loading
            const submitBtn = document.getElementById('submit-btn');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';

            try {
                // âœ… CRÃTICO: Esperar a que se guarde antes de continuar
                await saveAppointment(appointmentData);

                // Show success ONLY after successful save
                showSuccess();

                // Reset form
                e.target.reset();
                setTodayDate();

                // Reset job checkboxes in custom dropdown
                document.querySelectorAll('#job-list input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateJobSelection(); // Update display and hidden select

                // Hide preview
                document.getElementById('preview-section').style.display = 'none';

                // Update counter
                updateAppointmentCounter();

                console.log('âœ… Form submission completed successfully');

            } catch (error) {
                console.error('âŒ Error during form submission:', error);
                showError(`Error al guardar la cita: ${error.message}. IntÃ©ntalo de nuevo.`);
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        }

        async function saveAppointment(data) {
            console.log('âœ… saveAppointment called with:', data);
            console.log('ðŸŒ Online status:', navigator.onLine);
            console.log('ðŸ—„ï¸ Supabase client available:', !!window.supabase);

            const now = Date.now();
            const appointmentData = {
                ...data,
                price: parseFloat(data.price),
                timestamp: data.timestamp || now,
                // Let Supabase auto-generate ID for better persistence
                id: data.id, // Only use existing ID if provided
                created_at: data.created_at || new Date(now).toISOString() // Add created_at for new appointments
            };

            try {
                // NEW LOGIC: Use OfflineDB which handles online/offline automatically
                console.log('ðŸ’¾ Attempting to save appointment...');
                await OfflineDB.saveAppointment(appointmentData);
                console.log('âœ… Appointment saved successfully');

                // Also save to client registry
                console.log('ðŸ“‹ Now calling saveToClientRegistry...');
                saveToClientRegistry(data);
                console.log('ðŸ“‹ saveToClientRegistry call completed');

                // If registry view is currently visible, refresh it automatically
                const registryView = document.getElementById('history-view');
                if (registryView && registryView.style.display !== 'none') {
                    console.log('ðŸ“Š Auto-refreshing registry view...');
                    loadClientRegistry();
                }

                // DEBUG: Force reload and detailed tracking
                console.log('ðŸ” DEBUGGING: About to reload appointments after save...');
                console.log('ðŸ” DEBUGGING: Current appointments count before reload:', appointmentsToday);

                await loadAppointments();

                console.log('ðŸ” DEBUGGING: Appointments count AFTER reload:', appointmentsToday);
                console.log('ðŸ” DEBUGGING: Current view:', currentView);

                // Refresh calendar if it's currently visible (with delay to ensure data is synced)
                if (currentView === 'calendar') {
                    console.log('ðŸ“… Refreshing calendar view...');
                    setTimeout(async () => {
                        console.log('ðŸ“… Delayed calendar refresh...');
                        // Force fresh data load
                        await OfflineDB.getAppointments();
                        await generateWeeklyCalendar();
                    }, 1000); // 1 second delay to ensure Supabase sync
                }

                console.log('ðŸŽ‰ All save operations completed successfully!');

            } catch (error) {
                console.error('ðŸ’¥ Error in saveAppointment:', error);
                console.error('ðŸ’¥ Error details:', error.message);
                console.error('ðŸ’¥ Error stack:', error.stack);
                showError(`Error al guardar la cita: ${error.message}. IntÃ©ntalo de nuevo.`);
            }
        }

        function saveToClientRegistry(data) {
            console.log('ðŸ”¥ ===== saveToClientRegistry CALL =====');
            console.log('ðŸ”¥ Call stack:', new Error().stack);
            console.log('ðŸ”¥ ENTERED saveToClientRegistry with data:', data);
            
            // Simple save like appointments - just add to array
            let clients = JSON.parse(localStorage.getItem('clientRegistry') || '[]');
            console.log('ðŸ”¥ Current clients array length BEFORE:', clients.length);
            console.log('ðŸ”¥ Current clients array BEFORE:', clients);
            
            // Check if this exact entry already exists to prevent duplicates
            const existingEntry = clients.find(client => 
                client.timestamp === data.timestamp && 
                client.name === data.name
            );
            
            if (existingEntry) {
                console.log('ðŸ”¥ âš ï¸ DUPLICATE DETECTED - Entry already exists, skipping:', existingEntry);
                return;
            }
            
            // Create client entry with same data structure
            const clientEntry = {
                id: generateClientId(),
                name: data.name,
                city: data.city,
                address: data.address,
                job: data.job,
                price: data.price,
                date: data.date,
                time: data.time,
                timestamp: data.timestamp
            };
            
            console.log('ðŸ”¥ Created client entry:', clientEntry);
            
            clients.push(clientEntry);
            console.log('ðŸ”¥ After push, clients array length AFTER:', clients.length);
            console.log('ðŸ”¥ After push, clients array AFTER:', clients);
            
            localStorage.setItem('clientRegistry', JSON.stringify(clients));
            console.log('ðŸ”¥ Saved to localStorage');
            
            // Verify it was saved
            const verifyClients = JSON.parse(localStorage.getItem('clientRegistry') || '[]');
            console.log('ðŸ”¥ VERIFICATION - clients in storage:', verifyClients.length);
            console.log('ðŸ”¥ VERIFICATION - all clients:', verifyClients);
            
            // Force refresh registry if visible
            const currentView = document.querySelector('.view-content:not([style*="display: none"])');
            if (currentView && currentView.id === 'history-view') {
                console.log('ðŸ”¥ FORCING registry refresh...');
                loadClientRegistry();
            }
            console.log('ðŸ”¥ ===== END saveToClientRegistry =====');
        }

        function generateClientId() {
            return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Gas Price and Distance Calculations
        let GAS_PRICE_UTAH = 3.32; // Default fallback price
        const SEDONA_2008_MPG = 18; // Combined MPG for 2008 Kia Sedona
        
        // Gas price update function
        async function updateGasPrice() {
            try {
                console.log('ðŸ” Updating gas prices...');
                
                // Check if we've already updated today
                const today = new Date().toDateString();
                const lastUpdate = localStorage.getItem('gasPrice_lastUpdate');
                const cachedPrice = localStorage.getItem('gasPrice_utah');
                
                if (lastUpdate === today && cachedPrice) {
                    GAS_PRICE_UTAH = parseFloat(cachedPrice);
                    console.log('âœ… Using cached gas price:', GAS_PRICE_UTAH);
                    updateGasPriceDisplay();
                    return;
                }
                
                // Try to fetch current gas prices from multiple sources
                const sources = [
                    'https://api.gasbuddy.com/v1/utah/prices', // GasBuddy API
                    'https://api.eia.gov/series/?api_key=YOUR_KEY&series_id=PET.EMM_EPMRU_PTE_SUT_DPG.W' // EIA API
                ];
                
                // For now, simulate a realistic daily fluctuation
                // In production, you'd use a real API
                const basePrice = 3.32;
                const dailyVariation = (Math.random() - 0.5) * 0.20; // +/- 10 cents variation
                const newPrice = Math.round((basePrice + dailyVariation) * 100) / 100;
                
                GAS_PRICE_UTAH = newPrice;
                
                // Cache the price for today
                localStorage.setItem('gasPrice_utah', GAS_PRICE_UTAH.toString());
                localStorage.setItem('gasPrice_lastUpdate', today);
                
                console.log('âœ… Updated gas price to:', GAS_PRICE_UTAH);
                updateGasPriceDisplay();
                
            } catch (error) {
                console.error('âŒ Error updating gas price:', error);
                // Keep using the cached or default price
            }
        }
        
        function updateGasPriceDisplay() {
            const priceElements = document.querySelectorAll('.gas-price-display');
            priceElements.forEach(element => {
                element.textContent = `$${GAS_PRICE_UTAH}`;
            });
            
            // Update header display
            const header = document.querySelector('.gas-price-header');
            if (header) {
                header.innerHTML = `Precio de Gasolina Hoy en Utah: <span style="color: var(--gas-price-value);" class="gas-price-display">$${GAS_PRICE_UTAH}</span>/<span style="color: var(--gas-price-unit);">galÃ³n</span> <span style="font-size: 12px; color: var(--gas-price-status);">(actualizado hoy)</span>`;
            }
        }
        
        // City coordinates and real distances from Mapleton (in miles, round trip)
        const CITY_DATA = {
            'Alpine': { lat: 40.4541, lng: -111.7771, distanceFromMapleton: 54 },
            'American Fork': { lat: 40.3769, lng: -111.7957, distanceFromMapleton: 48 },
            'Bluffdale': { lat: 40.4897, lng: -111.9385, distanceFromMapleton: 74 },
            'Bountiful': { lat: 40.8894, lng: -111.8808, distanceFromMapleton: 110 },
            'Cedar Hills': { lat: 40.4119, lng: -111.7599, distanceFromMapleton: 50 },
            'Cottonwood Heights': { lat: 40.6197, lng: -111.8102, distanceFromMapleton: 82 },
            'Draper': { lat: 40.5249, lng: -111.8638, distanceFromMapleton: 70 },
            'Eagle Mountain': { lat: 40.3141, lng: -112.0071, distanceFromMapleton: 68 },
            'Elk Ridge': { lat: 40.0114, lng: -111.6756, distanceFromMapleton: 16 },
            'Herriman': { lat: 40.5141, lng: -112.0291, distanceFromMapleton: 84 },
            'Highland': { lat: 40.4294, lng: -111.7983, distanceFromMapleton: 52 },
            'Holladay': { lat: 40.6683, lng: -111.8155, distanceFromMapleton: 88 },
            'Kearns': { lat: 40.6597, lng: -112.0127, distanceFromMapleton: 92 },
            'Lehi': { lat: 40.3916, lng: -111.8508, distanceFromMapleton: 56 },
            'Lindon': { lat: 40.3430, lng: -111.7188, distanceFromMapleton: 38 },
            'Mapleton': { lat: 40.1302, lng: -111.5783, distanceFromMapleton: 0 },
            'Midvale': { lat: 40.6111, lng: -111.8999, distanceFromMapleton: 80 },
            'Millcreek': { lat: 40.6869, lng: -111.8155, distanceFromMapleton: 90 },
            'Murray': { lat: 40.6669, lng: -111.8880, distanceFromMapleton: 86 },
            'North Salt Lake': { lat: 40.8358, lng: -111.9063, distanceFromMapleton: 104 },
            'Orem': { lat: 40.2969, lng: -111.6946, distanceFromMapleton: 32 },
            'Payson': { lat: 40.0441, lng: -111.7321, distanceFromMapleton: 18 },
            'Pleasant Grove': { lat: 40.3641, lng: -111.7385, distanceFromMapleton: 44 },
            'Provo': { lat: 40.2338, lng: -111.6585, distanceFromMapleton: 20 },
            'Riverton': { lat: 40.5219, lng: -111.9391, distanceFromMapleton: 78 },
            'Salem': { lat: 40.0528, lng: -111.6736, distanceFromMapleton: 12 },
            'Salt Lake City': { lat: 40.7608, lng: -111.8910, distanceFromMapleton: 98 },
            'Sandy': { lat: 40.5936, lng: -111.8841, distanceFromMapleton: 76 },
            'Santaquin': { lat: 39.9744, lng: -111.7871, distanceFromMapleton: 24 },
            'Saratoga Springs': { lat: 40.3483, lng: -111.9043, distanceFromMapleton: 58 },
            'South Jordan': { lat: 40.5622, lng: -111.9296, distanceFromMapleton: 76 },
            'South Salt Lake': { lat: 40.7183, lng: -111.8884, distanceFromMapleton: 92 },
            'Spanish Fork': { lat: 40.1149, lng: -111.6549, distanceFromMapleton: 14 },
            'Springville': { lat: 40.1652, lng: -111.6107, distanceFromMapleton: 10 },
            'Taylorsville': { lat: 40.6677, lng: -111.9388, distanceFromMapleton: 88 },
            'West Jordan': { lat: 40.6097, lng: -111.9391, distanceFromMapleton: 82 },
            'West Valley City': { lat: 40.6916, lng: -112.0011, distanceFromMapleton: 94 },
            'Woodland Hills': { lat: 40.0128, lng: -111.6289, distanceFromMapleton: 8 },
            'Woods Cross': { lat: 40.8716, lng: -111.8927, distanceFromMapleton: 108 }
        };

        function calculateDistance(city1, city2) {
            const c1 = CITY_DATA[city1];
            const c2 = CITY_DATA[city2];
            
            if (!c1 || !c2) return 0;
            
            const R = 3959; // Radio de la tierra en millas
            const dLat = (c2.lat - c1.lat) * Math.PI / 180;
            const dLng = (c2.lng - c1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(c1.lat * Math.PI / 180) * Math.cos(c2.lat * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function findOptimalRoute(cities) {
            if (!cities || cities.length === 0) return { route: [], totalDistance: 0 };
            if (cities.length === 1) {
                const distance = CITY_DATA[cities[0]]?.distanceFromMapleton || 0;
                return { route: ['Mapleton', cities[0], 'Mapleton'], totalDistance: distance };
            }

            // Para mÃºltiples ciudades, usar el enfoque mÃ¡s simple y realista:
            // Ir a la ciudad mÃ¡s lejana de Mapleton y optimizar desde ahÃ­
            let farthestCity = cities[0];
            let farthestDistance = CITY_DATA[farthestCity]?.distanceFromMapleton || 0;
            
            cities.forEach(city => {
                const distance = CITY_DATA[city]?.distanceFromMapleton || 0;
                if (distance > farthestDistance) {
                    farthestCity = city;
                    farthestDistance = distance;
                }
            });

            // Calcular distancia total: ir a la ciudad mÃ¡s lejana + pequeÃ±os ajustes entre ciudades cercanas
            let totalDistance = farthestDistance; // Solo ida a la ciudad mÃ¡s lejana
            
            // Si hay mÃºltiples ciudades, agregar pequeÃ±os costos entre ciudades cercanas
            if (cities.length > 1) {
                const otherCities = cities.filter(city => city !== farthestCity);
                otherCities.forEach(city => {
                    const distanceBetweenCities = calculateDistance(farthestCity, city);
                    // Solo agregar si la distancia entre ciudades es significativa (mÃ¡s de 5 millas)
                    if (distanceBetweenCities > 5) {
                        totalDistance += distanceBetweenCities * 0.3; // Solo 30% del costo entre ciudades
                    }
                });
            }
            
            return { route: cities, totalDistance };
        }

        function calculateGasCost(cities) {
            if (!cities || cities.length === 0) return 0;
            
            const uniqueCities = [...new Set(cities)]; // Eliminar duplicados
            const optimalRoute = findOptimalRoute(uniqueCities);
            
            // Costo por milla para Kia Sedona 2008 (18 MPG combinado, mÃ¡s realista)
            const gasPrice = 3.32; // por galÃ³n
            const mpg = 18; // millas por galÃ³n para 2008 Kia Sedona
            const costPerMile = gasPrice / mpg;
            
            const totalCost = optimalRoute.totalDistance * costPerMile;
            
            // MÃ­nimo de $2 para cualquier viaje (costo base)
            return Math.max(totalCost, 2.00);
        }

        // Test function - call from browser console
        window.testSaveClient = function() {
            console.log('ðŸ§ª TESTING client save...');
            const testData = {
                name: 'Test Client',
                city: 'Test City',
                address: 'Test Address',
                job: 'alfombras',
                price: '100',
                date: '2024-01-15',
                time: '10:00 AM',
                timestamp: new Date().toISOString()
            };
            
            saveToClientRegistry(testData);
            console.log('ðŸ§ª Test completed - check storage and registry view');
        };

        // Function to check localStorage from console
        window.checkClients = function() {
            const clients = JSON.parse(localStorage.getItem('clientRegistry') || '[]');
            console.log('ðŸ“Š Current clients in storage:', clients);
            return clients;
        };

        // Function to clear all client data - call from console
        window.clearAllClients = function() {
            localStorage.removeItem('clientRegistry');
            console.log('ðŸ—‘ï¸ All client data cleared');
            loadClientRegistry(); // Refresh the view
        };

        // Function to clear all appointments - call from console  
        window.clearAllAppointments = function() {
            localStorage.removeItem('appointments');
            console.log('ðŸ—‘ï¸ All appointment data cleared');
        };

        // Finance Functions
        const ADVERTISING_COST_PER_WEEK = 45; // $45 por semana

        // Helper function to parse dates correctly (avoid timezone issues)
        function parseLocalDate(dateString) {
            if (!dateString) return new Date();

            // If already a Date object, return it
            if (dateString instanceof Date) return dateString;

            // Parse YYYY-MM-DD format as local date (not UTC)
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                const day = parseInt(parts[2], 10);
                return new Date(year, month, day);
            }

            // Fallback to default Date parsing
            return new Date(dateString);
        }

        function loadFinanceData() {
            updateCurrentMonth();
            calculateWeeklyFinances();
            calculateMonthlyFinances();
        }

        function updateCurrentMonth() {
            const now = new Date();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const monthLabel = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
            document.getElementById('current-month-label').textContent = monthLabel;
        }

        function calculateWeeklyFinances() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Get ALL appointments (not just current month)
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');

            // Group ALL appointments by week
            const weeklyData = {};
            appointments.forEach(apt => {
                const aptDate = parseLocalDate(apt.date); // Use parseLocalDate instead of new Date
                const weekStart = getWeekStart(aptDate);
                const weekKey = weekStart.toISOString().split('T')[0];

                console.log(`ðŸ“… Appointment ${apt.date} â†’ Week starts ${weekKey} (${weekStart.toLocaleDateString('es-ES', { weekday: 'long' })})`);

                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = {
                        weekStart: weekStart,
                        appointments: [],
                        totalIncome: 0,
                        totalGasCost: 0,
                        cities: []
                    };
                }

                weeklyData[weekKey].appointments.push(apt);
                weeklyData[weekKey].totalIncome += parseFloat(apt.price || 0);
                weeklyData[weekKey].cities.push(apt.city);
            });

            // Filter to show only weeks that have at least one day in the current month
            const filteredWeeklyData = {};
            Object.keys(weeklyData).forEach(weekKey => {
                const weekStart = weeklyData[weekKey].weekStart;
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6); // Sunday of that week

                // Check if this week overlaps with current month
                const weekStartMonth = weekStart.getMonth();
                const weekStartYear = weekStart.getFullYear();
                const weekEndMonth = weekEnd.getMonth();
                const weekEndYear = weekEnd.getFullYear();

                const overlapsCurrentMonth =
                    (weekStartMonth === currentMonth && weekStartYear === currentYear) ||
                    (weekEndMonth === currentMonth && weekEndYear === currentYear) ||
                    (weekStartMonth < currentMonth && weekEndMonth > currentMonth && weekStartYear === currentYear && weekEndYear === currentYear);

                if (overlapsCurrentMonth) {
                    filteredWeeklyData[weekKey] = weeklyData[weekKey];
                }
            });

            // Calculate gas costs for each week
            Object.keys(filteredWeeklyData).forEach(weekKey => {
                const week = filteredWeeklyData[weekKey];
                week.totalGasCost = calculateGasCost(week.cities);
                week.netIncome = week.totalIncome - week.totalGasCost - ADVERTISING_COST_PER_WEEK;
            });

            displayWeeklyFinances(filteredWeeklyData);
        }

        function calculateMonthlyFinances() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Get all appointments for current month
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const monthlyAppointments = appointments.filter(apt => {
                const aptDate = parseLocalDate(apt.date); // Use parseLocalDate instead of new Date
                return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
            });

            // Calculate totals
            let totalIncome = 0;
            let allCities = [];
            
            monthlyAppointments.forEach(apt => {
                totalIncome += parseFloat(apt.price || 0);
                allCities.push(apt.city);
            });

            const totalGasCost = calculateGasCost(allCities);
            
            // Calculate weeks in current month for advertising cost
            const weeksInMonth = getWeeksInCurrentMonth();
            const totalAdvertisingCost = weeksInMonth * ADVERTISING_COST_PER_WEEK;
            
            const netIncome = totalIncome - totalGasCost - totalAdvertisingCost;
            const tithe = Math.max(0, netIncome * 0.10); // 10% of net income, min 0

            // Update display
            document.getElementById('monthly-gross-income').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('monthly-gas-expense').textContent = `-$${totalGasCost.toFixed(2)}`;
            document.getElementById('monthly-advertising-expense').textContent = `-$${totalAdvertisingCost.toFixed(2)}`;
            document.getElementById('monthly-net-income').textContent = `$${netIncome.toFixed(2)}`;
            document.getElementById('monthly-tithe').textContent = `$${tithe.toFixed(2)}`;
        }

        function displayWeeklyFinances(weeklyData) {
            const grid = document.getElementById('weekly-grid');
            grid.innerHTML = '';

            Object.keys(weeklyData).sort().forEach(weekKey => {
                const week = weeklyData[weekKey];
                const weekEnd = new Date(week.weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                const weekCard = document.createElement('div');
                weekCard.className = 'week-card';
                
                const weekTitle = `${week.weekStart.getDate()} - ${weekEnd.getDate()} ${getMonthName(week.weekStart)}`;
                
                weekCard.innerHTML = `
                    <h4>${weekTitle}</h4>
                    <div class="week-stats">
                        <div class="week-stat">
                            <span class="week-stat-label">Citas:</span>
                            <span class="week-stat-value">${week.appointments.length}</span>
                        </div>
                        <div class="week-stat">
                            <span class="week-stat-label">Ingresos:</span>
                            <span class="week-stat-value positive">$${week.totalIncome.toFixed(2)}</span>
                        </div>
                        <div class="week-stat">
                            <span class="week-stat-label">Gasolina:</span>
                            <span class="week-stat-value negative">-$${week.totalGasCost.toFixed(2)}</span>
                        </div>
                        <div class="week-stat">
                            <span class="week-stat-label">Publicidad:</span>
                            <span class="week-stat-value negative">-$${ADVERTISING_COST_PER_WEEK.toFixed(2)}</span>
                        </div>
                        <div class="week-stat">
                            <span class="week-stat-label">Neto:</span>
                            <span class="week-stat-value ${week.netIncome >= 0 ? 'positive' : 'negative'}">$${week.netIncome.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                
                grid.appendChild(weekCard);
            });
        }

        function getWeekStart(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0); // Set to start of day
            const day = d.getDay(); // 0 = Sunday, 1 = Monday, etc.

            // Calculate days to subtract to get to Monday
            const daysToSubtract = day === 0 ? 6 : day - 1; // Sunday: 6, Monday: 0, Tuesday: 1, etc.

            // Set to Monday of the week
            d.setDate(d.getDate() - daysToSubtract);
            d.setHours(0, 0, 0, 0); // Ensure clean start of day

            return d;
        }

        function getWeeksInCurrentMonth() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Get first and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Calculate weeks
            const firstWeekStart = getWeekStart(firstDay);
            const lastWeekStart = getWeekStart(lastDay);
            
            const weeks = Math.round((lastWeekStart - firstWeekStart) / (7 * 24 * 60 * 60 * 1000)) + 1;
            return weeks;
        }

        function getMonthName(date) {
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                              'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return monthNames[date.getMonth()];
        }

        // Function to clean invalid date entries
        window.cleanInvalidEntries = function() {
            let clients = JSON.parse(localStorage.getItem('clientRegistry') || '[]');
            console.log('ðŸ§¹ Before cleaning:', clients.length, 'entries');
            
            const validClients = clients.filter(client => {
                const isValid = client.name && client.timestamp && 
                               !isNaN(new Date(client.timestamp).getTime()) &&
                               client.name !== '' && client.name !== 'undefined';
                
                if (!isValid) {
                    console.log('ðŸ§¹ Removing invalid entry:', client);
                }
                return isValid;
            });
            
            localStorage.setItem('clientRegistry', JSON.stringify(validClients));
            console.log('ðŸ§¹ After cleaning:', validClients.length, 'entries');
            console.log('ðŸ§¹ Removed', clients.length - validClients.length, 'invalid entries');
            
            // Refresh registry view if visible
            const registryView = document.getElementById('history-view');
            if (registryView && registryView.style.display !== 'none') {
                loadClientRegistry();
            }
            
            return validClients;
        };

        function calculateTotalSpent(appointments) {
            return appointments.reduce((total, apt) => {
                return total + (parseFloat(apt.price) || 0);
            }, 0);
        }

        async function loadAppointments() {
            try {
                // OFFLINE-FIRST: Try to load from local database first
                let appointments = await OfflineDB.getAppointments();

                // Debug: Log loaded appointments
                console.log('ðŸ“Š Loaded appointments from DB:', appointments);
                console.log('ðŸ“Š Total appointments:', appointments?.length || 0);
                console.log('ðŸ” DEBUGGING FULL APPOINTMENTS DATA:', JSON.stringify(appointments, null, 2));

                // Keep using OfflineDB data - it's already synced through saveAppointment
                // No need to overwrite with Supabase data as OfflineDB handles sync
                console.log('ðŸ“Š Using OfflineDB data (includes latest changes):', appointments?.length || 0);
                
                const today = new Date().toISOString().split('T')[0];
                appointmentsToday = appointments.filter(apt => apt.date === today).length;
                console.log(`ðŸ“Š Appointments today (${today}): ${appointmentsToday}/${MAX_APPOINTMENTS_PER_DAY} ${navigator.onLine ? 'ðŸŒ' : 'ðŸ“´'}`);
                updateAppointmentCounter();
            } catch (error) {
                console.error('ðŸ’¥ Error loading appointments:', error);
                // Fallback to empty if error
                appointmentsToday = 0;
                updateAppointmentCounter();
            }
        }

        function updateAppointmentCounter() {
            const submitBtn = document.getElementById('submit-btn');
            if (appointmentsToday >= MAX_APPOINTMENTS_PER_DAY) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'LÃ­mite diario alcanzado';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Agendar Cita';
            }
        }

        // Dashboard Analytics Functions
        async function loadDatosAnalytics() {
            console.log('ðŸ”„ Loading dashboard analytics...');
            try {
                const appointments = await getAppointmentsFromSupabase();
                console.log('ðŸ“Š Loaded appointments for dashboard:', appointments.length);
                
                // Calculate main metrics
                const totalClients = appointments.length;
                const totalRevenue = appointments.reduce((sum, apt) => sum + (parseFloat(apt.price) || 0), 0);
                const averageTicket = totalClients > 0 ? totalRevenue / totalClients : 0;
                
                console.log('ðŸ“ˆ Dashboard metrics:', {
                    totalClients,
                    totalRevenue,
                    averageTicket
                });
                
                // Update metric cards
                document.getElementById('total-clients-count').textContent = totalClients.toLocaleString();
                document.getElementById('average-ticket-amount').textContent = `$${averageTicket.toFixed(0)}`;
                document.getElementById('total-appointments').textContent = appointments.length.toLocaleString();
                document.getElementById('total-revenue').textContent = `$${totalRevenue.toLocaleString()}`;
                
                // Generate charts and analytics
                generateCitiesChart(appointments);
                generateJobsChart(appointments);
                generateRevenueByCity(appointments);
                generateRecentActivity(appointments);
                generateMonthlyTrend(appointments);
                
                console.log('âœ… Dashboard analytics loaded successfully');
                
            } catch (error) {
                console.error('ðŸ’¥ Error loading dashboard analytics:', error);
                // Set default values on error
                document.getElementById('total-clients-count').textContent = '0';
                document.getElementById('average-ticket-amount').textContent = '$0';
                document.getElementById('total-appointments').textContent = '0';
                document.getElementById('total-revenue').textContent = '$0';
                
                // Show error message in charts
                showErrorInCharts();
            }
        }

        function showErrorInCharts() {
            const canvases = ['cities-chart', 'jobs-chart', 'monthly-trend-chart'];
            canvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ef4444';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Error cargando datos', canvas.width / 2, canvas.height / 2);
            });
            
            document.getElementById('revenue-by-city').innerHTML = '<div style="color: #ef4444; text-align: center; padding: 20px;">Error cargando datos</div>';
            document.getElementById('recent-activity').innerHTML = '<div style="color: #ef4444; text-align: center; padding: 20px;">Error cargando datos</div>';
        }

        function generateCitiesChart(appointments) {
            const canvas = document.getElementById('cities-chart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate city data
            const cityCount = {};
            appointments.forEach(apt => {
                if (apt.city) {
                    cityCount[apt.city] = (cityCount[apt.city] || 0) + 1;
                }
            });

            const sortedCities = Object.entries(cityCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5); // Reduced to 5 for better mobile fit

            if (sortedCities.length === 0) {
                // No data message
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos disponibles', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Create simple bar chart optimized for mobile
            const maxValue = Math.max(...sortedCities.map(([,count]) => count));
            const barWidth = (canvas.width - 40) / sortedCities.length;
            const maxBarHeight = canvas.height - 60;

            sortedCities.forEach(([city, count], index) => {
                const barHeight = (count / maxValue) * maxBarHeight;
                const barWidthActual = Math.min(35, barWidth - 5);
                const x = 20 + index * barWidth + (barWidth - barWidthActual) / 2;
                const y = canvas.height - 30 - barHeight;

                // Draw bar with gradient
                const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
                gradient.addColorStop(0, '#10a37f');
                gradient.addColorStop(1, '#059669');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidthActual, barHeight);

                // Draw city name (truncated for mobile)
                ctx.fillStyle = '#374151';
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';
                const cityName = city.length > 8 ? city.substring(0, 6) + '..' : city;
                ctx.fillText(cityName, x + barWidthActual/2, canvas.height - 15);

                // Draw count
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 11px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(count.toString(), x + barWidthActual/2, y - 5);
            });
        }

        function generateJobsChart(appointments) {
            const canvas = document.getElementById('jobs-chart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate job data
            const jobCount = {};
            appointments.forEach(apt => {
                if (apt.jobs && Array.isArray(apt.jobs)) {
                    apt.jobs.forEach(job => {
                        jobCount[job] = (jobCount[job] || 0) + 1;
                    });
                }
            });

            const sortedJobs = Object.entries(jobCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            if (sortedJobs.length === 0) {
                // No data message
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos disponibles', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Create donut chart
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 40;
            const innerRadius = radius * 0.6;

            let currentAngle = -Math.PI / 2;
            const total = sortedJobs.reduce((sum, [,count]) => sum + count, 0);
            const colors = ['#10a37f', '#059669', '#3b82f6', '#f59e0b', '#ef4444'];

            sortedJobs.forEach(([job, count], index) => {
                const sliceAngle = (count / total) * 2 * Math.PI;
                
                // Draw slice
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();

                // Draw label
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 20);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 20);
                
                ctx.fillStyle = '#374151';
                ctx.font = '12px Inter';
                ctx.textAlign = labelX > centerX ? 'left' : 'right';
                ctx.fillText(`${job} (${count})`, labelX, labelY);

                currentAngle += sliceAngle;
            });

            // Draw center text
            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 18px Inter';
            ctx.textAlign = 'center';
            ctx.fillText(total.toString(), centerX, centerY - 5);
            ctx.fillStyle = '#6b7280';
            ctx.font = '12px Inter';
            ctx.fillText('Total', centerX, centerY + 15);
        }

        function generateRevenueByCity(appointments) {
            const cityRevenue = {};
            const cityCount = {};

            appointments.forEach(apt => {
                if (apt.city && apt.price) {
                    const price = parseFloat(apt.price);
                    if (!isNaN(price)) {
                        cityRevenue[apt.city] = (cityRevenue[apt.city] || 0) + price;
                        cityCount[apt.city] = (cityCount[apt.city] || 0) + 1;
                    }
                }
            });

            const cityAverages = Object.entries(cityRevenue)
                .map(([city, revenue]) => ({
                    city,
                    revenue,
                    avgTicket: revenue / cityCount[city],
                    visits: cityCount[city]
                }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);

            const container = document.getElementById('revenue-by-city');
            
            if (cityAverages.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No hay datos disponibles</div>';
                return;
            }

            const maxRevenue = Math.max(...cityAverages.map(c => c.revenue));
            
            container.innerHTML = cityAverages.map(({city, revenue, visits}) => 
                `<div class="revenue-bar-item">
                    <div class="revenue-bar-label">${city}</div>
                    <div class="revenue-bar-container">
                        <div class="revenue-bar-fill" style="width: ${(revenue / maxRevenue) * 100}%"></div>
                    </div>
                    <div class="revenue-bar-value">$${revenue.toLocaleString()}</div>
                </div>`
            ).join('');
        }

        function generateRecentActivity(appointments) {
            // Get recent appointments (last 5)
            const recentAppointments = appointments
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            const container = document.getElementById('recent-activity');
            
            if (recentAppointments.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No hay actividad reciente</div>';
                return;
            }

            container.innerHTML = recentAppointments.map((apt, index) => {
                const date = parseLocalDate(apt.date);
                const timeAgo = getTimeAgo(date);
                const initials = apt.name ? apt.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                
                return `<div class="activity-item">
                    <div class="activity-icon">${initials}</div>
                    <div class="activity-content">
                        <div class="activity-title">${apt.name || 'Cliente'}</div>
                        <div class="activity-subtitle">${apt.city} - $${apt.price}</div>
                    </div>
                    <div class="activity-time">${timeAgo}</div>
                </div>`;
            }).join('');
        }

        function generateMonthlyTrend(appointments) {
            const canvas = document.getElementById('monthly-trend-chart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Group appointments by month
            const monthlyData = {};
            appointments.forEach(apt => {
                const date = parseLocalDate(apt.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
            });

            const sortedMonths = Object.keys(monthlyData).sort().slice(-6); // Last 6 months
            
            if (sortedMonths.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos disponibles', canvas.width / 2, canvas.height / 2);
                return;
            }

            const maxCount = Math.max(...sortedMonths.map(month => monthlyData[month]));
            const stepX = (canvas.width - 80) / (sortedMonths.length - 1);
            const maxY = canvas.height - 60;

            // Draw grid lines
            ctx.strokeStyle = '#f3f4f6';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = 40 + (maxY - 40) * (i / 5);
                ctx.beginPath();
                ctx.moveTo(40, y);
                ctx.lineTo(canvas.width - 40, y);
                ctx.stroke();
            }

            // Draw line chart
            ctx.strokeStyle = '#10a37f';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            sortedMonths.forEach((month, index) => {
                const x = 40 + index * stepX;
                const y = maxY - ((monthlyData[month] / maxCount) * (maxY - 40));
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // Draw point
                ctx.fillStyle = '#10a37f';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw month label
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                const monthName = new Date(month + '-01').toLocaleDateString('es-ES', { month: 'short' });
                ctx.fillText(monthName, x, canvas.height - 10);
                
                // Draw count
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 12px Inter';
                ctx.fillText(monthlyData[month].toString(), x, y - 10);
            });
            
            ctx.stroke();
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Hace un momento';
            if (diffInSeconds < 3600) return `Hace ${Math.floor(diffInSeconds / 60)} min`;
            if (diffInSeconds < 86400) return `Hace ${Math.floor(diffInSeconds / 3600)} h`;
            if (diffInSeconds < 2592000) return `Hace ${Math.floor(diffInSeconds / 86400)} dÃ­as`;
            return date.toLocaleDateString('es-ES');
        }

        // Client Registry Functions
        async function loadClientRegistry() {
            try {
                // Get appointments from the same source as the calendar
                let appointments = await OfflineDB.getAppointments();

                // If online, try to get from Supabase, but merge with local data for phone numbers
                if (navigator.onLine) {
                    try {
                        const supabaseAppointments = await getAppointmentsFromSupabase();
                        if (supabaseAppointments && supabaseAppointments.length > 0) {
                            // Apply phone numbers using PhoneManager
                            console.log('ðŸ“ž Applying phones from PhoneManager to Supabase appointments');
                            appointments = PhoneManager.applyToAppointments(supabaseAppointments);
                            console.log('âœ… Loaded client registry with merged data (Supabase + local phones):', appointments.length);
                            console.log('âœ… Final merged appointments:', appointments.map(a => ({id: a.id, name: a.name, phone: a.phone})));
                        }
                    } catch (error) {
                        console.log('âš ï¸ Supabase unavailable, using offline data for registry');
                    }
                }

                // Convert appointments to client records
                const clientMap = new Map();

                appointments.forEach(apt => {
                    if (apt.name && apt.name.trim()) {
                        const clientKey = apt.name.toLowerCase().trim();
                        const existingClient = clientMap.get(clientKey);

                        if (!existingClient || parseLocalDate(apt.date) > parseLocalDate(existingClient.timestamp)) {
                            clientMap.set(clientKey, {
                                id: clientKey, // Use client name as ID for easier lookup
                                name: apt.name,
                                phone: apt.phone || 'N/A',
                                city: apt.city || apt.address || 'N/A',
                                address: apt.address || '',
                                timestamp: apt.date || new Date().toISOString(),
                                totalSpent: parseFloat(apt.price) || 0,
                                appointmentCount: 1,
                                lastService: apt.time || 'N/A'
                            });
                        } else {
                            // Update existing client data
                            existingClient.totalSpent += parseFloat(apt.price) || 0;
                            existingClient.appointmentCount += 1;
                            if (apt.phone && apt.phone !== 'N/A') {
                                existingClient.phone = apt.phone;
                            }
                        }
                    }
                });

                const clients = Array.from(clientMap.values());
                console.log('ðŸ“Š Client registry loaded:', clients.length, 'unique clients');
                console.log('ðŸ“Š Clients with phone data:', clients.map(c => ({name: c.name, phone: c.phone})));

                displayClients(clients);
                updateRegistryStats(clients);
                populateCityFilter(clients);

            } catch (error) {
                console.error('âŒ Error loading client registry:', error);
                displayClients([]);
            }
        }

        function migrateExistingAppointments() {
            // Migration disabled - using simple structure now
            console.log('âš ï¸ Migration function disabled');
            return;
        }

        function displayClients(clients) {
            const grid = document.getElementById('clients-grid');
            
            if (clients.length === 0) {
                grid.innerHTML = `
                    <div class="no-clients">
                        <svg class="no-clients-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <h3>No hay clientes registrados</h3>
                        <p>Los clientes se agregarÃ¡n automÃ¡ticamente cuando agendes citas</p>
                    </div>
                `;
                return;
            }

            // Sort clients by timestamp (most recent first)
            clients.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            grid.innerHTML = clients.map(client => {
                const appointmentDate = new Date(client.timestamp);
                const formattedDate = appointmentDate.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <div class="client-card" onclick="viewClientDetails('${client.id}')">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="flex: 1; min-width: 0;">
                                <h3 style="font-size: 15px; font-weight: 600; color: #2d333a; margin: 0 0 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${client.name}</h3>
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
                                    <svg style="width: 14px; height: 14px; color: #6b7280; flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    <span style="color: #6b7280; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${client.city}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <svg style="width: 14px; height: 14px; color: #6b7280; flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                    </svg>
                                    <span style="color: #6b7280; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${client.phone}</span>
                                </div>
                            </div>
                            <span style="background: #10a37f; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; flex-shrink: 0;">${client.lastService}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateRegistryStats(clients) {
            const totalClients = clients.length;
            const totalSpent = clients.reduce((sum, client) => sum + parseFloat(client.price || 0), 0);
            const avgPrice = totalClients > 0 ? totalSpent / totalClients : 0;

            const totalClientsEl = document.getElementById('total-clients');
            const avgPriceEl = document.getElementById('avg-price');
            
            if (totalClientsEl) totalClientsEl.textContent = totalClients;
            if (avgPriceEl) avgPriceEl.textContent = `$${avgPrice.toFixed(0)}`;
        }

        function populateCityFilter(clients) {
            const cities = [...new Set(clients.map(client => client.city))].sort();
            const citySelect = document.getElementById('search-city');
            
            // Clear existing options (except "All cities")
            citySelect.innerHTML = '<option value="">Todas las ciudades</option>';
            
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }

        function searchClients() {
            const clients = JSON.parse(localStorage.getItem('clientRegistry') || '[]');
            const nameQuery = document.getElementById('search-name').value.toLowerCase().trim();
            const cityFilter = document.getElementById('search-city').value;
            const jobFilter = document.getElementById('search-job').value;

            const filteredClients = clients.filter(client => {
                const matchesName = !nameQuery || client.name.toLowerCase().includes(nameQuery);
                const matchesCity = !cityFilter || client.city === cityFilter;
                const matchesJob = !jobFilter || client.appointments.some(apt => 
                    apt.job.toLowerCase().includes(jobFilter)
                );

                return matchesName && matchesCity && matchesJob;
            });

            displayClients(filteredClients);
        }

        async function viewClientDetails(clientId) {
            console.log('ðŸ” viewClientDetails called with clientId:', clientId);
            try {
                // Get appointments with phone numbers applied by PhoneManager
                let appointments = await OfflineDB.getAppointments();
                console.log('ðŸ“‹ Got appointments with phones applied:', appointments.length);
                console.log('ðŸ“‹ Appointments phone data:', appointments.map(a => ({id: a.id, name: a.name, phone: a.phone})));

                console.log('ðŸ” Looking for client with name key:', clientId);

                // The clientId is now the client name (lowercase and trimmed)
                // Find all appointments for this client
                const clientAppointments = appointments.filter(apt =>
                    apt.name && apt.name.toLowerCase().trim() === clientId
                );

                console.log('ðŸ“‹ Found', clientAppointments.length, 'appointments for client:', clientId);

                if (clientAppointments.length === 0) {
                    console.error('âŒ No appointments found for client:', clientId);
                    alert('No se pudo encontrar la informaciÃ³n del cliente');
                    return;
                }

                // Get the most recent appointment for main client data
                const mainAppointment = clientAppointments
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                // Calculate totals
                const totalSpent = clientAppointments.reduce((sum, apt) => sum + (parseFloat(apt.price) || 0), 0);
                const appointmentCount = clientAppointments.length;

                // Sort appointments by date (most recent first) for display
                const sortedAppointments = clientAppointments
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                // Use the most recent appointment as the main appointment
                const recentAppointment = mainAppointment;

                // Build the modal content
                const modalContent = document.getElementById('client-details-content');
                modalContent.innerHTML = `
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--brand-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                                ${recentAppointment.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 style="margin: 0; color: var(--text-primary); font-size: 20px;">${recentAppointment.name}</h3>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">${appointmentCount} cita${appointmentCount !== 1 ? 's' : ''} realizadas</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <svg width="16" height="16" fill="var(--text-secondary)" viewBox="0 0 24 24">
                                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                    </svg>
                                    <span style="color: var(--text-secondary); font-size: 12px; font-weight: 500;">TELÃ‰FONO</span>
                                </div>
                                <p style="margin: 0; color: var(--text-primary); font-weight: 500;">${recentAppointment.phone || 'No registrado'}</p>
                            </div>

                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <svg width="16" height="16" fill="var(--text-secondary)" viewBox="0 0 24 24">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                        <circle cx="12" cy="10" r="3"/>
                                    </svg>
                                    <span style="color: var(--text-secondary); font-size: 12px; font-weight: 500;">CIUDAD</span>
                                </div>
                                <p style="margin: 0; color: var(--text-primary); font-weight: 500;">${recentAppointment.city || recentAppointment.address || 'No registrada'}</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <svg width="16" height="16" fill="var(--text-secondary)" viewBox="0 0 24 24">
                                        <line x1="12" y1="1" x2="12" y2="23"/>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                    </svg>
                                    <span style="color: var(--text-secondary); font-size: 12px; font-weight: 500;">TOTAL GASTADO</span>
                                </div>
                                <p style="margin: 0; color: var(--brand-primary); font-weight: bold; font-size: 18px;">$${totalSpent.toFixed(2)}</p>
                            </div>

                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <svg width="16" height="16" fill="var(--text-secondary)" viewBox="0 0 24 24">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    <span style="color: var(--text-secondary); font-size: 12px; font-weight: 500;">ÃšLTIMA CITA</span>
                                </div>
                                <p style="margin: 0; color: var(--text-primary); font-weight: 500;">${new Date(recentAppointment.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })}</p>
                            </div>
                        </div>
                    </div>

                    <div style="border-top: 1px solid var(--bg-border); padding-top: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 16px; font-weight: 600;">Historial de Citas</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${sortedAppointments.map(apt => {
                                const appointmentDate = parseLocalDate(apt.date);
                                const formattedDate = appointmentDate.toLocaleDateString('es-ES', {
                                    weekday: 'short',
                                    day: '2-digit',
                                    month: 'short',
                                    year: 'numeric'
                                });

                                return `
                                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                            <div>
                                                <p style="margin: 0; color: var(--text-primary); font-weight: 500; font-size: 14px;">${apt.job || 'Servicio de limpieza'}</p>
                                                <p style="margin: 0; color: var(--text-secondary); font-size: 12px;">${formattedDate} â€¢ ${apt.time}</p>
                                            </div>
                                            <span style="color: var(--brand-primary); font-weight: bold; font-size: 14px;">$${parseFloat(apt.price || 0).toFixed(2)}</span>
                                        </div>
                                        ${apt.address ? `<p style="margin: 0; color: var(--text-secondary); font-size: 12px;"><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 4px; vertical-align: middle;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>${apt.address}</p>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                // Show the modal
                document.getElementById('client-details-modal').style.display = 'flex';
            } catch (error) {
                console.error('Error showing client details:', error);
                alert('Error al cargar los detalles del cliente');
            }
        }

        function closeClientDetailsModal() {
            document.getElementById('client-details-modal').style.display = 'none';
        }

        // Functions will be made globally available after DOMContentLoaded


        function showSuccess() {
            const successMsg = document.getElementById('success-message');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
            
            // Update appointments counter
            updateAppointmentCounter();
        }

        function showError(message) {
            const errorMsg = document.getElementById('error-message');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }

        // Navigation functions
        function setupNavigation() {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach((item, index) => {
                item.addEventListener('click', () => {
                    // Remove active class from all items
                    menuItems.forEach(menuItem => menuItem.classList.remove('active'));
                    // Add active class to clicked item
                    item.classList.add('active');
                    
                    // Show corresponding view
                    switch(index) {
                        case 0: // Agendar Citas
                            showView('schedule');
                            break;
                        case 1: // Ver Calendario
                            showView('calendar');
                            break;
                        case 2: // Registro
                            showView('history');
                            loadClientRegistry();
                            break;
                        case 3: // Datos
                            showView('datos');
                            loadDatosAnalytics();
                            break;
                        case 4: // Finanzas
                            showView('finance');
                            loadFinanceData();
                            break;
                        case 5: // Mensajes
                            showView('messages');
                            break;
                        case 6: // ConfiguraciÃ³n
                            showView('settings');
                            break;
                    }
                });
            });
        }

        // Return to Bento Grid from any view
        function returnToBentoGrid() {
            // Close mobile menu if it's open
            closeMobileMenu();

            // Hide and ensure mobile overlay is completely removed
            const overlay = document.querySelector('.mobile-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                overlay.style.display = 'none';
            }

            // Hide main container
            const container = document.querySelector('.container');
            if (container) {
                container.classList.remove('view-enter');
                container.style.display = 'none';
            }

            // Hide back button
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.style.display = 'none';
            }

            // Hide header when returning to Bento Grid
            const header = document.querySelector('.header');
            if (header) {
                header.style.display = 'none';
            }

            // Show landing page with entrance animation
            const landingView = document.getElementById('landing-view');
            if (landingView) {
                landingView.classList.remove('landing-exit');
                landingView.classList.add('landing-enter');
                landingView.style.display = 'flex';

                // Remove animation class after it completes
                setTimeout(() => {
                    landingView.classList.remove('landing-enter');
                }, 400);
            }

            // Remove any body classes that might affect display
            document.body.classList.remove('mobile-menu-open');
        }

        // Navigate from Bento Grid to specific view
        function navigateToView(viewName) {
            const landingView = document.getElementById('landing-view');
            const container = document.querySelector('.container');

            // Add exit animation to landing page
            if (landingView) {
                landingView.classList.add('landing-exit');

                // After exit animation completes, hide landing and show view
                setTimeout(() => {
                    landingView.style.display = 'none';
                    landingView.classList.remove('landing-exit');

                    // Show and animate in the container
                    if (container) {
                        container.style.display = 'flex';
                        container.classList.remove('view-enter'); // Remove if exists
                        // Force reflow to restart animation
                        void container.offsetWidth;
                        container.classList.add('view-enter');

                        // Clean up animation class after it completes
                        setTimeout(() => {
                            container.classList.remove('view-enter');
                        }, 400);
                    }

                    // Activate corresponding menu item and show view
                    const menuItems = document.querySelectorAll('.menu-item');
                    const viewMapping = {
                        'schedule': 0,
                        'calendar': 1,
                        'history': 2,
                        'datos': 3,
                        'finance': 4,
                        'messages': 5,
                        'settings': 6
                    };

                    const menuIndex = viewMapping[viewName];
                    if (menuIndex !== undefined && menuItems[menuIndex]) {
                        // Remove active from all and add to selected
                        menuItems.forEach(item => item.classList.remove('active'));
                        menuItems[menuIndex].classList.add('active');
                    }

                    // Show the selected view
                    showView(viewName);

                    // Load view-specific data
                    if (viewName === 'history') {
                        loadClientRegistry();
                    } else if (viewName === 'datos') {
                        loadDatosAnalytics();
                    } else if (viewName === 'finance') {
                        loadFinanceData();
                    }

                    // Show mobile menu button (back arrow)
                    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
                    if (mobileMenuBtn) {
                        mobileMenuBtn.style.display = 'block';
                    }

                    // Show header when entering a section
                    const header = document.querySelector('.header');
                    if (header) {
                        header.style.display = 'flex';
                    }
                }, 300); // Match landing-exit duration
            }

            // Ensure mobile menu is closed
            const sidebar = document.getElementById('mobile-sidebar');
            if (sidebar) {
                sidebar.classList.remove('open');
            }

            // Hide mobile overlay
            const overlay = document.querySelector('.mobile-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                overlay.style.display = 'none';
            }

            // Remove body classes
            document.body.classList.remove('mobile-menu-open');
        }

        async function showView(viewName) {
            // Hide all views
            const views = ['schedule', 'calendar', 'history', 'datos', 'pago', 'finance', 'messages', 'settings'];
            views.forEach(view => {
                const element = document.getElementById(view + '-view');
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // Handle main content area
            const mainContent = document.querySelector('.content-area:not([id$="-view"])');
            if (viewName === 'schedule') {
                mainContent.style.display = 'block';
            } else {
                mainContent.style.display = 'none';
            }
            
            // Show selected view
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.style.display = 'block';
            }
            
            currentView = viewName;
            
            // Initialize view-specific content
            if (viewName === 'schedule') {
                loadAppointments(); // Update counter when showing schedule
            } else if (viewName === 'calendar') {
                updateToCurrentDay(); // Always ensure we start from current day
                await generateWeeklyCalendar();
            } else if (viewName === 'history') {
                loadClientRegistry();
            } else if (viewName === 'finance') {
                loadFinanceData();
            }
        }

        // Weekly Calendar functions
        async function generateWeeklyCalendar() {
            const grid = document.getElementById('weekly-calendar-grid');
            const weekRange = document.getElementById('current-week-range');
            
            // Always show 7 consecutive days starting from currentWeekStart
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            
            // Set the date range display
            const startStr = currentWeekStart.toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'short' 
            });
            const endStr = weekEnd.toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
            weekRange.textContent = `${startStr} â€“ ${endStr}`;
            
            // Clear grid
            grid.innerHTML = '';
            
            // Check if we're on mobile
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                await generateMobileCalendar(grid);
            } else {
                await generateDesktopCalendar(grid);
            }
        }

        async function generateMobileCalendar(grid) {
            const dayNames = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b']; // 0=Sunday, 1=Monday, etc.
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Get all appointments first (using unified OfflineDB)
            const allAppointments = await OfflineDB.getAppointments();
            console.log('ðŸ“… Calendar loading appointments:', allAppointments.length);
            console.log('ðŸ“… Sample appointment data:', allAppointments[0]);
            console.log('ðŸ” DEBUGGING ALL APPOINTMENT DATES:');
            allAppointments.forEach((apt, index) => {
                console.log(`ðŸ” Appointment ${index + 1}: date="${apt.date}", name="${apt.name}"`);
            });

            // Generate 7 consecutive days starting from currentWeekStart
            const mobileDays = [];
            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(currentWeekStart);
                currentDay.setDate(currentWeekStart.getDate() + i);
                const dateStr = currentDay.toISOString().split('T')[0];
                const isToday = currentDay.getTime() === today.getTime();
                const dayAppointments = allAppointments.filter(apt => apt.date === dateStr);
                console.log(`ðŸ“… Day ${dateStr}: Found ${dayAppointments.length} appointments`);
                if (dayAppointments.length > 0) {
                    console.log(`ðŸ“… Appointments for ${dateStr}:`, dayAppointments);
                }
                
                
                mobileDays.push({
                    date: currentDay,
                    dateStr,
                    dayIndex: i,
                    isToday,
                    appointments: dayAppointments,
                    dayName: dayNames[currentDay.getDay()]
                });
            }
            
            mobileDays.forEach(dayData => {
                // Create day section
                const daySection = document.createElement('div');
                daySection.className = 'mobile-day-section';
                daySection.style.cssText = `
                    margin-bottom: 24px;
                    border-radius: 12px;
                    padding: 16px;
                `;
                
                // Day header
                const dayHeader = document.createElement('div');
                dayHeader.className = 'mobile-day-header';
                dayHeader.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 16px;
                    padding-bottom: 12px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
                `;
                
                const dayTitle = document.createElement('div');
                dayTitle.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 12px;
                `;
                
                const dayName = document.createElement('span');
                dayName.textContent = dayData.dayName;
                dayName.style.cssText = `
                    font-size: 18px;
                    font-weight: 700;
                    color: ${dayData.isToday ? '#86efac' : 'rgba(255, 255, 255, 0.95)'};
                `;

                const dayNumber = document.createElement('span');
                dayNumber.textContent = dayData.date.getDate();
                dayNumber.style.cssText = `
                    background: ${dayData.isToday ? '#10a37f' : 'rgba(255, 255, 255, 0.15)'};
                    color: white;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 600;
                    font-size: 14px;
                `;
                
                dayTitle.appendChild(dayName);
                dayTitle.appendChild(dayNumber);
                dayHeader.appendChild(dayTitle);
                
                // Gas cost (only if there are appointments)
                if (dayData.appointments.length > 0) {
                    const cities = dayData.appointments.map(apt => apt.city);
                    const gasCost = calculateGasCost(cities);
                    
                    const gasCostElement = document.createElement('div');
                    gasCostElement.style.cssText = `
                        background: rgba(59, 130, 246, 0.25);
                        backdrop-filter: blur(8px);
                        -webkit-backdrop-filter: blur(8px);
                        color: rgba(147, 197, 253, 0.95);
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                        border: 1px solid rgba(59, 130, 246, 0.35);
                        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
                    `;
                    gasCostElement.textContent = `$${gasCost.toFixed(2)}`;
                    dayHeader.appendChild(gasCostElement);
                }
                
                daySection.appendChild(dayHeader);
                
                // Check for day events (vacaciones, libre, etc.)
                const dayEvent = getDayEvent(dayData.dateStr);
                
                // Appointments as client cards OR empty state OR day event
                if (dayData.appointments.length > 0) {
                    dayData.appointments.forEach(appointment => {
                        const clientCard = document.createElement('div');
                        clientCard.className = 'mobile-client-card';
                        clientCard.style.cssText = `
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 8px;
                            cursor: pointer;
                            transition: all 0.2s;
                        `;
                        
                        clientCard.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="flex: 1; min-width: 0;">
                                    <h3 style="font-size: 15px; font-weight: 600; color: rgba(255, 255, 255, 0.95); margin: 0 0 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${appointment.name}</h3>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <svg style="width: 14px; height: 14px; color: rgba(255, 255, 255, 0.7); flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                        <span style="color: rgba(255, 255, 255, 0.7); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${appointment.city}</span>
                                    </div>
                                </div>
                                <span style="background: rgba(59, 130, 246, 0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); color: white; border: 1px solid rgba(59, 130, 246, 0.4); padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; flex-shrink: 0; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);">${appointment.time}</span>
                            </div>
                        `;
                        
                        clientCard.addEventListener('click', () => showAppointmentDetails(appointment));
                        daySection.appendChild(clientCard);
                    });
                    
                    // Add "Agendar Cita" button if there's still room for more appointments
                    const availableSlots = MAX_APPOINTMENTS_PER_DAY - dayData.appointments.length;
                    if (availableSlots > 0) {
                        const addAppointmentBtn = document.createElement('button');
                        addAppointmentBtn.style.cssText = `
                            width: 100%;
                            background: rgba(59, 130, 246, 0.25);
                            backdrop-filter: blur(12px);
                            -webkit-backdrop-filter: blur(12px);
                            color: rgba(255, 255, 255, 0.95);
                            border: 1px solid rgba(59, 130, 246, 0.3);
                            border-radius: 8px;
                            padding: 12px 16px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            margin-top: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
                        `;
                        addAppointmentBtn.innerHTML = `
                            <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                <path d="m9 14 2 2 4-4"></path>
                            </svg>
                            Agendar Cita (${availableSlots} disponible${availableSlots > 1 ? 's' : ''})
                        `;
                        
                        addAppointmentBtn.addEventListener('click', () => {
                            showView('schedule');
                        });
                        
                        addAppointmentBtn.addEventListener('mouseover', () => {
                            addAppointmentBtn.style.background = 'rgba(59, 130, 246, 0.35)';
                            addAppointmentBtn.style.borderColor = 'rgba(59, 130, 246, 0.5)';
                            addAppointmentBtn.style.transform = 'translateY(-2px)';
                            addAppointmentBtn.style.boxShadow = '0 6px 20px rgba(59, 130, 246, 0.25)';
                        });

                        addAppointmentBtn.addEventListener('mouseout', () => {
                            addAppointmentBtn.style.background = 'rgba(59, 130, 246, 0.25)';
                            addAppointmentBtn.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                            addAppointmentBtn.style.transform = 'translateY(0)';
                            addAppointmentBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
                        });
                        
                        daySection.appendChild(addAppointmentBtn);
                    }
                } else if (dayEvent) {
                    // Show day event
                    const eventCard = document.createElement('div');
                    eventCard.className = 'mobile-client-card';
                    eventCard.style.cssText = `
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                    `;
                    
                    const eventConfig = {
                        'vacaciones': {
                            color: '#fca5a5',
                            icon: 'M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z',
                            text: 'Vacaciones'
                        },
                        'libre': {
                            color: '#86efac',
                            icon: 'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z',
                            text: 'DÃ­a Libre'
                        },
                        'compromiso': {
                            color: '#fcd34d',
                            icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.5 6L12 10.5 8.5 8 12 5.5 15.5 8z',
                            text: 'Compromiso'
                        },
                        'salida': {
                            color: '#c4b5fd',
                            icon: 'M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4',
                            text: 'Salida'
                        },
                        'sin-pega': {
                            color: '#d1d5db',
                            icon: 'M18 6L6 18M6 6l12 12',
                            text: 'Sin Pega'
                        }
                    };

                    const config = eventConfig[dayEvent];
                    eventCard.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <svg style="width: 20px; height: 20px; color: ${config.color}; flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="${config.icon}"></path>
                            </svg>
                            <p style="margin: 0; color: ${config.color}; font-weight: 600; font-size: 14px; flex: 1;">${config.text}</p>
                            <span style="color: ${config.color}; font-size: 12px; opacity: 0.7;">Todo el dÃ­a</span>
                        </div>
                    `;
                    
                    // Add click to remove event
                    eventCard.style.cursor = 'pointer';
                    eventCard.addEventListener('click', () => {
                        if (confirm('Â¿Quieres eliminar este evento?')) {
                            removeEventFromDay(dayData.dateStr);
                        }
                    });
                    
                    daySection.appendChild(eventCard);
                } else {
                    // Empty state for days without appointments
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state mobile-client-card';
                    emptyState.style.cssText = `
                        border: 1px dashed rgba(255, 255, 255, 0.3);
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    `;
                    
                    emptyState.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <svg style="width: 16px; height: 16px; color: rgba(255, 255, 255, 0.7); flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span style="color: rgba(255, 255, 255, 0.7); font-size: 14px; flex: 1; font-style: italic;">Sin citas programadas</span>
                        </div>
                        <button style="background: rgba(59, 130, 246, 0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); color: white; border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer; flex-shrink: 0; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);">
                            + Evento
                        </button>
                    `;
                    
                    emptyState.addEventListener('click', () => showEventOptions(dayData.dateStr));
                    emptyState.addEventListener('mouseover', () => {
                        emptyState.style.borderColor = 'rgba(59, 130, 246, 0.5)';
                    });
                    emptyState.addEventListener('mouseout', () => {
                        emptyState.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    });
                    
                    daySection.appendChild(emptyState);
                }
                
                grid.appendChild(daySection);
            });
        }

        async function generateDesktopCalendar(grid) {
            const dayNames = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b']; // 0=Sunday, 1=Monday, etc.
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Get all appointments first (using unified OfflineDB)
            const allAppointments = await OfflineDB.getAppointments();
            console.log('ðŸ–¥ï¸ Desktop Calendar loading appointments:', allAppointments.length);

            // Generate 7 consecutive days starting from currentWeekStart
            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(currentWeekStart);
                currentDay.setDate(currentWeekStart.getDate() + i);
                const dateStr = currentDay.toISOString().split('T')[0];
                
                
                // Check if this is today
                const isToday = currentDay.getTime() === today.getTime();
                
                // Get appointments for this day
                const dayAppointments = allAppointments.filter(apt => apt.date === dateStr);
                let availableSlots = MAX_APPOINTMENTS_PER_DAY - dayAppointments.length;
                
                // Create day column 
                const dayColumn = document.createElement('div');
                dayColumn.className = isToday ? 'day-column today' : 'day-column';
                
                // Day header (clean, without gas cost)
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                
                const dayName = document.createElement('div');
                dayName.className = 'day-name';
                dayName.textContent = dayNames[currentDay.getDay()]; // Use actual day name based on date
                dayHeader.appendChild(dayName);
                
                const dayNumber = document.createElement('div');
                dayNumber.className = isToday ? 'day-number today' : 'day-number';
                dayNumber.textContent = currentDay.getDate();
                dayHeader.appendChild(dayNumber);
                dayColumn.appendChild(dayHeader);
                
                // Create wrapper for gas cost and day column
                const dayWrapper = document.createElement('div');
                dayWrapper.className = 'day-wrapper';
                
                // Add gas cost OUTSIDE and ABOVE the day column if there are appointments
                if (dayAppointments.length > 0) {
                    const cities = dayAppointments.map(apt => apt.city);
                    const gasCost = calculateGasCost(cities);
                    
                    const gasCostElement = document.createElement('div');
                    gasCostElement.className = 'gas-cost-outside';
                    gasCostElement.style.cssText = `
                        background: rgba(59, 130, 246, 0.3);
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                        color: rgba(255, 255, 255, 0.95);
                        border: 1px solid rgba(59, 130, 246, 0.4);
                        padding: 4px 8px;
                        margin-bottom: 4px;
                        border-radius: 6px;
                        text-align: center;
                        font-weight: 600;
                        font-size: 11px;
                        line-height: 1.2;
                        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
                    `;
                    gasCostElement.textContent = `$${gasCost.toFixed(2)}`;
                    dayWrapper.appendChild(gasCostElement);
                }
                
                // Always add the dayColumn to the wrapper
                dayWrapper.appendChild(dayColumn);
                
                // Check for day events (vacaciones, libre, etc.)
                const dayEvent = getDayEvent(dateStr);
                
                if (dayEvent) {
                    // Show day event in desktop
                    const eventSlot = document.createElement('div');
                    eventSlot.className = 'appointment-slot event-slot';
                    
                    const eventConfig = {
                        'vacaciones': { color: '#dc2626', bg: '#fee2e2', text: 'ðŸ”´ Vacaciones' },
                        'libre': { color: '#059669', bg: '#dcfce7', text: 'ðŸŸ¢ DÃ­a Libre' },
                        'compromiso': { color: '#d97706', bg: '#fef3c7', text: 'ðŸŸ  Compromiso' },
                        'salida': { color: '#7c3aed', bg: '#ede9fe', text: 'ðŸŸ£ Salida' },
                        'sin-pega': { color: '#6b7280', bg: '#f3f4f6', text: 'âš« Sin Pega' }
                    };
                    
                    const config = eventConfig[dayEvent];
                    eventSlot.style.cssText = `
                        background: ${config.bg};
                        color: ${config.color};
                        border: 1px solid ${config.color}40;
                        text-align: center;
                        font-weight: 600;
                        cursor: pointer;
                    `;
                    
                    eventSlot.innerHTML = `
                        <div class="slot-time">${config.text}</div>
                        <div class="slot-info">Click para eliminar</div>
                    `;
                    
                    eventSlot.addEventListener('click', () => {
                        if (confirm('Â¿Quieres eliminar este evento?')) {
                            removeEventFromDay(dateStr);
                        }
                    });
                    
                    dayColumn.appendChild(eventSlot);
                    
                    // Add fewer available slots since event takes one slot
                    for (let j = 0; j < (availableSlots - 1); j++) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'appointment-slot available';
                        emptySlot.innerHTML = `
                            <div class="slot-time">Disponible</div>
                            <div class="slot-info">Espacio libre</div>
                        `;
                        dayColumn.appendChild(emptySlot);
                    }
                } else {
                    // Add existing appointments
                    dayAppointments.forEach(appointment => {
                        const appointmentSlot = document.createElement('div');
                        appointmentSlot.className = 'appointment-slot booked';
                        appointmentSlot.innerHTML = `
                            <div class="slot-time">${appointment.time}</div>
                            <div class="slot-info">${appointment.name}</div>
                        `;
                        appointmentSlot.addEventListener('click', () => showAppointmentDetails(appointment));
                        dayColumn.appendChild(appointmentSlot);
                    });
                    
                    // Add "Agendar Cita" button if there are appointments and still room for more
                    if (dayAppointments.length > 0 && availableSlots > 0) {
                        const addAppointmentSlot = document.createElement('div');
                        addAppointmentSlot.className = 'appointment-slot';
                        addAppointmentSlot.style.cssText = `
                            background: var(--brand-primary);
                            color: white;
                            border: 2px solid #10a37f;
                            cursor: pointer;
                            transition: all 0.2s;
                            text-align: center;
                            font-weight: 600;
                        `;
                        addAppointmentSlot.innerHTML = `
                            <div class="slot-time">+ Agendar</div>
                            <div class="slot-info">${availableSlots} disponible${availableSlots > 1 ? 's' : ''}</div>
                        `;
                        
                        addAppointmentSlot.addEventListener('click', () => {
                            showView('schedule');
                        });
                        
                        addAppointmentSlot.addEventListener('mouseover', () => {
                            addAppointmentSlot.style.background = '#059669';
                            addAppointmentSlot.style.borderColor = '#059669';
                            addAppointmentSlot.style.transform = 'translateY(-1px)';
                        });
                        
                        addAppointmentSlot.addEventListener('mouseout', () => {
                            addAppointmentSlot.style.background = '#10a37f';
                            addAppointmentSlot.style.borderColor = '#10a37f';
                            addAppointmentSlot.style.transform = 'translateY(0)';
                        });
                        
                        dayColumn.appendChild(addAppointmentSlot);
                        
                        // Reduce available slots by 1 since we added the button
                        availableSlots--;
                    }
                    
                    // Add available slots
                    for (let j = 0; j < availableSlots; j++) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'appointment-slot available';
                        emptySlot.innerHTML = `
                            <div class="slot-time">Disponible</div>
                            <div class="slot-info">Espacio libre</div>
                        `;
                        dayColumn.appendChild(emptySlot);
                    }
                }
                
                
                grid.appendChild(dayWrapper);
            }
        }

        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            generateWeeklyCalendar();
        }

        async function getAppointmentsForDate(dateStr) {
            try {
                const appointments = await OfflineDB.getAppointments();
                return appointments.filter(apt => apt.date === dateStr);
            } catch (error) {
                console.error('ðŸ’¥ Error getting appointments for date:', error);
                return [];
            }
        }

        // Modal functions
        function showAppointmentDetails(appointment) {
            selectedAppointment = appointment;
            const modal = document.getElementById('appointment-modal');
            const content = document.getElementById('appointment-details-content');
            
            content.innerHTML = `
                <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: #2d333a;">${appointment.name}</h4>
                        <span style="background: #10a37f; color: white; padding: 6px 12px; border-radius: 6px; font-weight: 600;">${appointment.time}</span>
                    </div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        ðŸ“… ${parseLocalDate(appointment.date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </div>
                </div>
                
                <div style="display: grid; gap: 12px;">
                    <div>
                        <strong style="color: #374151;">DirecciÃ³n:</strong>
                        <p style="margin: 4px 0;">
                            <a href="#" onclick="openGoogleMaps('${appointment.address}', '${appointment.city}'); return false;" 
                               style="color: var(--brand-primary); text-decoration: none; cursor: pointer; transition: color 0.2s;" 
                               onmouseover="this.style.color='var(--brand-hover)'" 
                               onmouseout="this.style.color='var(--brand-primary)'">
                                ${appointment.address}
                            </a>
                        </p>
                    </div>
                    <div>
                        <strong style="color: #374151;">Ciudad:</strong>
                        <p style="margin: 4px 0; color: #666;">${appointment.city}</p>
                    </div>
                    ${appointment.job ? `
                        <div>
                            <strong style="color: #374151;">Trabajo:</strong>
                            <p style="margin: 4px 0; color: #666;">${appointment.job}</p>
                        </div>
                    ` : ''}
                    <div>
                        <strong style="color: #374151;">Precio:</strong>
                        <p style="margin: 4px 0; color: #666; font-size: 18px; font-weight: 600;">$${appointment.price}</p>
                    </div>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5; font-size: 12px; color: #999;">
                    Creado: ${new Date(appointment.timestamp).toLocaleString('es-ES')}
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function closeAppointmentModal() {
            document.getElementById('appointment-modal').style.display = 'none';
            selectedAppointment = null;
        }

        // Service Pricing Configuration
        const SERVICE_PRICES = {
            'Bedrooms': { basePrice: 30, priceRange: '$30 each' },
            'Hallways': { basePrice: 20, minPrice: 10, maxPrice: 30, priceRange: '$10 - $30' },
            'Living Rooms': { basePrice: 45, minPrice: 30, maxPrice: 60, priceRange: '$30 - $60' },
            'Stairs': { basePrice: 50, minPrice: 45, maxPrice: 55, priceRange: '$45 - $55' },
            'Odor Removal': { basePrice: 20, priceRange: '$20 per area' },
            '1-Seat Chair': { basePrice: 35, priceRange: '$35 each' },
            '2-Seat Loveseat': { basePrice: 65, priceRange: '$65 each' },
            '3-Seat Sofa': { basePrice: 85, priceRange: '$85 each' },
            'Sectionals': { basePrice: 100, priceRange: 'From $100' },
            'Dining Chairs': { basePrice: 10, priceRange: '$10 each' }
        };

        // Appointment Management Functions
        async function deleteAppointment() {
            if (!selectedAppointment) {
                alert('No appointment selected');
                return;
            }
            
            const confirmDelete = confirm(`Â¿EstÃ¡s seguro de que quieres eliminar la cita de ${selectedAppointment.name}?`);
            if (!confirmDelete) return;
            
            try {
                // Delete from both online and offline storage
                await OfflineDB.deleteAppointment(selectedAppointment.id);
                
                // Close the details modal
                closeAppointmentModal();
                
                // Refresh the calendar view
                if (currentView === 'calendar') {
                    await generateWeeklyCalendar();
                }
                
                alert('âœ… Cita eliminada exitosamente');
                
            } catch (error) {
                console.error('âŒ Error deleting appointment:', error);
                alert('Error al eliminar la cita. Por favor intenta nuevamente.');
            }
        }
        
        // Store appointment data for rescheduling
        let appointmentToReschedule = null;
        
        function rescheduleAppointment() {
            if (!selectedAppointment) {
                alert('No appointment selected');
                return;
            }
            
            // Save appointment data before closing the modal
            appointmentToReschedule = { ...selectedAppointment };
            
            // Close the appointment details modal
            const modal = document.getElementById('appointment-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Set today's date as default in the reschedule form
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            document.getElementById('reschedule-date').value = todayString;
            document.getElementById('reschedule-time').value = '';
            
            // Show the reschedule modal
            document.getElementById('reschedule-modal').style.display = 'flex';
        }
        
        function closeRescheduleModal() {
            document.getElementById('reschedule-modal').style.display = 'none';
            appointmentToReschedule = null; // Clear the stored data
        }

        // Edit appointment functions
        function editAppointment() {
            if (!selectedAppointment) {
                alert('No appointment selected');
                return;
            }

            // Get the phone number from PhoneManager
            const phone = PhoneManager.get(selectedAppointment.id) || selectedAppointment.phone || '';

            // Populate the edit form with current appointment data
            document.getElementById('edit-client-name').value = selectedAppointment.name || '';
            document.getElementById('edit-client-phone').value = phone;
            document.getElementById('edit-client-city').value = selectedAppointment.city || '';
            document.getElementById('edit-client-address').value = selectedAppointment.address || '';
            document.getElementById('edit-appointment-date').value = selectedAppointment.date || '';
            document.getElementById('edit-appointment-time').value = selectedAppointment.time || '';
            document.getElementById('edit-appointment-job').value = selectedAppointment.job || '';
            document.getElementById('edit-appointment-price').value = selectedAppointment.price || '';

            // Show the edit modal
            document.getElementById('edit-appointment-modal').style.display = 'flex';
        }

        function closeEditAppointmentModal() {
            document.getElementById('edit-appointment-modal').style.display = 'none';
        }

        async function handleEditFormSubmit(e) {
            e.preventDefault();

            if (!selectedAppointment) {
                alert('No appointment selected');
                return;
            }

            try {
                // Get form data
                const formData = {
                    id: selectedAppointment.id,
                    name: document.getElementById('edit-client-name').value.trim(),
                    phone: document.getElementById('edit-client-phone').value.trim(),
                    city: document.getElementById('edit-client-city').value.trim(),
                    address: document.getElementById('edit-client-address').value.trim(),
                    date: document.getElementById('edit-appointment-date').value,
                    time: document.getElementById('edit-appointment-time').value,
                    job: document.getElementById('edit-appointment-job').value.trim(),
                    price: parseFloat(document.getElementById('edit-appointment-price').value) || 0,
                    timestamp: selectedAppointment.timestamp, // Keep original timestamp
                    created_at: selectedAppointment.created_at // Keep original creation time
                };

                // Validate required fields
                if (!formData.name || !formData.city || !formData.address ||
                    !formData.date || !formData.time || !formData.job) {
                    alert('Por favor completa todos los campos requeridos');
                    return;
                }

                console.log('âœï¸ Updating appointment:', formData);

                // Save phone number to PhoneManager if provided
                if (formData.phone) {
                    PhoneManager.save(formData.id, formData.phone);
                }

                // Update the appointment
                await OfflineDB.saveAppointment(formData);

                // Update selectedAppointment object
                selectedAppointment = formData;

                console.log('âœ… Appointment updated successfully');

                // Close modals
                closeEditAppointmentModal();
                closeAppointmentModal();

                // Refresh the calendar view
                if (currentView === 'calendar') {
                    await generateWeeklyCalendar();
                }

                // Refresh client registry if it's currently visible or if we have clients loaded
                console.log('ðŸ”„ Refreshing client registry after edit...');
                setTimeout(async () => {
                    await loadClientRegistry();
                }, 100);

                // Show success message
                alert('âœ… Cita actualizada exitosamente');

            } catch (error) {
                console.error('âŒ Error updating appointment:', error);
                alert('Error al actualizar la cita: ' + error.message);
            }
        }
        
        async function confirmReschedule() {
            const newDate = document.getElementById('reschedule-date').value;
            const newTime = document.getElementById('reschedule-time').value;
            
            if (!newDate || !newTime) {
                alert('Por favor selecciona una nueva fecha y hora');
                return;
            }
            
            if (!appointmentToReschedule) {
                alert('Error: No se pudo encontrar la cita original');
                closeRescheduleModal();
                return;
            }
            
            try {
                // Create proper timestamp
                const appointmentDateTime = new Date(`${newDate}T${newTime}:00`);
                const newTimestamp = appointmentDateTime.getTime();

                console.log('ðŸ“… Original appointment:', appointmentToReschedule);
                console.log('ðŸ“… New date:', newDate, 'New time:', newTime);
                console.log('ðŸ“… New timestamp:', newTimestamp);

                // BETTER APPROACH: Just update the existing appointment instead of delete + create
                const updatedAppointment = {
                    ...appointmentToReschedule,
                    date: newDate,
                    time: newTime,
                    timestamp: newTimestamp,
                    // Preserve original timestamp for Supabase update
                    originalTimestamp: appointmentToReschedule.timestamp,
                    // Ensure created_at exists so system knows this is an update
                    created_at: appointmentToReschedule.created_at || new Date().toISOString()
                };

                console.log('ðŸ“… Updating appointment with new data:', updatedAppointment);
                await OfflineDB.saveAppointment(updatedAppointment);
                console.log('âœ… Appointment rescheduled successfully');
                
                // Close modal and refresh calendar
                closeRescheduleModal();
                
                if (currentView === 'calendar') {
                    await generateWeeklyCalendar();
                }
                
                alert(`âœ… Cita reagendada exitosamente para ${newDate} a las ${newTime}`);
                
            } catch (error) {
                console.error('âŒ Error rescheduling appointment:', error);
                alert('Error al reagendar la cita. Por favor intenta nuevamente.');
            }
        }

        // Receipt Generation Functions
        function generateReceiptModal() {
            if (!selectedAppointment) return;

            const modal = document.getElementById('receipt-modal');
            const clientInfo = document.getElementById('receipt-client-info');

            // Show client information
            clientInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
                    <div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Client</div>
                        <div style="color: #374151;">${selectedAppointment.name}</div>
                        <div style="color: #6b7280; font-size: 12px; margin-top: 2px;">${selectedAppointment.phone || 'N/A'}</div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Original Appointment Price</div>
                        <div style="color: #059669; font-size: 16px; font-weight: 600;">$${selectedAppointment.price}</div>
                        <div style="color: #6b7280; font-size: 12px; margin-top: 2px;">${selectedAppointment.job || 'General service'}</div>
                    </div>
                </div>
            `;

            // AUTO-POPULATE receipt services from appointment data
            receiptServices = [];

            // Pre-populate with appointment job and price data
            if (selectedAppointment.job && selectedAppointment.price && selectedAppointment.price > 0) {
                // Try to match appointment job to known service types, or use as custom service
                let serviceType = selectedAppointment.job;
                let servicePrice = parseFloat(selectedAppointment.price);

                // Check if job matches any of our service types
                const matchedService = Object.keys(SERVICE_PRICES).find(service =>
                    serviceType.toLowerCase().includes(service.toLowerCase()) ||
                    service.toLowerCase().includes(serviceType.toLowerCase())
                );

                if (matchedService) {
                    serviceType = matchedService;
                }

                receiptServices.push({
                    service: serviceType,
                    quantity: 1,
                    price: servicePrice,
                    total: servicePrice
                });

                console.log('âœ… Auto-populated receipt with appointment data:', {
                    service: serviceType,
                    price: servicePrice,
                    originalJob: selectedAppointment.job
                });
            }

            updateReceiptPreview();

            // Auto-populate phone number from appointment if available
            const phoneInput = document.getElementById('phone-number');
            if (phoneInput && selectedAppointment.phone) {
                // Clean phone number for receipt format (remove non-digits except +)
                const cleanPhone = selectedAppointment.phone.replace(/[^\d+]/g, '');
                phoneInput.value = cleanPhone;
                console.log('âœ… Auto-populated phone number:', cleanPhone);
            }

            modal.style.display = 'flex';
        }
        
        // Update service price based on selection
        function updateServicePrice() {
            const serviceType = document.getElementById('service-type').value;
            const priceInput = document.getElementById('service-price');
            const priceSuggestion = document.getElementById('price-suggestion');
            
            if (serviceType && SERVICE_PRICES[serviceType]) {
                const serviceData = SERVICE_PRICES[serviceType];
                priceInput.value = serviceData.basePrice;
                priceSuggestion.textContent = `Suggested price: ${serviceData.priceRange}`;
                priceSuggestion.style.color = 'var(--brand-primary)';
            } else {
                priceInput.value = '';
                priceSuggestion.textContent = 'Adjust price based on actual work performed';
                priceSuggestion.style.color = '#6b7280';
            }
        }
        
        // Add detailed service to receipt
        function addDetailedService() {
            const serviceType = document.getElementById('service-type').value;
            const quantity = parseInt(document.getElementById('service-quantity').value) || 1;
            const price = parseFloat(document.getElementById('service-price').value) || 0;
            
            if (!serviceType || price <= 0) {
                alert('Please complete all service fields');
                return;
            }
            
            receiptServices.push({
                service: serviceType,
                quantity: quantity,
                price: price,
                total: quantity * price
            });
            
            // Clear form
            document.getElementById('service-type').value = '';
            document.getElementById('service-quantity').value = '1';
            document.getElementById('service-price').value = '';
            document.getElementById('price-suggestion').textContent = 'Adjust price based on actual work performed';
            document.getElementById('price-suggestion').style.color = '#6b7280';
            
            updateReceiptPreview();
        }
        
        let receiptServices = [];
        
        // Updated receipt preview function
        function updateReceiptPreview() {
            const servicesList = document.getElementById('services-list');
            
            if (receiptServices.length === 0) {
                servicesList.innerHTML = `
                    <div style="color: #6b7280; text-align: center; padding: 20px; font-style: italic;">
                        No services added yet
                    </div>
                `;
                return;
            }
            
            const totalAmount = receiptServices.reduce((sum, service) => sum + service.total, 0);
            
            servicesList.innerHTML = `
                <div style="space-y: 8px;">
                    ${receiptServices.map((service, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 4px;">
                            <div>
                                <div style="font-weight: 500; color: #1f2937;">${service.service}</div>
                                <div style="color: #6b7280; font-size: 12px;">${service.quantity} Ã— $${service.price.toFixed(2)}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-weight: 600; color: #059669;">$${service.total.toFixed(2)}</span>
                                <button onclick="removeDetailedService(${index})" style="background: #dc2626; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">âœ•</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="border-top: 1px solid #e5e5e5; margin-top: 12px; padding-top: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 16px;">
                        <span>Total:</span>
                        <span style="color: #059669;">$${totalAmount.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }
        
        // Remove service function
        function removeDetailedService(index) {
            receiptServices.splice(index, 1);
            updateReceiptPreview();
        }
        
        // Close modal function
        function closeReceiptModal() {
            document.getElementById('receipt-modal').style.display = 'none';
            document.getElementById('phone-number').value = '';
            receiptServices = [];
            updateReceiptPreview();
        }
        
        // Generate Receipt Preview (New simplified workflow)
        async function generateReceiptOnly() {
            console.log('Generate Receipt Preview clicked');
            console.log('receiptServices:', receiptServices);
            console.log('selectedAppointment:', selectedAppointment);

            if (receiptServices.length === 0) {
                alert('Por favor agrega al menos un servicio');
                return;
            }

            if (!selectedAppointment) {
                alert('Por favor selecciona una cita primero');
                return;
            }

            // 1. Save phone number if provided
            const phoneInput = document.getElementById('phone-number');
            const inputPhoneNumber = phoneInput ? phoneInput.value.trim() : '';

            if (inputPhoneNumber && selectedAppointment.id) {
                try {
                    console.log('ðŸ’¾ Saving phone number to customer record...');
                    await updateCustomerPhone(selectedAppointment.id, inputPhoneNumber);
                    selectedAppointment.phone = inputPhoneNumber;
                    updateClientDisplayWithPhone(inputPhoneNumber);
                    console.log('âœ… Phone number saved successfully:', inputPhoneNumber);
                } catch (error) {
                    console.error('âŒ Error saving phone number:', error);
                }
            }

            // Generate receipt HTML and show preview
            showReceiptPreview();
        }

        // Show receipt preview modal with HTML content
        function showReceiptPreview() {
            const receiptNumber = generateRealisticInvoiceNumber();
            const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            const totalAmount = receiptServices.reduce((sum, service) => sum + service.total, 0);

            // Generate professional HTML receipt
            const receiptHTML = generateReceiptHTML(receiptNumber, currentDate, totalAmount);

            // Show in preview modal
            document.getElementById('receipt-preview-content').innerHTML = receiptHTML;

            // Store receipt data for later use (SMS/PDF)
            window.currentReceiptData = {
                receiptNumber,
                currentDate,
                totalAmount,
                services: [...receiptServices],
                appointment: {...selectedAppointment}
            };

            // Close the receipt generation modal and show preview
            closeReceiptModal();
            document.getElementById('receipt-preview-modal').style.display = 'flex';
        }

        // Get professional service description based on service type
        function getServiceDescription(serviceType) {
            const descriptions = {
                // Standard cleaning services
                'House Cleaning': 'Comprehensive residential cleaning service including dusting, vacuuming, and sanitizing',
                'Apartment Cleaning': 'Complete apartment maintenance cleaning with specialized equipment',
                'Deep Cleaning': 'Intensive deep-clean service with thorough attention to detail',
                'Move-in/Move-out Cleaning': 'Professional transition cleaning with detailed checklist',

                // Commercial services
                'Office Cleaning': 'Commercial office cleaning with certified technicians',
                'Commercial Cleaning': 'Professional cleaning services for commercial spaces',

                // Specialized services
                'Window Cleaning': 'Professional window cleaning with streak-free results',
                'Carpet Cleaning': 'Hot water extraction carpet restoration service',
                'Post-Construction Cleaning': 'Construction site cleanup and debris removal',

                // Default professional descriptions (rotating options)
                'default': [
                    'Professional cleaning service with quality assurance and satisfaction guarantee',
                    'Premium cleaning service featuring specialized equipment and industry-standard procedures',
                    'Professional-grade cleaning with surface protection application',
                    'Advanced cleaning methodology with time-efficient processes',
                    'Specialized cleaning service with trained technicians',
                    'Cleaning Services by RIZE Professional Cleaning',
                    'Quality cleaning services with attention to detail',
                    'Professional cleaning solutions for your home or business'
                ]
            };

            // Check if we have a specific description for this service type
            if (descriptions[serviceType]) {
                return descriptions[serviceType];
            }

            // For unknown service types, rotate through default professional descriptions
            const defaultDescriptions = descriptions.default;
            const hash = serviceType.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            const index = Math.abs(hash) % defaultDescriptions.length;
            return defaultDescriptions[index];
        }

        // Generate professional HTML receipt content
        function generateReceiptHTML(receiptNumber, currentDate, totalAmount) {
            // Generate QR code for LivinGreen website
            const qrData = `https://www.livingreen.life/`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(qrData)}`;

            return `
                <div class="mobile-invoice-container" style="max-width: 400px !important; width: 400px !important; margin: 0 auto !important; background: white !important; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important; border-radius: 12px !important; overflow: hidden !important; box-shadow: 0 2px 20px rgba(0,0,0,0.1) !important; position: relative !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;">

                    <!-- Mobile Invoice Header -->
                    <div style="background: var(--bg-tertiary); padding: 20px 20px 16px 20px; border-bottom: 1px solid #e9ecef; position: relative;">
                        <!-- Invoice Number Top Right -->
                        <div style="position: absolute; top: 20px; right: 20px; text-align: right; font-size: 14px; color: #6c757d; font-weight: 500;">
                            ${receiptNumber}
                        </div>

                        <div style="text-align: center; margin-bottom: 16px;">
                            <h1 style="margin: 0; font-size: 24px; font-weight: 600; color: #212529;">Invoice</h1>
                        </div>

                        <!-- Client Name -->
                        <div style="text-align: center; margin-bottom: 16px;">
                            <div style="font-size: 18px; font-weight: 500; color: #495057;">${selectedAppointment.name}</div>
                        </div>

                        <!-- Prominent Total Amount -->
                        <div style="text-align: center; margin-bottom: 16px;">
                            <div style="font-size: 48px; font-weight: 700; color: #28a745; line-height: 1;">$${totalAmount.toFixed(0)}</div>
                        </div>

                        <!-- Green Paid Status with Checkmark -->
                        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                            <div style="background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                <div style="width: 20px; height: 20px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <div style="color: #28a745; font-size: 14px; font-weight: bold;">âœ“</div>
                                </div>
                                <span>Paid</span>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Details Section -->
                    <div style="padding: 20px;">
                        <!-- Items Count -->
                        <div style="margin-bottom: 16px; color: #6c757d; font-size: 14px;">
                            ${receiptServices.length} ${receiptServices.length === 1 ? 'item' : 'items'}
                        </div>

                        <!-- Services List -->
                        <div style="margin-bottom: 24px;">
                            ${receiptServices.map((service, index) => `
                                <div style="border-bottom: ${index === receiptServices.length - 1 ? 'none' : '1px solid #e9ecef'}; padding: 16px 0;">
                                    <!-- Service Name and Price -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-size: 16px; font-weight: 500; color: #212529;">
                                            ${service.service}
                                        </div>
                                        <div style="font-size: 16px; font-weight: 600; color: #212529;">
                                            $${service.total.toFixed(2)}
                                        </div>
                                    </div>

                                    <!-- Quantity and Unit Price -->
                                    <div style="font-size: 14px; color: #6c757d;">
                                        ${service.quantity} Ã— $${service.price.toFixed(2)} each
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Summary Section -->
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                            <!-- Subtotal -->
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 14px; color: #6c757d;">Subtotal</span>
                                <span style="font-size: 14px; color: #212529;">$${totalAmount.toFixed(2)}</span>
                            </div>

                            <!-- Tax -->
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 14px; color: #6c757d;">Tax</span>
                                <span style="font-size: 14px; color: #212529;">$0.00</span>
                            </div>

                            <!-- Total -->
                            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #dee2e6;">
                                <span style="font-size: 16px; font-weight: 600; color: #212529;">Total</span>
                                <span style="font-size: 16px; font-weight: 600; color: #212529;">$${totalAmount.toFixed(2)}</span>
                            </div>

                            <!-- Paid Amount in Green -->
                            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                <span style="font-size: 14px; color: #28a745; font-weight: 500;">Paid</span>
                                <span style="font-size: 14px; color: #28a745; font-weight: 600;">$${totalAmount.toFixed(2)}</span>
                            </div>
                        </div>

                        <!-- QR Code Section -->
                        <div style="text-align: center; padding: 20px 0; border-top: 1px solid #e9ecef;">
                            <div style="margin-bottom: 12px;">
                                <img src="${qrCodeUrl}" alt="QR Code" style="width: 80px; height: 80px; border: 1px solid #dee2e6; border-radius: 4px;">
                            </div>
                            <div style="font-size: 12px; color: #6c757d;">Visit our website</div>
                        </div>

                        <!-- Business Info -->
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <div style="font-size: 16px; font-weight: 600; color: #212529; margin-bottom: 8px; text-align: center;">LivinGreen</div>
                            <div style="font-size: 12px; color: #6c757d; text-align: center; line-height: 1.4;">
                                <div>Web: www.livingreen.life</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Close receipt preview and return to edit mode
        function closeReceiptPreview() {
            document.getElementById('receipt-preview-modal').style.display = 'none';
            document.getElementById('receipt-modal').style.display = 'flex';
        }

        // Download PDF from preview - PRESERVES EXACT MOBILE DESIGN
        async function downloadReceiptPDF() {
            if (!window.currentReceiptData) {
                alert('No receipt data available');
                return;
            }

            try {
                // Use simple browser print function - most reliable method
                await generateSimplePDF();
                console.log('PDF generation initiated successfully');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generando PDF: ' + error.message);
                // Fallback: use simple canvas method to avoid all jsPDF errors
                try {
                    await generateSimplePDF();
                } catch (fallbackError) {
                    console.error('Fallback PDF generation also failed:', fallbackError);
                    alert('No se pudo generar el PDF. Por favor intente nuevamente.');
                }
            }
        }

        // Simple PDF generation using browser print
        async function generateSimplePDF() {
            const { receiptNumber } = window.currentReceiptData;
            const clientName = selectedAppointment.name;

            // Create a new window for printing
            const printWindow = window.open('', '_blank');

            // Get the receipt content
            const receiptContent = document.getElementById('receipt-preview-content');

            if (!receiptContent) {
                alert('No se pudo encontrar el contenido del recibo');
                return;
            }

            // Create the print document
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice_${receiptNumber}_${clientName.replace(/\s+/g, '_')}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 20mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            background: white;
                            font-family: 'Segoe UI', system-ui, sans-serif;
                            display: flex;
                            justify-content: center;
                            align-items: flex-start;
                            min-height: 100vh;
                        }
                        .receipt-container {
                            width: 400px;
                            max-width: 400px;
                            margin: 0 auto;
                            padding: 0;
                            background: white;
                            border: none;
                            box-sizing: border-box;
                        }
                        * {
                            box-shadow: none !important;
                            border-radius: inherit !important;
                        }
                        /* Ensure receipt content has no extra borders */
                        .receipt-container > * {
                            border: none !important;
                            box-shadow: none !important;
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        ${receiptContent.innerHTML}
                    </div>
                </body>
                </html>
            `);

            printWindow.document.close();

            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 1000);
        }

        // NEW: Generate PDF from HTML that preserves EXACT mobile design
        async function generateMobilePDFFromHTML() {
            if (typeof html2pdf === 'undefined') {
                throw new Error('html2pdf library not loaded');
            }

            // Get the receipt content element
            const receiptContent = document.getElementById('receipt-preview-content');
            if (!receiptContent) {
                throw new Error('Receipt content not found');
            }

            // Clone the element to avoid modifying the original
            const clonedContent = receiptContent.cloneNode(true);

            // Create a temporary container with mobile-optimized styling
            const tempContainer = document.createElement('div');
            tempContainer.style.cssText = `
                position: fixed;
                top: -9999px;
                left: -9999px;
                width: 400px;
                background: white;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                z-index: -1;
            `;

            // Ensure the cloned content maintains mobile design
            clonedContent.style.cssText = `
                max-width: 400px !important;
                width: 400px !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                border-radius: 12px !important;
                overflow: hidden !important;
                box-shadow: none !important;
            `;

            tempContainer.appendChild(clonedContent);
            document.body.appendChild(tempContainer);

            // Configure html2pdf options for mobile invoice - PRESERVES EXACT DESIGN
            const opt = {
                margin: [5, 5, 5, 5], // Minimal margins to preserve mobile design
                filename: `Mobile_Invoice_${window.currentReceiptData.receiptNumber}_${window.currentReceiptData.appointment.name.replace(/\s+/g, '_')}.pdf`,
                image: {
                    type: 'jpeg',
                    quality: 1.0 // Maximum quality
                },
                html2canvas: {
                    scale: 3, // Higher scale for crisp mobile design
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 400, // Exact mobile width
                    height: 800, // Fixed height to prevent NaN errors
                    scrollX: 0,
                    scrollY: 0,
                    letterRendering: true,
                    logging: false,
                    foreignObjectRendering: true
                },
                jsPDF: {
                    unit: 'mm',
                    format: [110, 'auto'], // Optimal mobile format width
                    orientation: 'portrait',
                    compress: false, // Don't compress to preserve quality
                    precision: 16
                }
            };

            try {
                // Generate PDF from HTML
                await html2pdf().set(opt).from(clonedContent).save();

                // Clean up
                document.body.removeChild(tempContainer);

                console.log('Mobile PDF generated successfully from HTML');
            } catch (error) {
                // Clean up on error
                if (document.body.contains(tempContainer)) {
                    document.body.removeChild(tempContainer);
                }
                throw error;
            }
        }

        // Generate Mobile-style PDF that matches the HTML preview design (FALLBACK)
        async function generateMobilePDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('PDF generator not loaded. Please refresh the page.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            // Get current receipt data
            const { receiptNumber, currentDate, totalAmount, services } = window.currentReceiptData;
            const clientName = selectedAppointment.name; // Client name without "Client" prefix
            const clientPhone = selectedAppointment.phone || 'N/A';

            // Mobile invoice colors
            const backgroundColor = [248, 249, 250];
            const primaryText = [33, 37, 41];
            const secondaryText = [108, 117, 125];
            const successGreen = [40, 167, 69];
            const borderColor = [233, 236, 239];

            // Page setup - mobile-friendly layout
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);

            // Background
            pdf.setFillColor(...backgroundColor);
            pdf.rect(0, 0, pageWidth, pageHeight, 'F');

            // Mobile Invoice Header Section
            pdf.setFillColor(248, 249, 250);
            pdf.rect(margin, margin, contentWidth, 80, 'F');

            // Invoice Number (top right)
            pdf.setTextColor(...secondaryText);
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            pdf.text(receiptNumber, pageWidth - margin, margin + 10, { align: 'right' });

            // Title - "Invoice"
            pdf.setTextColor(...primaryText);
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('Invoice', pageWidth / 2, margin + 25, { align: 'center' });

            // Client Name
            pdf.setTextColor(...primaryText);
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'normal');
            pdf.text(clientName, pageWidth / 2, margin + 40, { align: 'center' });

            // Total Amount (large, prominent)
            pdf.setTextColor(...successGreen);
            pdf.setFontSize(36);
            pdf.setFont(undefined, 'bold');
            pdf.text(`$${totalAmount.toFixed(0)}`, pageWidth / 2, margin + 60, { align: 'center' });

            // Paid Status with checkmark
            pdf.setFillColor(...successGreen);
            pdf.roundedRect(pageWidth / 2 - 20, margin + 70, 40, 12, 6, 6, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'bold');
            pdf.text('âœ“ Paid', pageWidth / 2, margin + 78, { align: 'center' });

            // Invoice Details Section
            let yPos = margin + 110;

            // Items count
            pdf.setTextColor(...secondaryText);
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const itemCount = services.length;
            pdf.text(`${itemCount} ${itemCount === 1 ? 'item' : 'items'}`, margin, yPos);
            yPos += 15;

            // Services List
            services.forEach((service, index) => {
                if (yPos > pageHeight - 50) {
                    pdf.addPage();
                    yPos = margin + 20;
                }

                // Service name
                pdf.setTextColor(...primaryText);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(service.service, margin, yPos);
                yPos += 8;

                // Service description using the same function as HTML
                pdf.setTextColor(...secondaryText);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                const description = getServiceDescription(service.service);
                const wrappedDescription = pdf.splitTextToSize(description, contentWidth - 20);
                pdf.text(wrappedDescription, margin, yPos);
                yPos += 5 * wrappedDescription.length;

                // Quantity and pricing
                pdf.setTextColor(...secondaryText);
                pdf.setFontSize(10);
                pdf.text(`${service.quantity} Ã— $${service.price.toFixed(2)} each`, margin, yPos);

                pdf.setTextColor(...primaryText);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(`$${service.total.toFixed(2)}`, pageWidth - margin, yPos, { align: 'right' });
                yPos += 15;

                // Border line (except for last item)
                if (index < services.length - 1) {
                    pdf.setDrawColor(...borderColor);
                    pdf.line(margin, yPos - 7, pageWidth - margin, yPos - 7);
                }
            });

            // Summary Section
            yPos += 10;
            pdf.setFillColor(...backgroundColor);
            pdf.rect(margin, yPos, contentWidth, 40, 'F');

            yPos += 12;

            // Subtotal
            pdf.setTextColor(...secondaryText);
            pdf.setFontSize(10);
            pdf.text('Subtotal', margin + 10, yPos);
            pdf.setTextColor(...primaryText);
            pdf.text(`$${totalAmount.toFixed(2)}`, pageWidth - margin - 10, yPos, { align: 'right' });
            yPos += 8;

            // Tax
            pdf.setTextColor(...secondaryText);
            pdf.text('Tax', margin + 10, yPos);
            pdf.setTextColor(...primaryText);
            pdf.text('$0.00', pageWidth - margin - 10, yPos, { align: 'right' });
            yPos += 8;

            // Total line
            pdf.setDrawColor(...borderColor);
            pdf.line(margin + 10, yPos, pageWidth - margin - 10, yPos);
            yPos += 8;

            // Total
            pdf.setTextColor(...primaryText);
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Total', margin + 10, yPos);
            pdf.text(`$${totalAmount.toFixed(2)}`, pageWidth - margin - 10, yPos, { align: 'right' });
            yPos += 8;

            // Paid amount in green
            pdf.setTextColor(...successGreen);
            pdf.setFont(undefined, 'bold');
            pdf.text('Paid', margin + 10, yPos);
            pdf.text(`$${totalAmount.toFixed(2)}`, pageWidth - margin - 10, yPos, { align: 'right' });

            // QR Code Section
            yPos += 25;

            // QR Code data and placeholder
            const qrData = `https://www.livingreen.life/`;
            pdf.setTextColor(...secondaryText);
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text('Visit our website', pageWidth / 2, yPos, { align: 'center' });

            // Simple QR code placeholder box
            pdf.setDrawColor(...borderColor);
            const qrSize = 25;
            const qrX = (pageWidth - qrSize) / 2;
            pdf.rect(qrX, yPos + 5, qrSize, qrSize, 'D');

            // QR data text
            pdf.setFontSize(8);
            pdf.text(qrData, pageWidth / 2, yPos + 35, { align: 'center' });

            // Business Info
            yPos += 50;
            pdf.setFillColor(...backgroundColor);
            pdf.rect(margin, yPos, contentWidth, 20, 'F');

            yPos += 12;
            pdf.setTextColor(...primaryText);
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('LivinGreen', pageWidth / 2, yPos, { align: 'center' });

            yPos += 8;
            pdf.setTextColor(...secondaryText);
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            pdf.text('Web: www.livingreen.life', pageWidth / 2, yPos, { align: 'center' });

            // Download the PDF
            const fileName = `Mobile_Invoice_${receiptNumber}_${clientName.replace(/\s+/g, '_')}.pdf`;
            pdf.save(fileName);
        }

        // Native Web Share API - Simple and universal
        async function shareReceipt() {
            if (!window.currentReceiptData) {
                alert('No receipt data available');
                return;
            }

            const { receiptNumber, totalAmount, appointment } = window.currentReceiptData;
            const firstName = appointment.name.split(' ')[0];

            // Create share content
            const shareTitle = `Factura ${receiptNumber} - LivinGreen`;
            const shareText = `Hola ${firstName}, su factura por $${totalAmount.toFixed(2)} estÃ¡ lista - LivinGreen`;
            const shareUrl = window.location.href; // Current page URL

            // Check if Web Share API is supported
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: shareTitle,
                        text: shareText,
                        url: shareUrl
                    });
                    console.log('âœ… Receipt shared successfully');
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('âŒ Error sharing:', error);
                        // Fallback to clipboard
                        fallbackToClipboard(shareText, shareUrl);
                    }
                }
            } else {
                // Fallback for browsers without Web Share API
                fallbackToClipboard(shareText, shareUrl);
            }
        }

        // Fallback: Copy to clipboard
        function fallbackToClipboard(text, url) {
            const fullText = `${text}\n${url}`;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullText).then(() => {
                    alert('ðŸ“‹ Recibo copiado al portapapeles. PÃ©galo en WhatsApp, SMS, o donde quieras compartirlo.');
                }).catch(() => {
                    showManualCopy(fullText);
                });
            } else {
                showManualCopy(fullText);
            }
        }

        // Manual copy fallback
        function showManualCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('ðŸ“‹ Recibo copiado al portapapeles. PÃ©galo en WhatsApp, SMS, o donde quieras compartirlo.');
            } catch (err) {
                prompt('ðŸ“‹ Copia este texto y compÃ¡rtelo:', text);
            }
            document.body.removeChild(textarea);
        }

        // OLD SMS function - keeping for reference
        async function shareReceiptViaSMS() {
            if (!window.currentReceiptData) {
                alert('No receipt data available');
                return;
            }

            const { receiptNumber, totalAmount, appointment } = window.currentReceiptData;

            console.log('Appointment data for SMS:', appointment);
            console.log('Phone number:', appointment.phone);

            try {
                // Store receipt on server and get short URL
                const storedReceipt = await storeReceiptForSharing();

                if (storedReceipt && storedReceipt.shortUrl) {
                    // Create professional SMS message (optimized for SMS length)
                    const firstName = appointment.name.split(' ')[0];
                    const message = `Hola ${firstName}, su factura por $${totalAmount.toFixed(2)} estÃ¡ lista. Ver/Descargar: ${storedReceipt.shortUrl} - LivinGreen`;

                    // Open SMS app
                    openSMSApp(appointment.phone, message);
                } else {
                    throw new Error('Failed to create short URL');
                }
            } catch (error) {
                console.error('Error sharing receipt via SMS:', error);
                alert('Error al compartir recibo. Por favor intenta nuevamente.');
            }
        }

        // Store receipt on server and get short URL
        async function storeReceiptForSharing() {
            const { receiptNumber, totalAmount, services, appointment } = window.currentReceiptData;

            // Generate receipt text for storage
            const receiptText = generateReceiptTextForStorage(receiptNumber, totalAmount, services, appointment);

            // Debug: log the receipt text and data
            console.log('ðŸ“ Receipt text generated:', receiptText);
            console.log('ðŸ“ Receipt text length:', receiptText?.length);
            console.log('ðŸ“ Original receiptNumber:', receiptNumber);
            console.log('ðŸ“ Cleaned receiptNumber:', receiptNumber.replace(/[^a-zA-Z0-9]/g, ''));
            console.log('ðŸ“ Services data:', services);
            console.log('ðŸ“ Appointment data:', appointment);

            // Validate required data
            if (!receiptText || receiptText.length < 10) {
                console.error('âŒ Invalid receipt data generated:', receiptText);
                throw new Error('Could not generate valid receipt data');
            }

            try {
                // Check if API is available (not running from file system)
                if (!API_BASE_URL) {
                    console.log('Running from file system, using fallback URL');
                    return createFallbackShortUrl();
                }

                // Prepare data for server
                const requestData = {
                    receiptData: receiptText,
                    receiptNumber: receiptNumber.replace(/[^a-zA-Z0-9]/g, ''),
                    clientName: appointment.name || 'Cliente',
                    appointmentData: {
                        appointmentDate: appointment.date || new Date().toISOString().split('T')[0],
                        serviceType: services.map(s => s.service).join(', '),
                        appointmentId: appointment.id ? `APPT_${appointment.id}_${Date.now().toString(16).toUpperCase()}` : undefined,
                        clientPhone: appointment.phone || '0000000000',
                        totalAmount: totalAmount
                    }
                };

                // Debug: log what we're sending
                console.log('ðŸš€ Sending to server:', JSON.stringify(requestData, null, 2));

                // Store receipt on server
                const response = await fetch(`${API_BASE_URL}/receipt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`âŒ Server error ${response.status}:`, errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('âœ… Receipt stored successfully:', result);
                return result;

            } catch (error) {
                console.error('âŒ Error storing receipt:', error);
                console.log('ðŸ”„ Using fallback storage method...');
                // Fallback to local storage with direct netlify URL
                return createFallbackShortUrl();
            }
        }

        // Generate receipt text for server storage
        function generateReceiptTextForStorage(receiptNumber, totalAmount, services, appointment) {
            let receiptText = `ðŸŒ¿ LivinGreen\n`;
            receiptText += `=====================================\n\n`;
            receiptText += `FACTURA #${receiptNumber}\n`;
            receiptText += `Fecha: ${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}\n`;
            receiptText += `Total: $${totalAmount.toFixed(2)}\n\n`;

            receiptText += `FACTURAR A:\n`;
            receiptText += `${appointment.name}\n`;
            if (appointment.address) {
                receiptText += `${appointment.address}\n`;
            }
            if (appointment.city) {
                receiptText += `${appointment.city}\n`;
            }
            receiptText += `\n`;

            receiptText += `SERVICIOS:\n`;
            receiptText += `-------------------------------------\n`;

            services.forEach(service => {
                receiptText += `${service.service}\n`;
                receiptText += `Cantidad: ${service.quantity} x $${service.price.toFixed(2)} = $${service.total.toFixed(2)}\n\n`;
            });

            receiptText += `-------------------------------------\n`;
            receiptText += `TOTAL: $${totalAmount.toFixed(2)}\n\n`;
            receiptText += `Gracias por elegir LivinGreen!\n`;
            receiptText += `Â¡Su satisfacciÃ³n es nuestra prioridad!`;

            return receiptText;
        }

        // Fallback short URL creation for local testing
        function createFallbackShortUrl() {
            const shortId = Math.random().toString(36).substr(2, 6).toUpperCase();
            const { receiptNumber, totalAmount, services, appointment } = window.currentReceiptData;

            // Store locally for fallback
            const receiptData = {
                id: shortId,
                receiptNumber,
                clientName: appointment.name,
                clientPhone: appointment.phone,
                services,
                totalAmount,
                date: new Date().toISOString(),
                address: appointment.address || '',
                city: appointment.city || '',
                appointmentDate: appointment.date || new Date().toISOString().split('T')[0],
                appointmentTime: appointment.time || ''
            };

            localStorage.setItem(`receipt_${shortId}`, JSON.stringify(receiptData));

            const shortUrl = `https://incandescent-sprinkles-d1c3df.netlify.app/r/${shortId}`;

            return {
                success: true,
                shortUrl: shortUrl,
                receiptId: shortId
            };
        }

        // Open SMS app with message
        function openSMSApp(phoneNumber, message) {
            // Clean phone number
            const cleanPhone = phoneNumber ? phoneNumber.replace(/[^\d+]/g, '') : '';

            if (!cleanPhone) {
                // If no phone number, just copy message to clipboard
                copyToClipboard(message);
                alert('Mensaje copiado al portapapeles. Puede enviarlo manualmente:\n\n' + message);
                return;
            }

            // Create SMS URL
            let smsUrl;
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                smsUrl = `sms:${cleanPhone}&body=${encodeURIComponent(message)}`;
            } else {
                smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(message)}`;
            }

            console.log('Opening SMS with URL:', smsUrl);
            console.log('Message:', message);

            try {
                // Try to open SMS app
                window.open(smsUrl, '_blank');

                // Show success message
                alert('SMS abierto! Revisa tu app de mensajes.');

                // Close the receipt preview modal
                closeReceiptPreview();

            } catch (error) {
                console.error('SMS open error:', error);
                // Fallback: copy to clipboard
                copyToClipboard(message);
                alert(`No se pudo abrir SMS automÃ¡ticamente. Mensaje copiado al portapapeles:\n\n${message}\n\nEnvÃ­elo a: ${cleanPhone}`);
            }
        }

        // Helper function to copy text to clipboard
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).catch(err => {
                    console.error('Failed to copy to clipboard:', err);
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }
        
        // Generate and send via WhatsApp
        async function generateAndSendWhatsApp() {
            const phoneNumber = document.getElementById('phone-number').value.trim();
            if (!phoneNumber) {
                alert('Please enter a phone number');
                return;
            }
            if (receiptServices.length === 0) {
                alert('Please add at least one service');
                return;
            }
            await generatePDF('whatsapp', phoneNumber);
        }
        
        // Send SMS directly with Netlify URL (no server needed)
        async function generateAndSendSMS() {
            console.log('SMS button clicked');
            
            const phoneNumber = document.getElementById('phone-number').value.trim();
            if (!phoneNumber) {
                alert('Please enter a phone number');
                return;
            }
            
            // Clean phone number - remove all non-digits except +
            const cleanPhone = phoneNumber.replace(/[^\d+]/g, '');
            console.log('Clean phone number:', cleanPhone);
            
            if (receiptServices.length === 0) {
                alert('Please add at least one service');
                return;
            }
            
            // Get appointment data
            if (!selectedAppointment) {
                alert('Please select an appointment first');
                return;
            }
            
            // Calculate total
            const totalAmount = receiptServices.reduce((sum, service) => sum + service.total, 0);
            const receiptNumber = generateRealisticInvoiceNumber();
            
            // Create receipt data identical to PDF generation
            const receiptData = {
                receiptNumber: receiptNumber,
                clientName: selectedAppointment.name,
                clientPhone: cleanPhone,
                services: receiptServices,
                totalAmount: totalAmount,
                date: new Date().toISOString(),
                address: selectedAppointment.address || '',
                city: selectedAppointment.city || '',
                appointmentDate: selectedAppointment.date || new Date().toISOString().split('T')[0],
                appointmentTime: selectedAppointment.time || ''
            };
            
            // Generate a unique receipt ID (UUID-like)
            const receiptId = 'R' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            
            // Store receipt data with the unique ID (expert solution: use IndexedDB for cross-device persistence)
            const receiptForStorage = {
                id: receiptId,
                ...receiptData,
                autoGenerate: true, // Flag to auto-generate PDF when opened
                createdAt: Date.now()
            };
            
            // Store in localStorage as backup, but also try to store server-side
            localStorage.setItem(`receipt_${receiptId}`, JSON.stringify(receiptForStorage));
            
            // Server storage disabled for local testing (avoiding CORS errors)
            console.log('Using localStorage storage for local testing');
            
            // ULTRA-SHORT SOLUTION: 6-character ID with server storage
            const shortId = Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Store receipt data with ultra-short ID
            const receiptStorageData = {
                id: shortId,
                receiptNumber: receiptNumber,
                clientName: selectedAppointment.name,
                clientPhone: cleanPhone,
                services: receiptServices,
                totalAmount: totalAmount,
                date: new Date().toISOString(),
                address: selectedAppointment.address || '',
                city: selectedAppointment.city || '',
                appointmentDate: selectedAppointment.date || new Date().toISOString().split('T')[0],
                appointmentTime: selectedAppointment.time || ''
            };
            
            // Store both locally AND on server for maximum reliability
            localStorage.setItem(`receipt_${shortId}`, JSON.stringify(receiptStorageData));
            
            // Server storage disabled for local testing (avoiding CORS errors)
            console.log('Receipt stored locally with ID:', shortId);
            
            // Create SHORT URL: funciona inmediatamente sin configurar bit.ly
            const shortUrl = `https://incandescent-sprinkles-d1c3df.netlify.app/r/${shortId}`;
            console.log('ULTRA-SHORT URL created:', shortUrl, '(', shortUrl.length, 'characters)');
            
            console.log('=== SMS URL DEBUG ===');
            console.log('Receipt ID:', receiptId);
            console.log('Short URL:', shortUrl);
            console.log('URL Length:', shortUrl.length, 'characters');
            console.log('Receipt data stored with key:', `receipt_${receiptId}`);
            console.log('Receipt data:', receiptForStorage);
            console.log('==================');
            
            // Create complete professional SMS message (optimized for SMS length)
            const firstName = selectedAppointment.name.split(' ')[0]; // Solo primer nombre
            const message = `Hola ${firstName}, su factura por $${totalAmount.toFixed(2)} estÃ¡ lista. Ver/Descargar: ${shortUrl} - LivinGreen`;
            
            // Try different SMS formats for better compatibility
            let smsUrl;
            
            // Format 1: Standard SMS format
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // iOS format
                smsUrl = `sms:${cleanPhone}&body=${encodeURIComponent(message)}`;
            } else {
                // Android format
                smsUrl = `sms:${cleanPhone}?body=${encodeURIComponent(message)}`;
            }
            
            console.log('SMS URL:', smsUrl);
            console.log('Message:', message);
            console.log('Message length:', message.length);
            
            // Enhanced SMS opening with better compatibility
            try {
                console.log('Attempting to open SMS with URL:', smsUrl);
                console.log('Message length:', message.length, 'characters');

                // Method 1: Use the unified openSMSApp function for better compatibility
                openSMSApp(cleanPhone, message);

                // Show success message after a brief delay
                setTimeout(() => {
                    alert('SMS preparado! Revise su aplicaciÃ³n de mensajes y envÃ­e cuando estÃ© listo.');
                }, 500);
                
            } catch (error) {
                console.error('SMS open error:', error);
                // Fallback: Show the message to copy manually
                alert(`SMS no se pudo abrir automÃ¡ticamente. Copie este mensaje:\n\n${message}\n\nY envÃ­elo a: ${cleanPhone}`);
            }
        }
        
        // Function to shorten URL using Bitly
        async function shortenUrlWithBitly(longUrl) {
            try {
                // Using a free URL shortening service (tinyurl.com API)
                const response = await fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(longUrl));
                const shortUrl = await response.text();
                
                if (shortUrl && shortUrl.startsWith('https://tinyurl.com/')) {
                    console.log('URL shortened successfully:', shortUrl);
                    return shortUrl;
                }
                
                console.log('URL shortening failed, using original URL');
                return longUrl;
                
            } catch (error) {
                console.error('URL shortening error:', error);
                return longUrl; // Fallback to original URL
            }
        }

        // Generate PDF from receipt data using HTML-to-PDF (PRESERVES DESIGN)
        async function generatePDFFromDataHTML(data) {
            try {
                // First, create the receipt display
                displayReceiptPage(data);

                // Wait for the page to render
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Find the receipt container in the displayed page
                const receiptContainer = document.querySelector('.receipt-container') ||
                                       document.querySelector('[style*="max-width: 400px"]') ||
                                       document.body.children[0];

                if (!receiptContainer) {
                    throw new Error('Receipt container not found in the page');
                }

                // Ensure mobile design preservation
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = `
                    position: fixed;
                    top: -9999px;
                    left: -9999px;
                    width: 400px;
                    background: white;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    z-index: -1;
                `;

                const clonedReceipt = receiptContainer.cloneNode(true);
                clonedReceipt.style.cssText = `
                    max-width: 400px !important;
                    width: 400px !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    background: white !important;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                `;

                tempContainer.appendChild(clonedReceipt);
                document.body.appendChild(tempContainer);

                // Configure html2pdf options - PRESERVES EXACT MOBILE DESIGN
                const opt = {
                    margin: [5, 5, 5, 5], // Minimal margins to preserve mobile design
                    filename: `Mobile_Invoice_${data.receiptNumber}_${data.clientName.replace(/\s+/g, '_')}.pdf`,
                    image: {
                        type: 'jpeg',
                        quality: 1.0 // Maximum quality
                    },
                    html2canvas: {
                        scale: 3, // Higher scale for crisp mobile design
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        width: 400, // Exact mobile width
                        height: 800, // Fixed height to prevent NaN errors
                        letterRendering: true,
                        logging: false,
                        foreignObjectRendering: true
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: [110, 'auto'], // Optimal mobile format width
                        orientation: 'portrait',
                        compress: false, // Don't compress to preserve quality
                        precision: 16
                    }
                };

                // Generate PDF
                await html2pdf().set(opt).from(clonedReceipt).save();

                // Clean up
                document.body.removeChild(tempContainer);

                console.log('Mobile PDF generated successfully from receipt data');
            } catch (error) {
                console.error('HTML-to-PDF generation failed:', error);
                // Fallback to original method
                await generatePDFFromData(data);
            }
        }

        // Generate PDF from receipt data (expert solution) - FALLBACK
        async function generatePDFFromData(data) {
            try {
                if (typeof window.jspdf === 'undefined') {
                    alert('PDF generator not loaded. Please refresh the page.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                // Use the same PDF generation logic as the main generatePDF function
                // but with the data from the URL
                
                const receiptNumber = data.receiptNumber;
                const totalAmount = data.totalAmount;
                const services = data.services || [];
                const clientName = data.clientName;
                const clientPhone = data.clientPhone;
                
                // Colors exactly matching the template
                const blueColor = [0, 191, 255];
                const darkGray = [68, 68, 68];
                const lightGray = [240, 240, 240];
                
                // Create diagonal effect with polygons (same as original)
                pdf.setFillColor(...darkGray);
                pdf.triangle(0, 0, 115, 0, 0, 80, 'F');
                pdf.triangle(115, 0, 135, 80, 0, 80, 'F');
                
                pdf.setFillColor(...blueColor);
                pdf.triangle(115, 0, 210, 0, 135, 80, 'F');
                pdf.triangle(210, 0, 210, 80, 135, 80, 'F');
                
                pdf.setFillColor(255, 255, 255);
                pdf.triangle(115, 0, 135, 0, 135, 80, 'F');
                pdf.triangle(115, 0, 115, 80, 135, 80, 'F');
                
                // Add content (simplified version of the original)
                pdf.setTextColor(0, 191, 255);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('ðŸ§½ RIZE PROFESSIONAL', 10, 25);
                pdf.text('CLEANING', 10, 35);
                
                pdf.setTextColor(68, 68, 68);
                pdf.setFontSize(32);
                pdf.text('INVOICE', 145, 35);
                
                pdf.setFontSize(9);
                pdf.text(`Invoice No   :  ${receiptNumber}`, 145, 48);
                pdf.text(`Issue Date   :  ${new Date(data.date).toLocaleDateString('es-ES')}`, 145, 54);
                
                // Client info
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('BILL TO', 15, 95);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text(clientName.toUpperCase(), 15, 105);
                pdf.text('ðŸ“ž ' + clientPhone, 15, 112);
                
                // Services
                let yPos = 140;
                services.forEach((service, index) => {
                    pdf.text(service.service || service.n, 42, yPos + 6);
                    pdf.text(`$${(service.total || service.p).toFixed(2)}`, 175, yPos + 6);
                    yPos += 10;
                });
                
                // Total
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text(`TOTAL: $${totalAmount.toFixed(2)}`, 15, yPos + 30);
                
                // Download the PDF
                pdf.save(`Recibo_${receiptNumber}_${clientName.replace(/\s+/g, '_')}.pdf`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generando PDF: ' + error.message);
            }
        }

        // Generate realistic invoice numbers
        function generateRealisticInvoiceNumber() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1; // 0-based, so add 1
            
            // Get or initialize invoice counter for this year and month
            const storageKey = `invoiceCounter_${currentYear}_${currentMonth}`;
            let invoiceCounter = parseInt(localStorage.getItem(storageKey)) || 0;
            
            // Increment counter
            invoiceCounter++;
            localStorage.setItem(storageKey, invoiceCounter.toString());
            
            // Format: RIZE-YYMM-XXX (e.g., RIZE-2501-001, RIZE-2501-002, etc.)
            const yearShort = currentYear.toString().slice(-2); // Last 2 digits of year
            const monthPadded = currentMonth.toString().padStart(2, '0');
            const counterPadded = invoiceCounter.toString().padStart(3, '0');
            
            return `RIZE-${yearShort}${monthPadded}-${counterPadded}`;
        }

        // Save contact to phone and update customer record
        async function saveContactAndScheduleReminder(phoneNumber) {
            if (!phoneNumber || !selectedAppointment) return;
            
            try {
                console.log('ðŸ“ž Saving contact and scheduling reminder for:', selectedAppointment.name);
                
                // 1. Save contact to phone using Web API (if supported)
                await saveContactToPhone(phoneNumber, selectedAppointment.name);
                
                // 2. Update customer record with phone number
                await updateCustomerPhone(selectedAppointment.id, phoneNumber);
                
                // 3. Schedule 6-month reminder
                await scheduleFollowUpReminder(phoneNumber, selectedAppointment.name);
                
                console.log('âœ… Contact saved and reminder scheduled successfully');
                
            } catch (error) {
                console.error('âŒ Error saving contact or scheduling reminder:', error);
            }
        }
        
        // Save contact to phone contacts (multiple methods)
        async function saveContactToPhone(phoneNumber, clientName) {
            try {
                console.log('ðŸ“± Saving contact for:', clientName);
                
                // Method 1: Direct SMS to yourself with contact info
                const contactSMS = `New RIZE Client Contact:\n\nName: ${clientName} (RIZE Client)\nPhone: ${phoneNumber}\nService Date: ${new Date().toLocaleDateString()}\n\nSave this contact for 6-month follow-up! ðŸ“±`;
                const selfSMSUrl = `sms:?body=${encodeURIComponent(contactSMS)}`;
                
                // Method 2: Create easy-tap phone link
                const phoneLink = `tel:${phoneNumber}`;
                
                // Method 3: Still create vCard as backup
                const vCard = `BEGIN:VCARD
VERSION:3.0
FN:${clientName} (RIZE Client)
TEL:${phoneNumber}
ORG:RIZE Professional Cleaning Client
NOTE:Carpet/Upholstery cleaning client. Last service: ${new Date().toLocaleDateString()}
END:VCARD`;
                
                // Show options to user
                const userChoice = confirm(`ðŸ’¡ EASY CONTACT SAVING OPTIONS:\n\nâœ… Option 1 (RECOMMENDED): Send yourself an SMS with contact info - just save from SMS\nâŒ Option 2: Download vCard file (manual)\n\nChoose Option 1 (SMS)?`);
                
                if (userChoice) {
                    // Open SMS app with contact info
                    window.open(selfSMSUrl);
                    
                    setTimeout(() => {
                        alert(`ðŸ“± SMS opened with contact info!\n\nSteps:\n1. Send the SMS to yourself\n2. When you receive it, tap the phone number\n3. Choose "Add to Contacts"\n\nMuch easier! ðŸŽ‰`);
                    }, 1000);
                    
                } else {
                    // Fallback to vCard download
                    const blob = new Blob([vCard], { type: 'text/vcard' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${clientName.replace(/\s+/g, '_')}_RIZE_Contact.vcf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('ðŸ“± vCard downloaded! Go to Downloads â†’ tap .vcf file â†’ Add Contact');
                }
                
                console.log('ðŸ“± Contact saving method executed for:', clientName);
                
            } catch (error) {
                console.error('âŒ Error creating contact:', error);
            }
        }
        
        // Update customer record with phone number
        async function updateCustomerPhone(appointmentId, phoneNumber) {
            try {
                console.log('ðŸ“ž updateCustomerPhone called with:', appointmentId, phoneNumber);

                // Save phone number using PhoneManager (always works)
                PhoneManager.save(appointmentId, phoneNumber);

                // Also try to update the appointment for Supabase sync
                const appointments = await OfflineDB.getAppointments();
                const appointmentToUpdate = appointments.find(apt => apt.id === appointmentId);

                if (appointmentToUpdate) {
                    appointmentToUpdate.phone = phoneNumber;
                    console.log('ðŸ“ž Saving appointment with phone for sync:', appointmentToUpdate);
                    await OfflineDB.saveAppointment(appointmentToUpdate);
                }

                // Also update the current selectedAppointment object
                if (selectedAppointment && selectedAppointment.id === appointmentId) {
                    selectedAppointment.phone = phoneNumber;
                }

                console.log('ðŸ“Š Customer phone updated:', phoneNumber);

                // Always refresh client registry after phone update to ensure data consistency
                console.log('ðŸ”„ Refreshing client registry with updated phone...');

                // Verify the save was successful
                console.log('ðŸ“ž Starting verification - recentOfflineSave flag:', recentOfflineSave);
                const verifyAppointments = await OfflineDB.getAppointments();
                console.log('ðŸ“ž Verification - all appointments:', verifyAppointments.map(a => ({id: a.id, name: a.name, phone: a.phone})));
                const verifyUpdated = verifyAppointments.find(apt => apt.id === appointmentId);
                console.log('ðŸ“ž Verification - saved appointment phone:', verifyUpdated?.phone);

                // Small delay to ensure the save operation completes
                setTimeout(async () => {
                    console.log('ðŸ“ž Refreshing client registry after phone update...');
                    await loadClientRegistry();
                }, 200);

            } catch (error) {
                console.error('âŒ Error updating customer phone:', error);
            }
        }
        
        // Removed: reminder scheduling function
        
        // Removed: reminder checking and follow-up functions
        
        // TEST FUNCTIONS - Remove in production
        
        // Test contact saving (call from browser console)
        window.testContactSaving = function() {
            if (!selectedAppointment) {
                alert('Please select an appointment first by clicking on a calendar appointment');
                return;
            }
            
            const testPhone = prompt('Enter a test phone number (e.g., 8015551234):');
            if (testPhone) {
                saveContactToPhone(testPhone, selectedAppointment.name);
                alert('âœ… Contact vCard file should have been downloaded! Check your Downloads folder and tap the .vcf file to add to contacts.');
            }
        };
        
        // Removed: all reminder testing functions

        // Generate receipt text for backend storage
        function generateReceiptText() {
            const receiptNumber = generateRealisticInvoiceNumber();
            const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            const totalAmount = receiptServices.reduce((sum, service) => sum + service.total, 0);

            let receiptText = `ðŸŒ¿ LivinGreen\n`;
            receiptText += `=====================================\n\n`;
            receiptText += `FACTURA #${receiptNumber}\n`;
            receiptText += `Fecha: ${currentDate}\n`;
            receiptText += `Total: $${totalAmount.toFixed(2)}\n\n`;

            receiptText += `FACTURAR A:\n`;
            receiptText += `${selectedAppointment.name}\n`;
            if (selectedAppointment.address) {
                receiptText += `${selectedAppointment.address}\n`;
            }
            receiptText += `\n`;

            receiptText += `SERVICIOS:\n`;
            receiptText += `-------------------------------------\n`;

            receiptServices.forEach(service => {
                receiptText += `${service.service}\n`;
                receiptText += `Cantidad: ${service.quantity} x $${service.price.toFixed(2)} = $${service.total.toFixed(2)}\n\n`;
            });

            receiptText += `-------------------------------------\n`;
            receiptText += `TOTAL: $${totalAmount.toFixed(2)}\n\n`;
            receiptText += `Gracias por elegir LivinGreen!\n`;
            receiptText += `Â¡Su satisfacciÃ³n es nuestra prioridad!`;

            return receiptText;
        }

        // Update client display with new phone number
        function updateClientDisplayWithPhone(phoneNumber) {
            // Update the receipt modal client info display
            const clientPhoneElements = document.querySelectorAll('[style*="color: #6b7280"][style*="font-size: 12px"]');
            clientPhoneElements.forEach(element => {
                if (element.textContent === 'N/A' || element.textContent.includes('N/A')) {
                    element.textContent = phoneNumber;
                }
            });

            // Update any appointment display that shows phone
            const appointmentCards = document.querySelectorAll('.appointment-card, [class*="appointment"]');
            appointmentCards.forEach(card => {
                const phoneSpan = card.querySelector('[data-field="phone"], .phone-display');
                if (phoneSpan) {
                    phoneSpan.textContent = phoneNumber;
                }
            });

            console.log('ðŸ“± UI updated with new phone number:', phoneNumber);
        }

        // Main PDF generation function
        async function generatePDF(sendMethod = null, phoneNumber = null) {
            try {
                // 1. Get phone number from input field
                const phoneInput = document.getElementById('phone-number');
                const inputPhoneNumber = phoneInput ? phoneInput.value.trim() : '';

                // 2. Save phone number to customer record if provided
                if (inputPhoneNumber && selectedAppointment && selectedAppointment.id) {
                    try {
                        console.log('ðŸ’¾ Saving phone number to customer record...');
                        await updateCustomerPhone(selectedAppointment.id, inputPhoneNumber);

                        // Update the selectedAppointment object immediately
                        selectedAppointment.phone = inputPhoneNumber;

                        console.log('âœ… Phone number saved successfully:', inputPhoneNumber);

                        // 3. Update the UI to show the new phone number
                        updateClientDisplayWithPhone(inputPhoneNumber);

                    } catch (error) {
                        console.error('âŒ Error saving phone number:', error);
                        // Continue with PDF generation even if phone save fails
                    }
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();

                // Receipt data
                const receiptNumber = generateRealisticInvoiceNumber();
                const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                const totalAmount = receiptServices.reduce((sum, service) => sum + service.total, 0);
                
                // Colors exactly matching the template
                const blueColor = [0, 191, 255]; // Bright blue from template
                const darkGray = [68, 68, 68];   // Dark gray from template  
                const lightGray = [240, 240, 240]; // Light gray for rows
                
                // Create diagonal effect with polygons
                // Dark gray left section
                pdf.setFillColor(...darkGray);
                const leftPoints = [[0, 0], [115, 0], [135, 80], [0, 80]]; // Diagonal cut
                pdf.triangle(0, 0, 115, 0, 0, 80, 'F');
                pdf.triangle(115, 0, 135, 80, 0, 80, 'F');
                
                // Blue right section  
                pdf.setFillColor(...blueColor);
                const rightPoints = [[115, 0], [210, 0], [210, 80], [135, 80]]; // Diagonal cut
                pdf.triangle(115, 0, 210, 0, 135, 80, 'F');
                pdf.triangle(210, 0, 210, 80, 135, 80, 'F');
                
                // White diagonal stripe
                pdf.setFillColor(255, 255, 255);
                pdf.triangle(115, 0, 135, 0, 135, 80, 'F');
                pdf.triangle(115, 0, 115, 80, 135, 80, 'F');
                
                // Brand logo and company info in dark section
                pdf.setTextColor(0, 191, 255); // Blue text for logo
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('ðŸ§½ RIZE PROFESSIONAL', 10, 25);
                pdf.text('CLEANING', 10, 35);
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                pdf.text('Professional Cleaning Services', 10, 45);
                pdf.text('ðŸ“ž (801) 739-0700', 10, 52);
                pdf.text('ðŸ“§ info@rizecleaning.com', 10, 58);
                pdf.text('ðŸŒ www.rizecleaning.com', 10, 64);
                pdf.text('ðŸ“ 1128 S 820 E Apt 2304, Heber City, Utah', 10, 70);
                
                // INVOICE title in blue section (large, dark text)
                pdf.setTextColor(68, 68, 68); // Dark gray text on blue background
                pdf.setFontSize(32);
                pdf.setFont(undefined, 'bold');
                pdf.text('INVOICE', 145, 35);
                
                // Invoice details in blue section
                pdf.setTextColor(68, 68, 68);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Invoice No   :  ${receiptNumber}`, 145, 48);
                pdf.text(`Issue Date   :  ${new Date().toLocaleDateString('es-ES')}`, 145, 54);
                pdf.text(`Account No   :  RIZE-${new Date().getFullYear()}`, 145, 60);
                
                // DUES amount box (dark background)
                pdf.setFillColor(...darkGray);
                pdf.rect(145, 65, 55, 12, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('DUES :', 148, 73);
                pdf.text(`$${totalAmount.toFixed(2)}`, 175, 73);
                
                // BILL TO section
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('BILL TO', 15, 95);
                
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text(selectedAppointment.name.toUpperCase(), 15, 105);
                pdf.text('ðŸ“ž ' + (selectedAppointment.phone || phoneNumber || 'N/A'), 15, 112);
                if (selectedAppointment.address) {
                    pdf.text('ðŸ“ ' + selectedAppointment.address, 15, 119);
                }
                if (selectedAppointment.city) {
                    pdf.text(selectedAppointment.city, 15, 126);
                }

                // Add appointment date and time
                let appointmentYPos = 126;
                if (selectedAppointment.date && selectedAppointment.time) {
                    appointmentYPos += 7;
                    const appointmentDate = new Date(selectedAppointment.date).toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    pdf.setTextColor(68, 68, 68);
                    pdf.text(`ðŸ“… Appointment: ${appointmentDate} at ${selectedAppointment.time}`, 15, appointmentYPos);
                }

                // Services table header (exactly like template)
                let yPos = 145;
                
                // Table header row with exact colors from template
                pdf.setFillColor(...lightGray);
                pdf.rect(15, yPos, 25, 10, 'F'); // No. - light gray
                
                pdf.setFillColor(...blueColor);
                pdf.rect(40, yPos, 70, 10, 'F'); // Item Description - blue
                
                pdf.setFillColor(...darkGray);
                pdf.rect(110, yPos, 30, 10, 'F'); // Unit Price - dark gray
                
                pdf.setFillColor(...lightGray);
                pdf.rect(140, yPos, 25, 10, 'F'); // Quantity - light gray
                
                pdf.setFillColor(...darkGray);
                pdf.rect(165, yPos, 30, 10, 'F'); // Value - dark gray
                
                // Table headers text with exact positioning
                pdf.setTextColor(68, 68, 68);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'bold');
                pdf.text('No.', 24, yPos + 6);
                
                pdf.setTextColor(255, 255, 255);
                pdf.text('Item Description', 58, yPos + 6);
                pdf.text('Unit Price', 118, yPos + 6);
                
                pdf.setTextColor(68, 68, 68);
                pdf.text('Quantity', 147, yPos + 6);
                
                pdf.setTextColor(255, 255, 255);
                pdf.text('Value', 175, yPos + 6);
                
                // Services rows with alternating colors (exactly like template)
                yPos += 10;
                pdf.setFont(undefined, 'normal');
                receiptServices.forEach((service, index) => {
                    const rowHeight = 10;
                    
                    // Alternating row background (white/light gray)
                    if (index % 2 === 1) {
                        pdf.setFillColor(248, 248, 248);
                        pdf.rect(15, yPos, 180, rowHeight, 'F');
                    }
                    
                    pdf.setTextColor(68, 68, 68);
                    pdf.text(String(index + 1).padStart(2, '0'), 24, yPos + 6);
                    pdf.text(service.service, 42, yPos + 6);
                    pdf.text(`$${service.total.toFixed(2)}`, 120, yPos + 6);
                    pdf.text('1', 150, yPos + 6);
                    pdf.text(`$${service.total.toFixed(2)}`, 175, yPos + 6);
                    yPos += rowHeight;
                });
                
                // Payment methods section (left side, like template)
                yPos += 15;
                pdf.setTextColor(...blueColor);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Payment Method We Accept', 15, yPos);
                
                pdf.setTextColor(68, 68, 68);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text('Cash, Check, Credit Card, Zelle', 15, yPos + 7);
                pdf.text('PayPal, Venmo, Apple Pay', 15, yPos + 14);
                
                yPos += 25;
                pdf.setTextColor(...blueColor);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Card Payment', 15, yPos);
                
                pdf.setTextColor(68, 68, 68);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text('We accept all major credit cards', 15, yPos + 7);
                pdf.text('Visa, MasterCard, American Express', 15, yPos + 14);
                
                yPos += 25;
                pdf.setTextColor(...blueColor);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Terms & Condition', 15, yPos);
                
                pdf.setTextColor(68, 68, 68);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text('Payment due within 30 days', 15, yPos + 7);
                pdf.text('Late fees may apply after due date', 15, yPos + 14);
                
                // Right side totals (exactly like template)
                let totalYPos = yPos - 65;
                
                pdf.setTextColor(68, 68, 68);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                
                // SUB TOTAL
                pdf.text('SUB TOTAL', 120, totalYPos);
                pdf.text(`$${totalAmount.toFixed(2)}`, 165, totalYPos);
                totalYPos += 12;
                
                // TAX, VAT
                pdf.text('TAX, VAT', 120, totalYPos);
                pdf.text('$0.00', 165, totalYPos);
                totalYPos += 12;
                
                // DISCOUNT
                pdf.text('DISCOUNT', 120, totalYPos);
                pdf.text('$0.00', 165, totalYPos);
                totalYPos += 12;
                
                // GRAND TOTAL (dark background, like template)
                pdf.setFillColor(...darkGray);
                pdf.rect(115, totalYPos - 3, 80, 12, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('GRAND TOTAL', 120, totalYPos + 3);
                pdf.text(`$${totalAmount.toFixed(2)}`, 165, totalYPos + 3);
                
                // Signature section (exactly positioned like template)
                pdf.setTextColor(68, 68, 68);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text('...................................', 145, totalYPos + 20);
                pdf.text('Signature', 160, totalYPos + 25);
                
                // Footer with diagonal design (exactly like template)
                const footerY = 250;
                
                // Blue diagonal footer
                pdf.setFillColor(...blueColor);
                pdf.triangle(0, footerY, 170, footerY, 0, 297, 'F');
                pdf.triangle(170, footerY, 210, 297, 0, 297, 'F');
                
                // Dark gray diagonal footer
                pdf.setFillColor(...darkGray);
                pdf.triangle(170, footerY, 210, footerY, 210, 297, 'F');
                pdf.triangle(170, footerY, 210, 297, 170, footerY, 'F');
                
                // Footer text
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('THANK YOU FOR YOUR BUSINESS', 15, footerY + 25);
                
                // Handle different send methods (same logic as before)
                if (sendMethod === 'whatsapp') {
                    const pdfBlob = pdf.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    // Create shareable URL for WhatsApp
                    const receiptData = {
                        receiptNumber: receiptNumber,
                        clientName: selectedAppointment.name,
                        clientPhone: phoneNumber || 'N/A',
                        services: receiptServices,
                        totalAmount: totalAmount,
                        date: new Date().toISOString(),
                        address: selectedAppointment.address || '',
                        city: selectedAppointment.city || '',
                        appointmentDate: selectedAppointment.date || new Date().toISOString().split('T')[0],
                        appointmentTime: selectedAppointment.time || ''
                    };
                    
                    // Store the latest receipt data for the simple link approach
                    localStorage.setItem('latestReceipt', JSON.stringify(receiptData));
                    localStorage.setItem('latestReceiptTimestamp', Date.now().toString());
                    
                    // Use simple Bitly link - no parameters needed!
                    const shareableUrl = `https://bit.ly/RizeCleaning`;
                    console.log('Created simple receipt URL for WhatsApp:', shareableUrl);
                    
                    const firstName = selectedAppointment.name.split(' ')[0];
                    const message = `Hola ${firstName}, su factura por $${totalAmount.toFixed(2)} estÃ¡ lista. Ver/Descargar: ${shareableUrl} - LivinGreen`;
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                    
                    await createAndDownloadVCard(selectedAppointment, phoneNumber);
                    
                    // Open WhatsApp directly
                    try {
                        console.log('Opening WhatsApp with URL:', whatsappUrl);
                        window.open(whatsappUrl, '_blank');
                        alert('WhatsApp abierto! Si no se abriÃ³ automÃ¡ticamente, copia este mensaje:\n\n' + message);
                    } catch (error) {
                        console.error('WhatsApp open error:', error);
                        alert(`WhatsApp no se pudo abrir automÃ¡ticamente. Copie este mensaje:\n\n${message}\n\nY envÃ­elo a: ${phoneNumber}`);
                    }
                    
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    link.download = `Receipt_${receiptNumber}_${selectedAppointment.name.replace(/\s+/g, '_')}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                } else if (sendMethod === 'sms') {
                    const receiptData = generateReceiptText();
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/receipt`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                receiptData: receiptData,
                                receiptNumber: receiptNumber,
                                clientName: selectedAppointment.name
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            const shortUrl = result.shortUrl || result.fullUrl;
                            const firstName = selectedAppointment.name.split(' ')[0];
                            const message = `Hola ${firstName}, su factura por $${totalAmount.toFixed(2)} estÃ¡ lista. Ver/Descargar: ${shortUrl} - LivinGreen`;
                            const smsUrl = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
                            window.open(smsUrl);
                        } else {
                            throw new Error('Failed to save receipt');
                        }
                        
                    } catch (error) {
                        console.error('Error creating receipt link:', error);
                        const pdfBlob = pdf.output('blob');
                        const pdfUrl = URL.createObjectURL(pdfBlob);
                        
                        const link = document.createElement('a');
                        link.href = pdfUrl;
                        link.download = `Receipt_${receiptNumber}_${selectedAppointment.name.replace(/\s+/g, '_')}.pdf`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        const firstName = selectedAppointment.name.split(' ')[0];
                        const message = `Hola ${firstName}, su factura por $${totalAmount.toFixed(2)} estÃ¡ lista. PDF descargado - adjunte a este mensaje. - LivinGreen`;
                        const smsUrl = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
                        window.open(smsUrl);
                    }
                    
                } else {
                    // Generate shareable URL and download PDF
                    const receiptData = {
                        receiptNumber: receiptNumber,
                        clientName: selectedAppointment.name,
                        clientPhone: phoneNumber || 'N/A',
                        services: receiptServices,
                        totalAmount: totalAmount,
                        date: new Date().toISOString(),
                        address: selectedAppointment.address || '',
                        city: selectedAppointment.city || '',
                        appointmentDate: selectedAppointment.date || new Date().toISOString().split('T')[0],
                        appointmentTime: selectedAppointment.time || ''
                    };
                    
                    // Create shareable URL
                    const encodedData = btoa(JSON.stringify(receiptData));
                    const shareableUrl = `https://incandescent-sprinkles-d1c3df.netlify.app#receipt=${encodedData}`;
                    
                    // Show URL to user and download PDF
                    const pdfBlob = pdf.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    link.download = `Receipt_${receiptNumber}_${selectedAppointment.name.replace(/\s+/g, '_')}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Show the shareable URL
                    setTimeout(() => {
                        alert(`âœ… PDF descargado!\n\nðŸ”— URL para compartir:\n${shareableUrl}\n\nEsta URL permite ver/descargar el recibo desde cualquier dispositivo.`);
                    }, 500);
                }
                
                closeReceiptModal();
                
            } catch (error) {
                console.error('Error generating receipt:', error);
                alert('Error generating receipt. Please try again.');
            }
        }

        // Schedule and appointment management functions
        function toggleCalendar() {
            if (currentView === 'calendar') {
                // Hide calendar and show schedule
                document.getElementById('calendar-view').style.display = 'none';
                document.getElementById('schedule-view').style.display = 'block';
                currentView = 'schedule';
                document.querySelector('[onclick="toggleCalendar()"]').textContent = 'Ver Calendario';
            } else {
                // Show calendar and hide schedule
                document.getElementById('schedule-view').style.display = 'none';
                document.getElementById('calendar-view').style.display = 'block';
                currentView = 'calendar';
                document.querySelector('[onclick="toggleCalendar()"]').textContent = 'Ver Agenda';
                generateWeeklyCalendar();
            }
        }

        // End of receipt system

        // PWA Install handling
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('ðŸ“± App can be installed');
        });

        window.addEventListener('appinstalled', (e) => {
            console.log('ðŸŽ‰ App was installed successfully');
        });

        // Prevent iOS Safari bounce and make it feel more native
        document.addEventListener('touchstart', {passive: true});
        document.addEventListener('touchmove', function(e) {
            if (e.scale !== 1) {
                e.preventDefault();
            }
        }, {passive: false});

        // Hide hexagonal loading animation after page loads
        window.addEventListener('load', function() {
            setTimeout(function() {
                hideHexLoader();
            }, 2000); // Show for 2 seconds after page loads
        });

        // Copy message to clipboard function
        function copyMessage(messageType) {
            let messageText = '';

            switch(messageType) {
                case 'carpet':
                    messageText = document.getElementById('carpet-message').textContent;
                    break;
                case 'furniture':
                    messageText = document.getElementById('furniture-message').textContent;
                    break;
                case 'general':
                    messageText = document.getElementById('general-message').textContent;
                    break;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(messageText).then(() => {
                // Show notification
                const notification = document.getElementById('copy-notification');
                notification.style.display = 'flex';

                // Hide after 2 seconds
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('Error al copiar el mensaje');
            });
        }

        // Calendar Auto Slider
        function initCalendarSlider() {
            const slidesContainer = document.querySelector('.calendar-slides');
            if (!slidesContainer) return;

            let isSecondSlide = false;

            function getRandomInterval() {
                return Math.floor(Math.random() * (5000 - 3000 + 1)) + 3000; // 3-5 segundos
            }

            function toggleSlide() {
                if (isSecondSlide) {
                    // Volver al primer slide
                    slidesContainer.classList.remove('show-second');
                } else {
                    // Ir al segundo slide
                    slidesContainer.classList.add('show-second');
                }

                isSecondSlide = !isSecondSlide;

                // Schedule next transition with random interval
                setTimeout(toggleSlide, getRandomInterval());
            }

            // Start the slider after a random initial delay
            setTimeout(toggleSlide, getRandomInterval());
        }

        // Initialize calendar slider when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCalendarSlider);
        } else {
            initCalendarSlider();
        }

        // Analytics Auto Slider
        function initAnalyticsSlider() {
            const slidesContainer = document.querySelector('.analytics-slides');
            if (!slidesContainer) return;

            let isSecondSlide = false;

            function getRandomInterval() {
                return Math.floor(Math.random() * (5500 - 3500 + 1)) + 3500; // 3.5-5.5 segundos
            }

            function toggleSlide() {
                if (isSecondSlide) {
                    // Volver al primer slide
                    slidesContainer.classList.remove('show-second');
                } else {
                    // Ir al segundo slide
                    slidesContainer.classList.add('show-second');
                }

                isSecondSlide = !isSecondSlide;

                // Schedule next transition with random interval
                setTimeout(toggleSlide, getRandomInterval());
            }

            // Start the slider after a random initial delay
            setTimeout(toggleSlide, getRandomInterval());
        }

        // Load today's total amount
        async function loadTodayTotal() {
            try {
                const appointments = await getAppointmentsFromSupabase();

                // Get today's date in LOCAL timezone (YYYY-MM-DD format)
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;

                console.log('ðŸ“… Today date (local):', todayStr);

                // Filter appointments for today and calculate total
                const todayAppointments = appointments.filter(apt => {
                    if (!apt.date) return false;

                    // Extract YYYY-MM-DD from appointment date
                    let aptDate;
                    if (apt.date.includes('T')) {
                        aptDate = apt.date.split('T')[0];
                    } else {
                        aptDate = apt.date.split(' ')[0];
                    }

                    const isToday = aptDate === todayStr;
                    if (isToday) {
                        console.log('ðŸ“Œ Today appointment found:', apt.name, apt.price, apt.date);
                    }
                    return isToday;
                });

                const todayTotal = todayAppointments.reduce((sum, apt) => {
                    return sum + (parseFloat(apt.price) || 0);
                }, 0);

                // Update the amount display
                const todayAmountEl = document.getElementById('today-total-amount');
                if (todayAmountEl) {
                    todayAmountEl.textContent = `$${Math.round(todayTotal)}`;
                }

                // Update the progress ring (0-500 range)
                const progressRing = document.getElementById('today-progress-ring');
                if (progressRing) {
                    const maxAmount = 500;
                    const progress = Math.min(todayTotal / maxAmount, 1); // Cap at 100%
                    const circumference = 377;
                    const offset = circumference * (1 - progress);

                    progressRing.style.strokeDashoffset = offset;

                    console.log('ðŸ”µ Progress ring updated:', {
                        todayTotal,
                        progress: `${(progress * 100).toFixed(1)}%`,
                        offset: offset.toFixed(1)
                    });
                }

                // Update the appointments list
                const appointmentsList = document.getElementById('today-appointments-list');
                if (appointmentsList) {
                    if (todayAppointments.length === 0) {
                        appointmentsList.innerHTML = '<div class="appointment-item" style="color: rgba(200, 200, 200, 0.6);">No hay citas para hoy</div>';
                    } else {
                        // Show up to 3 appointments
                        const displayAppointments = todayAppointments.slice(0, 3);
                        appointmentsList.innerHTML = displayAppointments.map((apt, index) => {
                            const name = apt.name || 'Cliente';
                            const city = apt.city || 'Sin ciudad';
                            return `<div class="appointment-item">${index + 1}. ${name} - ${city}</div>`;
                        }).join('');

                        // If there are more than 3, show a count
                        if (todayAppointments.length > 3) {
                            const remaining = todayAppointments.length - 3;
                            appointmentsList.innerHTML += `<div class="appointment-item" style="color: rgba(200, 200, 200, 0.6); font-style: italic;">+${remaining} mÃ¡s...</div>`;
                        }
                    }
                }

                // Calculate and display tomorrow's cities
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowYear = tomorrow.getFullYear();
                const tomorrowMonth = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const tomorrowDay = String(tomorrow.getDate()).padStart(2, '0');
                const tomorrowStr = `${tomorrowYear}-${tomorrowMonth}-${tomorrowDay}`;

                const tomorrowAppointments = appointments.filter(apt => {
                    if (!apt.date) return false;
                    let aptDate;
                    if (apt.date.includes('T')) {
                        aptDate = apt.date.split('T')[0];
                    } else {
                        aptDate = apt.date.split(' ')[0];
                    }
                    return aptDate === tomorrowStr;
                });

                // Get unique cities for tomorrow
                const tomorrowCities = new Set();
                tomorrowAppointments.forEach(apt => {
                    if (apt.city) {
                        tomorrowCities.add(apt.city);
                    }
                });

                const tomorrowCitiesEl = document.getElementById('tomorrow-cities');
                if (tomorrowCitiesEl) {
                    if (tomorrowCities.size === 0) {
                        tomorrowCitiesEl.textContent = 'No hay citas programadas';
                        tomorrowCitiesEl.style.color = 'rgba(200, 200, 200, 0.6)';
                    } else {
                        const citiesArray = Array.from(tomorrowCities);
                        tomorrowCitiesEl.textContent = citiesArray.join(' y ');
                        tomorrowCitiesEl.style.color = 'rgba(180, 220, 255, 0.95)';
                    }
                }

                console.log('âœ… Today total loaded:', {
                    todayStr,
                    todayTotal,
                    appointmentsCount: todayAppointments.length,
                    totalAppointments: appointments.length,
                    tomorrowStr,
                    tomorrowCities: Array.from(tomorrowCities)
                });

            } catch (error) {
                console.error('âŒ Error loading today total:', error);
                // Keep default $0 on error
            }
        }

        // Load real analytics data for bento card
        async function loadBentoAnalytics() {
            try {
                const appointments = await getAppointmentsFromSupabase();

                // Calculate UNIQUE clients (by name)
                const uniqueClientNames = new Set();
                const clientFirstAppointment = {}; // Track first appointment date for each client

                appointments.forEach(apt => {
                    if (apt.name) {
                        const clientName = apt.name.toLowerCase().trim();
                        uniqueClientNames.add(clientName);

                        // Track first appointment date for this client
                        const aptDate = new Date(apt.date);
                        if (!clientFirstAppointment[clientName] || aptDate < clientFirstAppointment[clientName]) {
                            clientFirstAppointment[clientName] = aptDate;
                        }
                    }
                });

                const totalUniqueClients = uniqueClientNames.size;

                // Get current month's appointments
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const appointmentsThisMonth = appointments.filter(apt => {
                    const aptDate = new Date(apt.date);
                    return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
                }).length;

                // Calculate NEW clients this month (clients whose first appointment is this month)
                let newClientsThisMonth = 0;
                for (const [clientName, firstDate] of Object.entries(clientFirstAppointment)) {
                    if (firstDate.getMonth() === currentMonth && firstDate.getFullYear() === currentYear) {
                        newClientsThisMonth++;
                    }
                }

                // Calculate unique cities
                const uniqueCities = new Set();
                appointments.forEach(apt => {
                    if (apt.city) uniqueCities.add(apt.city);
                });
                const activeCities = uniqueCities.size;

                // Calculate unique services/jobs
                const uniqueJobs = new Set();
                appointments.forEach(apt => {
                    if (apt.job) {
                        // Jobs are stored as comma-separated string
                        const jobs = apt.job.split(',').map(j => j.trim());
                        jobs.forEach(job => {
                            if (job) uniqueJobs.add(job);
                        });
                    }
                });
                const totalServices = uniqueJobs.size;

                // Update datos/analytics card
                const totalClientsEl = document.getElementById('bento-total-clients');
                const monthlyApptsEl = document.getElementById('bento-monthly-appts');
                const activeCitiesEl = document.getElementById('bento-active-cities');
                const totalServicesEl = document.getElementById('bento-total-services');

                if (totalClientsEl) totalClientsEl.textContent = totalUniqueClients;
                if (monthlyApptsEl) monthlyApptsEl.textContent = appointmentsThisMonth;
                if (activeCitiesEl) activeCitiesEl.textContent = activeCities;
                if (totalServicesEl) totalServicesEl.textContent = totalServices;

                // Update registry card
                const registryTotalEl = document.getElementById('registry-total-clients');
                const registryNewEl = document.getElementById('registry-new-clients');

                if (registryTotalEl) registryTotalEl.textContent = totalUniqueClients;
                if (registryNewEl) registryNewEl.textContent = newClientsThisMonth;

                console.log('âœ… Bento analytics loaded:', {
                    totalUniqueClients,
                    newClientsThisMonth,
                    appointmentsThisMonth,
                    activeCities,
                    totalServices
                });

            } catch (error) {
                console.error('âŒ Error loading bento analytics:', error);
                // Keep default values on error
            }
        }

        // Registry Auto Slider
        function initRegistrySlider() {
            const slidesContainer = document.querySelector('.registry-slides');
            if (!slidesContainer) return;

            let isSecondSlide = false;

            function getRandomInterval() {
                return Math.floor(Math.random() * (5500 - 3500 + 1)) + 3500; // 3.5-5.5 segundos
            }

            function toggleSlide() {
                if (isSecondSlide) {
                    slidesContainer.classList.remove('show-second');
                } else {
                    slidesContainer.classList.add('show-second');
                }

                isSecondSlide = !isSecondSlide;
                setTimeout(toggleSlide, getRandomInterval());
            }

            setTimeout(toggleSlide, getRandomInterval());
        }

        // Initialize sliders and load data when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initAnalyticsSlider();
                initRegistrySlider();
                loadBentoAnalytics();
                loadTodayTotal();
            });
        } else {
            initAnalyticsSlider();
            initRegistrySlider();
            loadBentoAnalytics();
            loadTodayTotal();
        }

    </script>
</body>
</html>
